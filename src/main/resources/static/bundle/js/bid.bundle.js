var nc=Object.defineProperty;var ac=(r,s,e)=>s in r?nc(r,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[s]=e;var f=(r,s,e)=>(ac(r,typeof s!="symbol"?s+"":s,e),e),Kn=(r,s,e)=>{if(!s.has(r))throw TypeError("Cannot "+e)};var $=(r,s,e)=>(Kn(r,s,"read from private field"),e?e.call(r):s.get(r)),he=(r,s,e)=>{if(s.has(r))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(r):s.set(r,e)},ee=(r,s,e,t)=>(Kn(r,s,"write to private field"),t?t.call(r,e):s.set(r,e),e);import{j as mr,r as Ge,a as oc,c as cc}from"../chunk/client.chunk.js";var Ct=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};const Xe=Object.create(null);Xe.open="0";Xe.close="1";Xe.ping="2";Xe.pong="3";Xe.message="4";Xe.upgrade="5";Xe.noop="6";const ws=Object.create(null);Object.keys(Xe).forEach(r=>{ws[Xe[r]]=r});const xi={type:"error",data:"parser error"},eo=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",to=typeof ArrayBuffer=="function",ro=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,Ui=({type:r,data:s},e,t)=>eo&&s instanceof Blob?e?t(s):Gn(s,t):to&&(s instanceof ArrayBuffer||ro(s))?e?t(s):Gn(new Blob([s]),t):t(Xe[r]+(s||"")),Gn=(r,s)=>{const e=new FileReader;return e.onload=function(){const t=e.result.split(",")[1];s("b"+(t||""))},e.readAsDataURL(r)};function Qn(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}let ui;function dc(r,s){if(eo&&r.data instanceof Blob)return r.data.arrayBuffer().then(Qn).then(s);if(to&&(r.data instanceof ArrayBuffer||ro(r.data)))return s(Qn(r.data));Ui(r,!1,e=>{ui||(ui=new TextEncoder),s(ui.encode(e))})}const Wn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$r=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let r=0;r<Wn.length;r++)$r[Wn.charCodeAt(r)]=r;const pc=r=>{let s=r.length*.75,e=r.length,t,i=0,n,a,o,d;r[r.length-1]==="="&&(s--,r[r.length-2]==="="&&s--);const p=new ArrayBuffer(s),l=new Uint8Array(p);for(t=0;t<e;t+=4)n=$r[r.charCodeAt(t)],a=$r[r.charCodeAt(t+1)],o=$r[r.charCodeAt(t+2)],d=$r[r.charCodeAt(t+3)],l[i++]=n<<2|a>>4,l[i++]=(a&15)<<4|o>>2,l[i++]=(o&3)<<6|d&63;return p},lc=typeof ArrayBuffer=="function",zi=(r,s)=>{if(typeof r!="string")return{type:"message",data:so(r,s)};const e=r.charAt(0);return e==="b"?{type:"message",data:hc(r.substring(1),s)}:ws[e]?r.length>1?{type:ws[e],data:r.substring(1)}:{type:ws[e]}:xi},hc=(r,s)=>{if(lc){const e=pc(r);return so(e,s)}else return{base64:!0,data:r}},so=(r,s)=>{switch(s){case"blob":return r instanceof Blob?r:new Blob([r]);case"arraybuffer":default:return r instanceof ArrayBuffer?r:r.buffer}},io=String.fromCharCode(30),uc=(r,s)=>{const e=r.length,t=new Array(e);let i=0;r.forEach((n,a)=>{Ui(n,!1,o=>{t[a]=o,++i===e&&s(t.join(io))})})},fc=(r,s)=>{const e=r.split(io),t=[];for(let i=0;i<e.length;i++){const n=zi(e[i],s);if(t.push(n),n.type==="error")break}return t};function mc(){return new TransformStream({transform(r,s){dc(r,e=>{const t=e.length;let i;if(t<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,t);else if(t<65536){i=new Uint8Array(3);const n=new DataView(i.buffer);n.setUint8(0,126),n.setUint16(1,t)}else{i=new Uint8Array(9);const n=new DataView(i.buffer);n.setUint8(0,127),n.setBigUint64(1,BigInt(t))}r.data&&typeof r.data!="string"&&(i[0]|=128),s.enqueue(i),s.enqueue(e)})}})}let fi;function ts(r){return r.reduce((s,e)=>s+e.length,0)}function rs(r,s){if(r[0].length===s)return r.shift();const e=new Uint8Array(s);let t=0;for(let i=0;i<s;i++)e[i]=r[0][t++],t===r[0].length&&(r.shift(),t=0);return r.length&&t<r[0].length&&(r[0]=r[0].slice(t)),e}function gc(r,s){fi||(fi=new TextDecoder);const e=[];let t=0,i=-1,n=!1;return new TransformStream({transform(a,o){for(e.push(a);;){if(t===0){if(ts(e)<1)break;const d=rs(e,1);n=(d[0]&128)===128,i=d[0]&127,i<126?t=3:i===126?t=1:t=2}else if(t===1){if(ts(e)<2)break;const d=rs(e,2);i=new DataView(d.buffer,d.byteOffset,d.length).getUint16(0),t=3}else if(t===2){if(ts(e)<8)break;const d=rs(e,8),p=new DataView(d.buffer,d.byteOffset,d.length),l=p.getUint32(0);if(l>Math.pow(2,53-32)-1){o.enqueue(xi);break}i=l*Math.pow(2,32)+p.getUint32(4),t=3}else{if(ts(e)<i)break;const d=rs(e,i);o.enqueue(zi(n?d:fi.decode(d),s)),t=0}if(i===0||i>r){o.enqueue(xi);break}}}})}const no=4;function de(r){if(r)return _c(r)}function _c(r){for(var s in de.prototype)r[s]=de.prototype[s];return r}de.prototype.on=de.prototype.addEventListener=function(r,s){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(s),this};de.prototype.once=function(r,s){function e(){this.off(r,e),s.apply(this,arguments)}return e.fn=s,this.on(r,e),this};de.prototype.off=de.prototype.removeListener=de.prototype.removeAllListeners=de.prototype.removeEventListener=function(r,s){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+r];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var t,i=0;i<e.length;i++)if(t=e[i],t===s||t.fn===s){e.splice(i,1);break}return e.length===0&&delete this._callbacks["$"+r],this};de.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var s=new Array(arguments.length-1),e=this._callbacks["$"+r],t=1;t<arguments.length;t++)s[t-1]=arguments[t];if(e){e=e.slice(0);for(var t=0,i=e.length;t<i;++t)e[t].apply(this,s)}return this};de.prototype.emitReserved=de.prototype.emit;de.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};de.prototype.hasListeners=function(r){return!!this.listeners(r).length};const Rs=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?s=>Promise.resolve().then(s):(s,e)=>e(s,0))(),Ee=(()=>typeof self<"u"?self:typeof window<"u"?window:Function("return this")())(),wc="arraybuffer";function ao(r,...s){return s.reduce((e,t)=>(r.hasOwnProperty(t)&&(e[t]=r[t]),e),{})}const vc=Ee.setTimeout,yc=Ee.clearTimeout;function Cs(r,s){s.useNativeTimers?(r.setTimeoutFn=vc.bind(Ee),r.clearTimeoutFn=yc.bind(Ee)):(r.setTimeoutFn=Ee.setTimeout.bind(Ee),r.clearTimeoutFn=Ee.clearTimeout.bind(Ee))}const bc=1.33;function Sc(r){return typeof r=="string"?Rc(r):Math.ceil((r.byteLength||r.size)*bc)}function Rc(r){let s=0,e=0;for(let t=0,i=r.length;t<i;t++)s=r.charCodeAt(t),s<128?e+=1:s<2048?e+=2:s<55296||s>=57344?e+=3:(t++,e+=4);return e}function oo(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Cc(r){let s="";for(let e in r)r.hasOwnProperty(e)&&(s.length&&(s+="&"),s+=encodeURIComponent(e)+"="+encodeURIComponent(r[e]));return s}function Tc(r){let s={},e=r.split("&");for(let t=0,i=e.length;t<i;t++){let n=e[t].split("=");s[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return s}class Dc extends Error{constructor(s,e,t){super(s),this.description=e,this.context=t,this.type="TransportError"}}let Hi=class extends de{constructor(s){super(),this.writable=!1,Cs(this,s),this.opts=s,this.query=s.query,this.socket=s.socket,this.supportsBinary=!s.forceBase64}onError(s,e,t){return super.emitReserved("error",new Dc(s,e,t)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(s){this.readyState==="open"&&this.write(s)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(s){const e=zi(s,this.socket.binaryType);this.onPacket(e)}onPacket(s){super.emitReserved("packet",s)}onClose(s){this.readyState="closed",super.emitReserved("close",s)}pause(s){}createUri(s,e={}){return s+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const s=this.opts.hostname;return s.indexOf(":")===-1?s:"["+s+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(s){const e=Cc(s);return e.length?"?"+e:""}};class kc extends Hi{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(s){this.readyState="pausing";const e=()=>{this.readyState="paused",s()};if(this._polling||!this.writable){let t=0;this._polling&&(t++,this.once("pollComplete",function(){--t||e()})),this.writable||(t++,this.once("drain",function(){--t||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(s){const e=t=>{if(this.readyState==="opening"&&t.type==="open"&&this.onOpen(),t.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)};fc(s,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const s=()=>{this.write([{type:"close"}])};this.readyState==="open"?s():this.once("open",s)}write(s){this.writable=!1,uc(s,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const s=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=oo()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(s,e)}}let co=!1;try{co=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Ec=co;function Pc(){}class xc extends kc{constructor(s){if(super(s),typeof location<"u"){const e=location.protocol==="https:";let t=location.port;t||(t=e?"443":"80"),this.xd=typeof location<"u"&&s.hostname!==location.hostname||t!==s.port}}doWrite(s,e){const t=this.request({method:"POST",data:s});t.on("success",e),t.on("error",(i,n)=>{this.onError("xhr post error",i,n)})}doPoll(){const s=this.request();s.on("data",this.onData.bind(this)),s.on("error",(e,t)=>{this.onError("xhr poll error",e,t)}),this.pollXhr=s}}class Ye extends de{constructor(s,e,t){super(),this.createRequest=s,Cs(this,t),this._opts=t,this._method=t.method||"GET",this._uri=e,this._data=t.data!==void 0?t.data:null,this._create()}_create(){var s;const e=ao(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const t=this._xhr=this.createRequest(e);try{t.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&t.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{t.setRequestHeader("Accept","*/*")}catch{}(s=this._opts.cookieJar)===null||s===void 0||s.addCookies(t),"withCredentials"in t&&(t.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(t.timeout=this._opts.requestTimeout),t.onreadystatechange=()=>{var i;t.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(t.getResponseHeader("set-cookie"))),t.readyState===4&&(t.status===200||t.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof t.status=="number"?t.status:0)},0))},t.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=Ye.requestsCount++,Ye.requests[this._index]=this)}_onError(s){this.emitReserved("error",s,this._xhr),this._cleanup(!0)}_cleanup(s){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Pc,s)try{this._xhr.abort()}catch{}typeof document<"u"&&delete Ye.requests[this._index],this._xhr=null}}_onLoad(){const s=this._xhr.responseText;s!==null&&(this.emitReserved("data",s),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}Ye.requestsCount=0;Ye.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Yn);else if(typeof addEventListener=="function"){const r="onpagehide"in Ee?"pagehide":"unload";addEventListener(r,Yn,!1)}}function Yn(){for(let r in Ye.requests)Ye.requests.hasOwnProperty(r)&&Ye.requests[r].abort()}const Lc=function(){const r=po({xdomain:!1});return r&&r.responseType!==null}();class Ic extends xc{constructor(s){super(s);const e=s&&s.forceBase64;this.supportsBinary=Lc&&!e}request(s={}){return Object.assign(s,{xd:this.xd},this.opts),new Ye(po,this.uri(),s)}}function po(r){const s=r.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!s||Ec))return new XMLHttpRequest}catch{}if(!s)try{return new Ee[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const lo=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Mc extends Hi{get name(){return"websocket"}doOpen(){const s=this.uri(),e=this.opts.protocols,t=lo?{}:ao(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(t.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(s,e,t)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=s=>this.onClose({description:"websocket connection closed",context:s}),this.ws.onmessage=s=>this.onData(s.data),this.ws.onerror=s=>this.onError("websocket error",s)}write(s){this.writable=!1;for(let e=0;e<s.length;e++){const t=s[e],i=e===s.length-1;Ui(t,this.supportsBinary,n=>{try{this.doWrite(t,n)}catch{}i&&Rs(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const s=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=oo()),this.supportsBinary||(e.b64=1),this.createUri(s,e)}}const mi=Ee.WebSocket||Ee.MozWebSocket;class Oc extends Mc{createSocket(s,e,t){return lo?new mi(s,e,t):e?new mi(s,e):new mi(s)}doWrite(s,e){this.ws.send(e)}}class Ac extends Hi{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(s){return this.emitReserved("error",s)}this._transport.closed.then(()=>{this.onClose()}).catch(s=>{this.onError("webtransport error",s)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(s=>{const e=gc(Number.MAX_SAFE_INTEGER,this.socket.binaryType),t=s.readable.pipeThrough(e).getReader(),i=mc();i.readable.pipeTo(s.writable),this._writer=i.writable.getWriter();const n=()=>{t.read().then(({done:o,value:d})=>{o||(this.onPacket(d),n())}).catch(o=>{})};n();const a={type:"open"};this.query.sid&&(a.data=`{"sid":"${this.query.sid}"}`),this._writer.write(a).then(()=>this.onOpen())})})}write(s){this.writable=!1;for(let e=0;e<s.length;e++){const t=s[e],i=e===s.length-1;this._writer.write(t).then(()=>{i&&Rs(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var s;(s=this._transport)===null||s===void 0||s.close()}}const Nc={websocket:Oc,webtransport:Ac,polling:Ic},jc=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,$c=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Li(r){if(r.length>8e3)throw"URI too long";const s=r,e=r.indexOf("["),t=r.indexOf("]");e!=-1&&t!=-1&&(r=r.substring(0,e)+r.substring(e,t).replace(/:/g,";")+r.substring(t,r.length));let i=jc.exec(r||""),n={},a=14;for(;a--;)n[$c[a]]=i[a]||"";return e!=-1&&t!=-1&&(n.source=s,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=Fc(n,n.path),n.queryKey=Bc(n,n.query),n}function Fc(r,s){const e=/\/{2,9}/g,t=s.replace(e,"/").split("/");return(s.slice(0,1)=="/"||s.length===0)&&t.splice(0,1),s.slice(-1)=="/"&&t.splice(t.length-1,1),t}function Bc(r,s){const e={};return s.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(t,i,n){i&&(e[i]=n)}),e}const Ii=typeof addEventListener=="function"&&typeof removeEventListener=="function",vs=[];Ii&&addEventListener("offline",()=>{vs.forEach(r=>r())},!1);class wt extends de{constructor(s,e){if(super(),this.binaryType=wc,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,s&&typeof s=="object"&&(e=s,s=null),s){const t=Li(s);e.hostname=t.host,e.secure=t.protocol==="https"||t.protocol==="wss",e.port=t.port,t.query&&(e.query=t.query)}else e.host&&(e.hostname=Li(e.host).host);Cs(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach(t=>{const i=t.prototype.name;this.transports.push(i),this._transportsByName[i]=t}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Tc(this.opts.query)),Ii&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},vs.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(s){const e=Object.assign({},this.opts.query);e.EIO=no,e.transport=s,this.id&&(e.sid=this.id);const t=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[s]);return new this._transportsByName[s](t)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const s=this.opts.rememberUpgrade&&wt.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(s);e.open(),this.setTransport(e)}setTransport(s){this.transport&&this.transport.removeAllListeners(),this.transport=s,s.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",wt.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(s){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",s),this.emitReserved("heartbeat"),s.type){case"open":this.onHandshake(JSON.parse(s.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=s.data,this._onError(e);break;case"message":this.emitReserved("data",s.data),this.emitReserved("message",s.data);break}}onHandshake(s){this.emitReserved("handshake",s),this.id=s.sid,this.transport.query.sid=s.sid,this._pingInterval=s.pingInterval,this._pingTimeout=s.pingTimeout,this._maxPayload=s.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const s=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+s,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},s),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const s=this._getWritablePackets();this.transport.send(s),this._prevBufferLen=s.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let t=0;t<this.writeBuffer.length;t++){const i=this.writeBuffer[t].data;if(i&&(e+=Sc(i)),t>0&&e>this._maxPayload)return this.writeBuffer.slice(0,t);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const s=Date.now()>this._pingTimeoutTime;return s&&(this._pingTimeoutTime=0,Rs(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),s}write(s,e,t){return this._sendPacket("message",s,e,t),this}send(s,e,t){return this._sendPacket("message",s,e,t),this}_sendPacket(s,e,t,i){if(typeof e=="function"&&(i=e,e=void 0),typeof t=="function"&&(i=t,t=null),this.readyState==="closing"||this.readyState==="closed")return;t=t||{},t.compress=t.compress!==!1;const n={type:s,data:e,options:t};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const s=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),s()},t=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?t():s()}):this.upgrading?t():s()),this}_onError(s){if(wt.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",s),this._onClose("transport error",s)}_onClose(s,e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Ii&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const t=vs.indexOf(this._offlineEventListener);t!==-1&&vs.splice(t,1)}this.readyState="closed",this.id=null,this.emitReserved("close",s,e),this.writeBuffer=[],this._prevBufferLen=0}}}wt.protocol=no;class Uc extends wt{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let s=0;s<this._upgrades.length;s++)this._probe(this._upgrades[s])}_probe(s){let e=this.createTransport(s),t=!1;wt.priorWebsocketSuccess=!1;const i=()=>{t||(e.send([{type:"ping",data:"probe"}]),e.once("packet",c=>{if(!t)if(c.type==="pong"&&c.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;wt.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{t||this.readyState!=="closed"&&(l(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=e.name,this.emitReserved("upgradeError",h)}}))};function n(){t||(t=!0,l(),e.close(),e=null)}const a=c=>{const h=new Error("probe error: "+c);h.transport=e.name,n(),this.emitReserved("upgradeError",h)};function o(){a("transport closed")}function d(){a("socket closed")}function p(c){e&&c.name!==e.name&&n()}const l=()=>{e.removeListener("open",i),e.removeListener("error",a),e.removeListener("close",o),this.off("close",d),this.off("upgrading",p)};e.once("open",i),e.once("error",a),e.once("close",o),this.once("close",d),this.once("upgrading",p),this._upgrades.indexOf("webtransport")!==-1&&s!=="webtransport"?this.setTimeoutFn(()=>{t||e.open()},200):e.open()}onHandshake(s){this._upgrades=this._filterUpgrades(s.upgrades),super.onHandshake(s)}_filterUpgrades(s){const e=[];for(let t=0;t<s.length;t++)~this.transports.indexOf(s[t])&&e.push(s[t]);return e}}let zc=class extends Uc{constructor(s,e={}){const t=typeof s=="object"?s:e;(!t.transports||t.transports&&typeof t.transports[0]=="string")&&(t.transports=(t.transports||["polling","websocket","webtransport"]).map(i=>Nc[i]).filter(i=>!!i)),super(s,t)}};function Hc(r,s="",e){let t=r;e=e||typeof location<"u"&&location,r==null&&(r=e.protocol+"//"+e.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=e.protocol+r:r=e.host+r),/^(https?|wss?):\/\//.test(r)||(typeof e<"u"?r=e.protocol+"//"+r:r="https://"+r),t=Li(r)),t.port||(/^(http|ws)$/.test(t.protocol)?t.port="80":/^(http|ws)s$/.test(t.protocol)&&(t.port="443")),t.path=t.path||"/";const n=t.host.indexOf(":")!==-1?"["+t.host+"]":t.host;return t.id=t.protocol+"://"+n+":"+t.port+s,t.href=t.protocol+"://"+n+(e&&e.port===t.port?"":":"+t.port),t}const qc=typeof ArrayBuffer=="function",Vc=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,ho=Object.prototype.toString,Kc=typeof Blob=="function"||typeof Blob<"u"&&ho.call(Blob)==="[object BlobConstructor]",Gc=typeof File=="function"||typeof File<"u"&&ho.call(File)==="[object FileConstructor]";function qi(r){return qc&&(r instanceof ArrayBuffer||Vc(r))||Kc&&r instanceof Blob||Gc&&r instanceof File}function ys(r,s){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let e=0,t=r.length;e<t;e++)if(ys(r[e]))return!0;return!1}if(qi(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return ys(r.toJSON(),!0);for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e)&&ys(r[e]))return!0;return!1}function Qc(r){const s=[],e=r.data,t=r;return t.data=Mi(e,s),t.attachments=s.length,{packet:t,buffers:s}}function Mi(r,s){if(!r)return r;if(qi(r)){const e={_placeholder:!0,num:s.length};return s.push(r),e}else if(Array.isArray(r)){const e=new Array(r.length);for(let t=0;t<r.length;t++)e[t]=Mi(r[t],s);return e}else if(typeof r=="object"&&!(r instanceof Date)){const e={};for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=Mi(r[t],s));return e}return r}function Wc(r,s){return r.data=Oi(r.data,s),delete r.attachments,r}function Oi(r,s){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<s.length)return s[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let e=0;e<r.length;e++)r[e]=Oi(r[e],s);else if(typeof r=="object")for(const e in r)Object.prototype.hasOwnProperty.call(r,e)&&(r[e]=Oi(r[e],s));return r}const Yc=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Xc=5;var H;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(H||(H={}));class Jc{constructor(s){this.replacer=s}encode(s){return(s.type===H.EVENT||s.type===H.ACK)&&ys(s)?this.encodeAsBinary({type:s.type===H.EVENT?H.BINARY_EVENT:H.BINARY_ACK,nsp:s.nsp,data:s.data,id:s.id}):[this.encodeAsString(s)]}encodeAsString(s){let e=""+s.type;return(s.type===H.BINARY_EVENT||s.type===H.BINARY_ACK)&&(e+=s.attachments+"-"),s.nsp&&s.nsp!=="/"&&(e+=s.nsp+","),s.id!=null&&(e+=s.id),s.data!=null&&(e+=JSON.stringify(s.data,this.replacer)),e}encodeAsBinary(s){const e=Qc(s),t=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(t),i}}function Xn(r){return Object.prototype.toString.call(r)==="[object Object]"}class Vi extends de{constructor(s){super(),this.reviver=s}add(s){let e;if(typeof s=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(s);const t=e.type===H.BINARY_EVENT;t||e.type===H.BINARY_ACK?(e.type=t?H.EVENT:H.ACK,this.reconstructor=new Zc(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(qi(s)||s.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(s),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+s)}decodeString(s){let e=0;const t={type:Number(s.charAt(0))};if(H[t.type]===void 0)throw new Error("unknown packet type "+t.type);if(t.type===H.BINARY_EVENT||t.type===H.BINARY_ACK){const n=e+1;for(;s.charAt(++e)!=="-"&&e!=s.length;);const a=s.substring(n,e);if(a!=Number(a)||s.charAt(e)!=="-")throw new Error("Illegal attachments");t.attachments=Number(a)}if(s.charAt(e+1)==="/"){const n=e+1;for(;++e&&!(s.charAt(e)===","||e===s.length););t.nsp=s.substring(n,e)}else t.nsp="/";const i=s.charAt(e+1);if(i!==""&&Number(i)==i){const n=e+1;for(;++e;){const a=s.charAt(e);if(a==null||Number(a)!=a){--e;break}if(e===s.length)break}t.id=Number(s.substring(n,e+1))}if(s.charAt(++e)){const n=this.tryParse(s.substr(e));if(Vi.isPayloadValid(t.type,n))t.data=n;else throw new Error("invalid payload")}return t}tryParse(s){try{return JSON.parse(s,this.reviver)}catch{return!1}}static isPayloadValid(s,e){switch(s){case H.CONNECT:return Xn(e);case H.DISCONNECT:return e===void 0;case H.CONNECT_ERROR:return typeof e=="string"||Xn(e);case H.EVENT:case H.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&Yc.indexOf(e[0])===-1);case H.ACK:case H.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Zc{constructor(s){this.packet=s,this.buffers=[],this.reconPack=s}takeBinaryData(s){if(this.buffers.push(s),this.buffers.length===this.reconPack.attachments){const e=Wc(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const ed=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Vi,Encoder:Jc,get PacketType(){return H},protocol:Xc},Symbol.toStringTag,{value:"Module"}));function Me(r,s,e){return r.on(s,e),function(){r.off(s,e)}}const td=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class uo extends de{constructor(s,e,t){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=s,this.nsp=e,t&&t.auth&&(this.auth=t.auth),this._opts=Object.assign({},t),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const s=this.io;this.subs=[Me(s,"open",this.onopen.bind(this)),Me(s,"packet",this.onpacket.bind(this)),Me(s,"error",this.onerror.bind(this)),Me(s,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...s){return s.unshift("message"),this.emit.apply(this,s),this}emit(s,...e){var t,i,n;if(td.hasOwnProperty(s))throw new Error('"'+s.toString()+'" is a reserved event name');if(e.unshift(s),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const a={type:H.EVENT,data:e};if(a.options={},a.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const l=this.ids++,c=e.pop();this._registerAckCallback(l,c),a.id=l}const o=(i=(t=this.io.engine)===null||t===void 0?void 0:t.transport)===null||i===void 0?void 0:i.writable,d=this.connected&&!(!((n=this.io.engine)===null||n===void 0)&&n._hasPingExpired());return this.flags.volatile&&!o||(d?(this.notifyOutgoingListeners(a),this.packet(a)):this.sendBuffer.push(a)),this.flags={},this}_registerAckCallback(s,e){var t;const i=(t=this.flags.timeout)!==null&&t!==void 0?t:this._opts.ackTimeout;if(i===void 0){this.acks[s]=e;return}const n=this.io.setTimeoutFn(()=>{delete this.acks[s];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===s&&this.sendBuffer.splice(o,1);e.call(this,new Error("operation has timed out"))},i),a=(...o)=>{this.io.clearTimeoutFn(n),e.apply(this,o)};a.withError=!0,this.acks[s]=a}emitWithAck(s,...e){return new Promise((t,i)=>{const n=(a,o)=>a?i(a):t(o);n.withError=!0,e.push(n),this.emit(s,...e)})}_addToQueue(s){let e;typeof s[s.length-1]=="function"&&(e=s.pop());const t={id:this._queueSeq++,tryCount:0,pending:!1,args:s,flags:Object.assign({fromQueue:!0},this.flags)};s.push((i,...n)=>t!==this._queue[0]?void 0:(i!==null?t.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(i)):(this._queue.shift(),e&&e(null,...n)),t.pending=!1,this._drainQueue())),this._queue.push(t),this._drainQueue()}_drainQueue(s=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!s||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(s){s.nsp=this.nsp,this.io._packet(s)}onopen(){typeof this.auth=="function"?this.auth(s=>{this._sendConnectPacket(s)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(s){this.packet({type:H.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},s):s})}onerror(s){this.connected||this.emitReserved("connect_error",s)}onclose(s,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",s,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(s=>{if(!this.sendBuffer.some(t=>String(t.id)===s)){const t=this.acks[s];delete this.acks[s],t.withError&&t.call(this,new Error("socket has been disconnected"))}})}onpacket(s){if(s.nsp===this.nsp)switch(s.type){case H.CONNECT:s.data&&s.data.sid?this.onconnect(s.data.sid,s.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case H.EVENT:case H.BINARY_EVENT:this.onevent(s);break;case H.ACK:case H.BINARY_ACK:this.onack(s);break;case H.DISCONNECT:this.ondisconnect();break;case H.CONNECT_ERROR:this.destroy();const t=new Error(s.data.message);t.data=s.data.data,this.emitReserved("connect_error",t);break}}onevent(s){const e=s.data||[];s.id!=null&&e.push(this.ack(s.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(s){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const t of e)t.apply(this,s)}super.emit.apply(this,s),this._pid&&s.length&&typeof s[s.length-1]=="string"&&(this._lastOffset=s[s.length-1])}ack(s){const e=this;let t=!1;return function(...i){t||(t=!0,e.packet({type:H.ACK,id:s,data:i}))}}onack(s){const e=this.acks[s.id];typeof e=="function"&&(delete this.acks[s.id],e.withError&&s.data.unshift(null),e.apply(this,s.data))}onconnect(s,e){this.id=s,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(s=>this.emitEvent(s)),this.receiveBuffer=[],this.sendBuffer.forEach(s=>{this.notifyOutgoingListeners(s),this.packet(s)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(s=>s()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:H.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(s){return this.flags.compress=s,this}get volatile(){return this.flags.volatile=!0,this}timeout(s){return this.flags.timeout=s,this}onAny(s){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(s),this}prependAny(s){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(s),this}offAny(s){if(!this._anyListeners)return this;if(s){const e=this._anyListeners;for(let t=0;t<e.length;t++)if(s===e[t])return e.splice(t,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(s){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(s),this}prependAnyOutgoing(s){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(s),this}offAnyOutgoing(s){if(!this._anyOutgoingListeners)return this;if(s){const e=this._anyOutgoingListeners;for(let t=0;t<e.length;t++)if(s===e[t])return e.splice(t,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(s){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const t of e)t.apply(this,s.data)}}}function gr(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}gr.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var s=Math.random(),e=Math.floor(s*this.jitter*r);r=Math.floor(s*10)&1?r+e:r-e}return Math.min(r,this.max)|0};gr.prototype.reset=function(){this.attempts=0};gr.prototype.setMin=function(r){this.ms=r};gr.prototype.setMax=function(r){this.max=r};gr.prototype.setJitter=function(r){this.jitter=r};class Ai extends de{constructor(s,e){var t;super(),this.nsps={},this.subs=[],s&&typeof s=="object"&&(e=s,s=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,Cs(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((t=e.randomizationFactor)!==null&&t!==void 0?t:.5),this.backoff=new gr({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=s;const i=e.parser||ed;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(s){return arguments.length?(this._reconnection=!!s,s||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(s){return s===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=s,this)}reconnectionDelay(s){var e;return s===void 0?this._reconnectionDelay:(this._reconnectionDelay=s,(e=this.backoff)===null||e===void 0||e.setMin(s),this)}randomizationFactor(s){var e;return s===void 0?this._randomizationFactor:(this._randomizationFactor=s,(e=this.backoff)===null||e===void 0||e.setJitter(s),this)}reconnectionDelayMax(s){var e;return s===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=s,(e=this.backoff)===null||e===void 0||e.setMax(s),this)}timeout(s){return arguments.length?(this._timeout=s,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(s){if(~this._readyState.indexOf("open"))return this;this.engine=new zc(this.uri,this.opts);const e=this.engine,t=this;this._readyState="opening",this.skipReconnect=!1;const i=Me(e,"open",function(){t.onopen(),s&&s()}),n=o=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",o),s?s(o):this.maybeReconnectOnOpen()},a=Me(e,"error",n);if(this._timeout!==!1){const o=this._timeout,d=this.setTimeoutFn(()=>{i(),n(new Error("timeout")),e.close()},o);this.opts.autoUnref&&d.unref(),this.subs.push(()=>{this.clearTimeoutFn(d)})}return this.subs.push(i),this.subs.push(a),this}connect(s){return this.open(s)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const s=this.engine;this.subs.push(Me(s,"ping",this.onping.bind(this)),Me(s,"data",this.ondata.bind(this)),Me(s,"error",this.onerror.bind(this)),Me(s,"close",this.onclose.bind(this)),Me(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(s){try{this.decoder.add(s)}catch(e){this.onclose("parse error",e)}}ondecoded(s){Rs(()=>{this.emitReserved("packet",s)},this.setTimeoutFn)}onerror(s){this.emitReserved("error",s)}socket(s,e){let t=this.nsps[s];return t?this._autoConnect&&!t.active&&t.connect():(t=new uo(this,s,e),this.nsps[s]=t),t}_destroy(s){const e=Object.keys(this.nsps);for(const t of e)if(this.nsps[t].active)return;this._close()}_packet(s){const e=this.encoder.encode(s);for(let t=0;t<e.length;t++)this.engine.write(e[t],s.options)}cleanup(){this.subs.forEach(s=>s()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(s,e){var t;this.cleanup(),(t=this.engine)===null||t===void 0||t.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",s,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const s=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const t=this.setTimeoutFn(()=>{s.skipReconnect||(this.emitReserved("reconnect_attempt",s.backoff.attempts),!s.skipReconnect&&s.open(i=>{i?(s._reconnecting=!1,s.reconnect(),this.emitReserved("reconnect_error",i)):s.onreconnect()}))},e);this.opts.autoUnref&&t.unref(),this.subs.push(()=>{this.clearTimeoutFn(t)})}}onreconnect(){const s=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",s)}}const Ir={};function bs(r,s){typeof r=="object"&&(s=r,r=void 0),s=s||{};const e=Hc(r,s.path||"/socket.io"),t=e.source,i=e.id,n=e.path,a=Ir[i]&&n in Ir[i].nsps,o=s.forceNew||s["force new connection"]||s.multiplex===!1||a;let d;return o?d=new Ai(t,s):(Ir[i]||(Ir[i]=new Ai(t,s)),d=Ir[i]),e.query&&!s.query&&(s.query=e.queryKey),d.socket(e.path,s)}Object.assign(bs,{Manager:Ai,Socket:uo,io:bs,connect:bs});var fo={},Ni={exports:{}},gi,Jn;function rd(){if(Jn)return gi;Jn=1;var r=1e3,s=r*60,e=s*60,t=e*24,i=t*7,n=t*365.25;gi=function(l,c){c=c||{};var h=typeof l;if(h==="string"&&l.length>0)return a(l);if(h==="number"&&isFinite(l))return c.long?d(l):o(l);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(l))};function a(l){if(l=String(l),!(l.length>100)){var c=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(l);if(c){var h=parseFloat(c[1]),u=(c[2]||"ms").toLowerCase();switch(u){case"years":case"year":case"yrs":case"yr":case"y":return h*n;case"weeks":case"week":case"w":return h*i;case"days":case"day":case"d":return h*t;case"hours":case"hour":case"hrs":case"hr":case"h":return h*e;case"minutes":case"minute":case"mins":case"min":case"m":return h*s;case"seconds":case"second":case"secs":case"sec":case"s":return h*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function o(l){var c=Math.abs(l);return c>=t?Math.round(l/t)+"d":c>=e?Math.round(l/e)+"h":c>=s?Math.round(l/s)+"m":c>=r?Math.round(l/r)+"s":l+"ms"}function d(l){var c=Math.abs(l);return c>=t?p(l,c,t,"day"):c>=e?p(l,c,e,"hour"):c>=s?p(l,c,s,"minute"):c>=r?p(l,c,r,"second"):l+" ms"}function p(l,c,h,u){var m=c>=h*1.5;return Math.round(l/h)+" "+u+(m?"s":"")}return gi}function sd(r){e.debug=e,e.default=e,e.coerce=d,e.disable=a,e.enable=i,e.enabled=o,e.humanize=rd(),e.destroy=p,Object.keys(r).forEach(l=>{e[l]=r[l]}),e.names=[],e.skips=[],e.formatters={};function s(l){let c=0;for(let h=0;h<l.length;h++)c=(c<<5)-c+l.charCodeAt(h),c|=0;return e.colors[Math.abs(c)%e.colors.length]}e.selectColor=s;function e(l){let c,h=null,u,m;function _(...w){if(!_.enabled)return;const S=_,x=Number(new Date),v=x-(c||x);S.diff=v,S.prev=c,S.curr=x,c=x,w[0]=e.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let g=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(R,pe)=>{if(R==="%%")return"%";g++;const Le=e.formatters[pe];if(typeof Le=="function"){const y=w[g];R=Le.call(S,y),w.splice(g,1),g--}return R}),e.formatArgs.call(S,w),(S.log||e.log).apply(S,w)}return _.namespace=l,_.useColors=e.useColors(),_.color=e.selectColor(l),_.extend=t,_.destroy=e.destroy,Object.defineProperty(_,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(u!==e.namespaces&&(u=e.namespaces,m=e.enabled(l)),m),set:w=>{h=w}}),typeof e.init=="function"&&e.init(_),_}function t(l,c){const h=e(this.namespace+(typeof c>"u"?":":c)+l);return h.log=this.log,h}function i(l){e.save(l),e.namespaces=l,e.names=[],e.skips=[];const c=(typeof l=="string"?l:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const h of c)h[0]==="-"?e.skips.push(h.slice(1)):e.names.push(h)}function n(l,c){let h=0,u=0,m=-1,_=0;for(;h<l.length;)if(u<c.length&&(c[u]===l[h]||c[u]==="*"))c[u]==="*"?(m=u,_=h,u++):(h++,u++);else if(m!==-1)u=m+1,_++,h=_;else return!1;for(;u<c.length&&c[u]==="*";)u++;return u===c.length}function a(){const l=[...e.names,...e.skips.map(c=>"-"+c)].join(",");return e.enable(""),l}function o(l){for(const c of e.skips)if(n(l,c))return!1;for(const c of e.names)if(n(l,c))return!0;return!1}function d(l){return l instanceof Error?l.stack||l.message:l}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}var id=sd;(function(r,s){s.formatArgs=t,s.save=i,s.load=n,s.useColors=e,s.storage=a(),s.destroy=(()=>{let d=!1;return()=>{d||(d=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),s.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function e(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let d;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(d=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(d[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function t(d){if(d[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+d[0]+(this.useColors?"%c ":" ")+"+"+r.exports.humanize(this.diff),!this.useColors)return;const p="color: "+this.color;d.splice(1,0,p,"color: inherit");let l=0,c=0;d[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(l++,h==="%c"&&(c=l))}),d.splice(c,0,p)}s.log=console.debug||console.log||(()=>{});function i(d){try{d?s.storage.setItem("debug",d):s.storage.removeItem("debug")}catch{}}function n(){let d;try{d=s.storage.getItem("debug")||s.storage.getItem("DEBUG")}catch{}return!d&&typeof process<"u"&&"env"in process&&(d={}.DEBUG),d}function a(){try{return localStorage}catch{}}r.exports=id(s);const{formatters:o}=r.exports;o.j=function(d){try{return JSON.stringify(d)}catch(p){return"[UnexpectedJSONParseError]: "+p.message}}})(Ni,Ni.exports);var Ts=Ni.exports,mo={},At={},ji={exports:{}};(function(r,s){(function(e,t){var i="2.0.3",n=500,a="user-agent",o="",d="?",p="function",l="undefined",c="object",h="string",u="browser",m="cpu",_="device",w="engine",S="os",x="result",v="name",g="type",b="vendor",R="version",pe="architecture",Le="major",y="model",De="console",L="mobile",Y="tablet",oe="smarttv",je="wearable",Ws="xr",br="embedded",Sr="inapp",Ys="brands",yt="formFactors",Xs="fullVersionList",$t="platform",Js="platformVersion",Gr="bitness",ot="sec-ch-ua",Go=ot+"-full-version-list",Qo=ot+"-arch",Wo=ot+"-"+Gr,Yo=ot+"-form-factors",Xo=ot+"-"+L,Jo=ot+"-"+y,kn=ot+"-"+$t,Zo=kn+"-version",En=[Ys,Xs,L,y,$t,Js,pe,yt,Gr],Qr="Amazon",Ft="Apple",Pn="ASUS",xn="BlackBerry",bt="Google",Ln="Huawei",In="Lenovo",Mn="Honor",Wr="LG",Zs="Microsoft",ei="Motorola",ti="Nvidia",On="OnePlus",ri="OPPO",Rr="Samsung",An="Sharp",Cr="Sony",si="Xiaomi",ii="Zebra",Nn="Chrome",jn="Chromium",ct="Chromecast",ec="Edge",Tr="Firefox",Dr="Opera",ni="Facebook",$n="Sogou",Bt="Mobile ",kr=" Browser",ai="Windows",Fn=typeof e!==l,Re=Fn&&e.navigator?e.navigator:t,dt=Re&&Re.userAgentData?Re.userAgentData:t,tc=function(C,T){var D={},K=T;if(!Xr(T)){K={};for(var A in T)for(var J in T[A])K[J]=T[A][J].concat(K[J]?K[J]:[])}for(var E in C)D[E]=K[E]&&K[E].length%2===0?K[E].concat(C[E]):C[E];return D},Yr=function(C){for(var T={},D=0;D<C.length;D++)T[C[D].toUpperCase()]=C[D];return T},oi=function(C,T){if(typeof C===c&&C.length>0){for(var D in C)if(et(C[D])==et(T))return!0;return!1}return Ut(C)?et(T).indexOf(et(C))!==-1:!1},Xr=function(C,T){for(var D in C)return/^(browser|cpu|device|engine|os)$/.test(D)||(T?Xr(C[D]):!1)},Ut=function(C){return typeof C===h},ci=function(C){if(!C)return t;for(var T=[],D=zt(/\\?\"/g,C).split(","),K=0;K<D.length;K++)if(D[K].indexOf(";")>-1){var A=Pr(D[K]).split(";v=");T[K]={brand:A[0],version:A[1]}}else T[K]=Pr(D[K]);return T},et=function(C){return Ut(C)?C.toLowerCase():C},di=function(C){return Ut(C)?zt(/[^\d\.]/g,C).split(".")[0]:t},tt=function(C){for(var T in C){var D=C[T];typeof D==c&&D.length==2?this[D[0]]=D[1]:this[D]=t}return this},zt=function(C,T){return Ut(T)?T.replace(C,o):T},Er=function(C){return zt(/\\?\"/g,C)},Pr=function(C,T){if(Ut(C))return C=zt(/^\s\s*/,C),typeof T===l?C:C.substring(0,n)},pi=function(C,T){if(!(!C||!T))for(var D=0,K,A,J,E,Q,B;D<T.length&&!Q;){var ie=T[D],rt=T[D+1];for(K=A=0;K<ie.length&&!Q&&ie[K];)if(Q=ie[K++].exec(C),Q)for(J=0;J<rt.length;J++)B=Q[++A],E=rt[J],typeof E===c&&E.length>0?E.length===2?typeof E[1]==p?this[E[0]]=E[1].call(this,B):this[E[0]]=E[1]:E.length===3?typeof E[1]===p&&!(E[1].exec&&E[1].test)?this[E[0]]=B?E[1].call(this,B,E[2]):t:this[E[0]]=B?B.replace(E[1],E[2]):t:E.length===4&&(this[E[0]]=B?E[3].call(this,B.replace(E[1],E[2])):t):this[E]=B||t;D+=2}},pt=function(C,T){for(var D in T)if(typeof T[D]===c&&T[D].length>0){for(var K=0;K<T[D].length;K++)if(oi(T[D][K],C))return D===d?t:D}else if(oi(T[D],C))return D===d?t:D;return T.hasOwnProperty("*")?T["*"]:C},Bn={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Un={embedded:"Automotive",mobile:"Mobile",tablet:["Tablet","EInk"],smarttv:"TV",wearable:"Watch",xr:["VR","XR"],"?":["Desktop","Unknown"],"*":t},zn={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[R,[v,Bt+"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[R,[v,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[v,R],[/opios[\/ ]+([\w\.]+)/i],[R,[v,Dr+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[R,[v,Dr+" GX"]],[/\bopr\/([\w\.]+)/i],[R,[v,Dr]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[R,[v,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[R,[v,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon|otter|dooble|(?:lg |qute)browser)\/([-\w\.]+)/i,/(heytap|ovi|115|surf)browser\/([\d\.]+)/i,/(ecosia|weibo)(?:__| \w+@)([\d\.]+)/i],[v,R],[/quark(?:pc)?\/([-\w\.]+)/i],[R,[v,"Quark"]],[/\bddg\/([\w\.]+)/i],[R,[v,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[R,[v,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[R,[v,"WeChat"]],[/konqueror\/([\w\.]+)/i],[R,[v,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[R,[v,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[R,[v,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[R,[v,"Smart "+In+kr]],[/(avast|avg)\/([\w\.]+)/i],[[v,/(.+)/,"$1 Secure"+kr],R],[/\bfocus\/([\w\.]+)/i],[R,[v,Tr+" Focus"]],[/\bopt\/([\w\.]+)/i],[R,[v,Dr+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[R,[v,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[R,[v,"Dolphin"]],[/coast\/([\w\.]+)/i],[R,[v,Dr+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[R,[v,"MIUI"+kr]],[/fxios\/([\w\.-]+)/i],[R,[v,Bt+Tr]],[/\bqihoobrowser\/?([\w\.]*)/i],[R,[v,"360"]],[/\b(qq)\/([\w\.]+)/i],[[v,/(.+)/,"$1Browser"],R],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[v,/(.+)/,"$1"+kr],R],[/samsungbrowser\/([\w\.]+)/i],[R,[v,Rr+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[R,[v,$n+" Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[v,$n+" Mobile"],R],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[v,R],[/(lbbrowser|rekonq)/i],[v],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[R,v],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[v,ni],R,[g,Sr]],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(instagram|snapchat)[\/ ]([-\w\.]+)/i],[v,R,[g,Sr]],[/\bgsa\/([\w\.]+) .*safari\//i],[R,[v,"GSA"],[g,Sr]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[R,[v,"TikTok"],[g,Sr]],[/\[(linkedin)app\]/i],[v,[g,Sr]],[/(chromium)[\/ ]([-\w\.]+)/i],[v,R],[/headlesschrome(?:\/([\w\.]+)| )/i],[R,[v,Nn+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[v,Nn+" WebView"],R],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[R,[v,"Android"+kr]],[/chrome\/([\w\.]+) mobile/i],[R,[v,Bt+"Chrome"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[v,R],[/version\/([\w\.\,]+) .*mobile(?:\/\w+ | ?)safari/i],[R,[v,Bt+"Safari"]],[/iphone .*mobile(?:\/\w+ | ?)safari/i],[[v,Bt+"Safari"]],[/version\/([\w\.\,]+) .*(safari)/i],[R,v],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[v,[R,"1"]],[/(webkit|khtml)\/([\w\.]+)/i],[v,R],[/(?:mobile|tablet);.*(firefox)\/([\w\.-]+)/i],[[v,Bt+Tr],R],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[v,"Netscape"],R],[/(wolvic|librewolf)\/([\w\.]+)/i],[v,R],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[R,[v,Tr+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[v,[R,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[v,[R,/[^\d\.]+./,o]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[pe,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[pe,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[pe,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[pe,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[pe,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[pe,/ower/,o,et]],[/ sun4\w[;\)]/i],[[pe,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[pe,et]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[y,[b,Rr],[g,Y]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[y,[b,Rr],[g,L]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[y,[b,Ft],[g,L]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[y,[b,Ft],[g,Y]],[/(macintosh);/i],[y,[b,Ft]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[y,[b,An],[g,L]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[y,[b,Mn],[g,Y]],[/honor([-\w ]+)[;\)]/i],[y,[b,Mn],[g,L]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[y,[b,Ln],[g,Y]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[y,[b,Ln],[g,L]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[y,/_/g," "],[b,si],[g,Y]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[y,/_/g," "],[b,si],[g,L]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[y,[b,ri],[g,L]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[y,[b,pt,{OnePlus:["304","403","203"],"*":ri}],[g,Y]],[/(vivo (5r?|6|8l?|go|one|s|x[il]?[2-4]?)[\w\+ ]*)(?: bui|\))/i],[y,[b,"BLU"],[g,L]],[/; vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[y,[b,"Vivo"],[g,L]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[y,[b,"Realme"],[g,L]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[y,[b,ei],[g,L]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[y,[b,ei],[g,Y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[y,[b,Wr],[g,Y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+(?!.*(?:browser|netcast|android tv|watch))(\w+)/i,/\blg-?([\d\w]+) bui/i],[y,[b,Wr],[g,L]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[y,[b,In],[g,Y]],[/(nokia) (t[12][01])/i],[b,y,[g,Y]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[y,/_/g," "],[g,L],[b,"Nokia"]],[/(pixel (c|tablet))\b/i],[y,[b,bt],[g,Y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[y,[b,bt],[g,L]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[y,[b,Cr],[g,L]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[y,"Xperia Tablet"],[b,Cr],[g,Y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[y,[b,On],[g,L]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[y,[b,Qr],[g,Y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[y,/(.+)/g,"Fire Phone $1"],[b,Qr],[g,L]],[/(playbook);[-\w\),; ]+(rim)/i],[y,b,[g,Y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[y,[b,xn],[g,L]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[y,[b,Pn],[g,Y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[y,[b,Pn],[g,L]],[/(nexus 9)/i],[y,[b,"HTC"],[g,Y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[b,[y,/_/g," "],[g,L]],[/tcl (xess p17aa)/i,/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])(_\w(\w|\w\w))?(\)| bui)/i],[y,[b,"TCL"],[g,Y]],[/droid [\w\.]+; (418(?:7d|8v)|5087z|5102l|61(?:02[dh]|25[adfh]|27[ai]|56[dh]|59k|65[ah])|a509dl|t(?:43(?:0w|1[adepqu])|50(?:6d|7[adju])|6(?:09dl|10k|12b|71[efho]|76[hjk])|7(?:66[ahju]|67[hw]|7[045][bh]|71[hk]|73o|76[ho]|79w|81[hks]?|82h|90[bhsy]|99b)|810[hs]))(_\w(\w|\w\w))?(\)| bui)/i],[y,[b,"TCL"],[g,L]],[/(itel) ((\w+))/i],[[b,et],y,[g,pt,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[y,[b,"Acer"],[g,Y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[y,[b,"Meizu"],[g,L]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[y,[b,"Ulefone"],[g,L]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[y,[b,"Energizer"],[g,L]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[y,[b,"Cat"],[g,L]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[y,[b,"Smartfren"],[g,L]],[/droid.+; (a(?:015|06[35]|142p?))/i],[y,[b,"Nothing"],[g,L]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[y,[b,"Archos"],[g,Y]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[y,[b,"Archos"],[g,L]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[b,y,[g,Y]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (blu|hmd|imo|tcl)[_ ]([\w\+ ]+?)(?: bui|\)|; r)/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[b,y,[g,L]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i],[b,y,[g,Y]],[/(surface duo)/i],[y,[b,Zs],[g,Y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[y,[b,"Fairphone"],[g,L]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[y,[b,ti],[g,Y]],[/(sprint) (\w+)/i],[b,y,[g,L]],[/(kin\.[onetw]{3})/i],[[y,/\./g," "],[b,Zs],[g,L]],[/droid.+; ([c6]+|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[y,[b,ii],[g,Y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[y,[b,ii],[g,L]],[/smart-tv.+(samsung)/i],[b,[g,oe]],[/hbbtv.+maple;(\d+)/i],[[y,/^/,"SmartTV"],[b,Rr],[g,oe]],[/tcast.+(lg)e?. ([-\w]+)/i],[b,y,[g,oe]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[b,Wr],[g,oe]],[/(apple) ?tv/i],[b,[y,Ft+" TV"],[g,oe]],[/crkey.*devicetype\/chromecast/i],[[y,ct+" Third Generation"],[b,bt],[g,oe]],[/crkey.*devicetype\/([^/]*)/i],[[y,/^/,"Chromecast "],[b,bt],[g,oe]],[/fuchsia.*crkey/i],[[y,ct+" Nest Hub"],[b,bt],[g,oe]],[/crkey/i],[[y,ct],[b,bt],[g,oe]],[/(portaltv)/i],[y,[b,ni],[g,oe]],[/droid.+aft(\w+)( bui|\))/i],[y,[b,Qr],[g,oe]],[/(shield \w+ tv)/i],[y,[b,ti],[g,oe]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[y,[b,An],[g,oe]],[/(bravia[\w ]+)( bui|\))/i],[y,[b,Cr],[g,oe]],[/(mi(tv|box)-?\w+) bui/i],[y,[b,si],[g,oe]],[/Hbbtv.*(technisat) (.*);/i],[b,y,[g,oe]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[b,Pr],[y,Pr],[g,oe]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[y,[g,oe]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[g,oe]],[/(ouya)/i,/(nintendo) (\w+)/i],[b,y,[g,De]],[/droid.+; (shield)( bui|\))/i],[y,[b,ti],[g,De]],[/(playstation \w+)/i],[y,[b,Cr],[g,De]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[y,[b,Zs],[g,De]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[y,[b,Rr],[g,je]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[b,y,[g,je]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[y,[b,ri],[g,je]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[y,[b,Ft],[g,je]],[/(opwwe\d{3})/i],[y,[b,On],[g,je]],[/(moto 360)/i],[y,[b,ei],[g,je]],[/(smartwatch 3)/i],[y,[b,Cr],[g,je]],[/(g watch r)/i],[y,[b,Wr],[g,je]],[/droid.+; (wt63?0{2,3})\)/i],[y,[b,ii],[g,je]],[/droid.+; (glass) \d/i],[y,[b,bt],[g,Ws]],[/(pico) (4|neo3(?: link|pro)?)/i],[b,y,[g,Ws]],[/(quest( \d| pro)?s?).+vr/i],[y,[b,ni],[g,Ws]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[b,[g,br]],[/(aeobc)\b/i],[y,[b,Qr],[g,br]],[/(homepod).+mac os/i],[y,[b,Ft],[g,br]],[/windows iot/i],[[g,br]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+?(mobile|vr|\d) safari/i],[y,[g,pt,{mobile:"Mobile",xr:"VR","*":Y}]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[g,Y]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[g,L]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[y,[b,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[R,[v,ec+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[v,R],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[R,[v,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[v,R],[/ladybird\//i],[[v,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[R,v]],os:[[/microsoft (windows) (vista|xp)/i],[v,R],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[v,[R,pt,Bn]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[R,pt,Bn],[v,ai]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[R,/_/g,"."],[v,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[v,"macOS"],[R,/_/g,"."]],[/android ([\d\.]+).*crkey/i],[R,[v,ct+" Android"]],[/fuchsia.*crkey\/([\d\.]+)/i],[R,[v,ct+" Fuchsia"]],[/crkey\/([\d\.]+).*devicetype\/smartspeaker/i],[R,[v,ct+" SmartSpeaker"]],[/linux.*crkey\/([\d\.]+)/i],[R,[v,ct+" Linux"]],[/crkey\/([\d\.]+)/i],[R,[v,ct]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[R,v],[/(ubuntu) ([\w\.]+) like android/i],[[v,/(.+)/,"$1 Touch"],R],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/\.; ]?([\d\.]*)/i],[v,R],[/\(bb(10);/i],[R,[v,xn]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[R,[v,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[R,[v,Tr+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[R,[v,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[R,[v,"watchOS"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[v,"Chrome OS"],R],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) (\w+)/i,/(xbox); +xbox ([^\);]+)/i,/(pico) .+os([\w\.]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[v,R],[/(sunos) ?([\w\.\d]*)/i],[[v,"Solaris"],R],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[v,R]]},Jr=function(){var C={init:{},isIgnore:{},isIgnoreRgx:{},toString:{}};return tt.call(C.init,[[u,[v,R,Le,g]],[m,[pe]],[_,[g,y,b]],[w,[v,R]],[S,[v,R]]]),tt.call(C.isIgnore,[[u,[R,Le]],[w,[R]],[S,[R]]]),tt.call(C.isIgnoreRgx,[[u,/ ?browser$/i],[S,/ ?os$/i]]),tt.call(C.toString,[[u,[v,R]],[m,[pe]],[_,[b,y]],[w,[v,R]],[S,[v,R]]]),C}(),rc=function(C,T){var D=Jr.init[T],K=Jr.isIgnore[T]||0,A=Jr.isIgnoreRgx[T]||0,J=Jr.toString[T]||0;function E(){tt.call(this,D)}return E.prototype.getItem=function(){return C},E.prototype.withClientHints=function(){return dt?dt.getHighEntropyValues(En).then(function(Q){return C.setCH(new Hn(Q,!1)).parseCH().get()}):C.parseCH().get()},E.prototype.withFeatureCheck=function(){return C.detectFeature().get()},T!=x&&(E.prototype.is=function(Q){var B=!1;for(var ie in this)if(this.hasOwnProperty(ie)&&!oi(K,ie)&&et(A?zt(A,this[ie]):this[ie])==et(A?zt(A,Q):Q)){if(B=!0,Q!=l)break}else if(Q==l&&B){B=!B;break}return B},E.prototype.toString=function(){var Q=o;for(var B in J)typeof this[J[B]]!==l&&(Q+=(Q?" ":o)+this[J[B]]);return Q||l}),dt||(E.prototype.then=function(Q){var B=this,ie=function(){for(var lt in B)B.hasOwnProperty(lt)&&(this[lt]=B[lt])};ie.prototype={is:E.prototype.is,toString:E.prototype.toString};var rt=new ie;return Q(rt),rt}),new E};function Hn(C,T){if(C=C||{},tt.call(this,En),T)tt.call(this,[[Ys,ci(C[ot])],[Xs,ci(C[Go])],[L,/\?1/.test(C[Xo])],[y,Er(C[Jo])],[$t,Er(C[kn])],[Js,Er(C[Zo])],[pe,Er(C[Qo])],[yt,ci(C[Yo])],[Gr,Er(C[Wo])]]);else for(var D in C)this.hasOwnProperty(D)&&typeof C[D]!==l&&(this[D]=C[D])}function qn(C,T,D,K){return this.get=function(A){return A?this.data.hasOwnProperty(A)?this.data[A]:t:this.data},this.set=function(A,J){return this.data[A]=J,this},this.setCH=function(A){return this.uaCH=A,this},this.detectFeature=function(){if(Re&&Re.userAgent==this.ua)switch(this.itemType){case u:Re.brave&&typeof Re.brave.isBrave==p&&this.set(v,"Brave");break;case _:!this.get(g)&&dt&&dt[L]&&this.set(g,L),this.get(y)=="Macintosh"&&Re&&typeof Re.standalone!==l&&Re.maxTouchPoints&&Re.maxTouchPoints>2&&this.set(y,"iPad").set(g,Y);break;case S:!this.get(v)&&dt&&dt[$t]&&this.set(v,dt[$t]);break;case x:var A=this.data,J=function(E){return A[E].getItem().detectFeature().get()};this.set(u,J(u)).set(m,J(m)).set(_,J(_)).set(w,J(w)).set(S,J(S))}return this},this.parseUA=function(){return this.itemType!=x&&pi.call(this.data,this.ua,this.rgxMap),this.itemType==u&&this.set(Le,di(this.get(R))),this},this.parseCH=function(){var A=this.uaCH,J=this.rgxMap;switch(this.itemType){case u:case w:var E=A[Xs]||A[Ys],Q;if(E)for(var B in E){var ie=E[B].brand||E[B],rt=E[B].version;this.itemType==u&&!/not.a.brand/i.test(ie)&&(!Q||/chrom/i.test(Q)&&ie!=jn)&&(ie=pt(ie,{Chrome:"Google Chrome",Edge:"Microsoft Edge","Chrome WebView":"Android WebView","Chrome Headless":"HeadlessChrome","Huawei Browser":"HuaweiBrowser","MIUI Browser":"Miui Browser","Opera Mobi":"OperaMobile",Yandex:"YaBrowser"}),this.set(v,ie).set(R,rt).set(Le,di(rt)),Q=ie),this.itemType==w&&ie==jn&&this.set(R,rt)}break;case m:var lt=A[pe];lt&&(lt&&A[Gr]=="64"&&(lt+="64"),pi.call(this.data,lt+";",J));break;case _:if(A[L]&&this.set(g,L),A[y]&&(this.set(y,A[y]),!this.get(g)||!this.get(b))){var xr={};pi.call(xr,"droid 9; "+A[y]+")",J),!this.get(g)&&xr.type&&this.set(g,xr.type),!this.get(b)&&xr.vendor&&this.set(b,xr.vendor)}if(A[yt]){var es;if(typeof A[yt]!="string")for(var Vn=0;!es&&Vn<A[yt].length;)es=pt(A[yt][Vn++],Un);else es=pt(A[yt],Un);this.set(g,es)}break;case S:var li=A[$t];if(li){var hi=A[Js];li==ai&&(hi=parseInt(di(hi),10)>=13?"11":"10"),this.set(v,li).set(R,hi)}this.get(v)==ai&&A[y]=="Xbox"&&this.set(v,"Xbox").set(R,t);break;case x:var sc=this.data,Lr=function(ic){return sc[ic].getItem().setCH(A).parseCH().get()};this.set(u,Lr(u)).set(m,Lr(m)).set(_,Lr(_)).set(w,Lr(w)).set(S,Lr(S))}return this},tt.call(this,[["itemType",C],["ua",T],["uaCH",K],["rgxMap",D],["data",rc(this,C)]]),this}function Ie(C,T,D){if(typeof C===c?(Xr(C,!0)?(typeof T===c&&(D=T),T=C):(D=C,T=t),C=t):typeof C===h&&!Xr(T,!0)&&(D=T,T=t),D&&typeof D.append===p){var K={};D.forEach(function(B,ie){K[ie]=B}),D=K}if(!(this instanceof Ie))return new Ie(C,T,D).getResult();var A=typeof C===h?C:D&&D[a]?D[a]:Re&&Re.userAgent?Re.userAgent:o,J=new Hn(D,!0),E=T?tc(zn,T):zn,Q=function(B){return B==x?function(){return new qn(B,A,E,J).set("ua",A).set(u,this.getBrowser()).set(m,this.getCPU()).set(_,this.getDevice()).set(w,this.getEngine()).set(S,this.getOS()).get()}:function(){return new qn(B,A,E[B],J).parseUA().get()}};return tt.call(this,[["getBrowser",Q(u)],["getCPU",Q(m)],["getDevice",Q(_)],["getEngine",Q(w)],["getOS",Q(S)],["getResult",Q(x)],["getUA",function(){return A}],["setUA",function(B){return Ut(B)&&(A=B.length>n?Pr(B,n):B),this}]]).setUA(A),this}Ie.VERSION=i,Ie.BROWSER=Yr([v,R,Le,g]),Ie.CPU=Yr([pe]),Ie.DEVICE=Yr([y,b,g,De,L,oe,Y,je,br]),Ie.ENGINE=Ie.OS=Yr([v,R]),r.exports&&(s=r.exports=Ie),s.UAParser=Ie;var Ht=Fn&&(e.jQuery||e.Zepto);if(Ht&&!Ht.ua){var Zr=new Ie;Ht.ua=Zr.getResult(),Ht.ua.get=function(){return Zr.getUA()},Ht.ua.set=function(C){Zr.setUA(C);var T=Zr.getResult();for(var D in T)Ht.ua[D]=T[D]}}})(typeof window=="object"?window:Ct)})(ji,ji.exports);var nd=ji.exports,te={};Object.defineProperty(te,"__esModule",{value:!0});te.Logger=void 0;const qt=Ts,Vt="mediasoup-client";let ad=class{constructor(s){f(this,"_debug");f(this,"_warn");f(this,"_error");s?(this._debug=(0,qt.default)(`${Vt}:${s}`),this._warn=(0,qt.default)(`${Vt}:WARN:${s}`),this._error=(0,qt.default)(`${Vt}:ERROR:${s}`)):(this._debug=(0,qt.default)(Vt),this._warn=(0,qt.default)(`${Vt}:WARN`),this._error=(0,qt.default)(`${Vt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};te.Logger=ad;var Ae={},Ki={exports:{}},pr=typeof Reflect=="object"?Reflect:null,Zn=pr&&typeof pr.apply=="function"?pr.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)},Ss;pr&&typeof pr.ownKeys=="function"?Ss=pr.ownKeys:Object.getOwnPropertySymbols?Ss=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:Ss=function(s){return Object.getOwnPropertyNames(s)};function od(r){console&&console.warn&&console.warn(r)}var go=Number.isNaN||function(s){return s!==s};function X(){X.init.call(this)}Ki.exports=X;Ki.exports.once=ld;X.EventEmitter=X;X.prototype._events=void 0;X.prototype._eventsCount=0;X.prototype._maxListeners=void 0;var ea=10;function Ds(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(X,"defaultMaxListeners",{enumerable:!0,get:function(){return ea},set:function(r){if(typeof r!="number"||r<0||go(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");ea=r}});X.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};X.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||go(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function _o(r){return r._maxListeners===void 0?X.defaultMaxListeners:r._maxListeners}X.prototype.getMaxListeners=function(){return _o(this)};X.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[s];if(d===void 0)return!1;if(typeof d=="function")Zn(d,this,e);else for(var p=d.length,l=So(d,p),t=0;t<p;++t)Zn(l[t],this,e);return!0};function wo(r,s,e,t){var i,n,a;if(Ds(e),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",s,e.listener?e.listener:e),n=r._events),a=n[s]),a===void 0)a=n[s]=e,++r._eventsCount;else if(typeof a=="function"?a=n[s]=t?[e,a]:[a,e]:t?a.unshift(e):a.push(e),i=_o(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=s,o.count=a.length,od(o)}return r}X.prototype.addListener=function(s,e){return wo(this,s,e,!1)};X.prototype.on=X.prototype.addListener;X.prototype.prependListener=function(s,e){return wo(this,s,e,!0)};function cd(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function vo(r,s,e){var t={fired:!1,wrapFn:void 0,target:r,type:s,listener:e},i=cd.bind(t);return i.listener=e,t.wrapFn=i,i}X.prototype.once=function(s,e){return Ds(e),this.on(s,vo(this,s,e)),this};X.prototype.prependOnceListener=function(s,e){return Ds(e),this.prependListener(s,vo(this,s,e)),this};X.prototype.removeListener=function(s,e){var t,i,n,a,o;if(Ds(e),i=this._events,i===void 0)return this;if(t=i[s],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(n=-1,a=t.length-1;a>=0;a--)if(t[a]===e||t[a].listener===e){o=t[a].listener,n=a;break}if(n<0)return this;n===0?t.shift():dd(t,n),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,o||e)}return this};X.prototype.off=X.prototype.removeListener;X.prototype.removeAllListeners=function(s){var e,t,i;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var n=Object.keys(t),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[s],typeof e=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this};function yo(r,s,e){var t=r._events;if(t===void 0)return[];var i=t[s];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?pd(i):So(i,i.length)}X.prototype.listeners=function(s){return yo(this,s,!0)};X.prototype.rawListeners=function(s){return yo(this,s,!1)};X.listenerCount=function(r,s){return typeof r.listenerCount=="function"?r.listenerCount(s):bo.call(r,s)};X.prototype.listenerCount=bo;function bo(r){var s=this._events;if(s!==void 0){var e=s[r];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}X.prototype.eventNames=function(){return this._eventsCount>0?Ss(this._events):[]};function So(r,s){for(var e=new Array(s),t=0;t<s;++t)e[t]=r[t];return e}function dd(r,s){for(;s+1<r.length;s++)r[s]=r[s+1];r.pop()}function pd(r){for(var s=new Array(r.length),e=0;e<s.length;++e)s[e]=r[e].listener||r[e];return s}function ld(r,s){return new Promise(function(e,t){function i(a){r.removeListener(s,n),t(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),e([].slice.call(arguments))}Ro(r,s,n,{once:!0}),s!=="error"&&hd(r,i,{once:!0})})}function hd(r,s,e){typeof r.on=="function"&&Ro(r,"error",s,e)}function Ro(r,s,e,t){if(typeof r.on=="function")t.once?r.once(s,e):r.on(s,e);else if(typeof r.addEventListener=="function")r.addEventListener(s,function i(n){t.once&&r.removeEventListener(s,i),e(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var ud=Ki.exports;Object.defineProperty(Ae,"__esModule",{value:!0});Ae.EnhancedEventEmitter=void 0;const fd=ud,md=te,gd=new md.Logger("EnhancedEventEmitter");class _d extends fd.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(s,...e){return super.emit(s,...e)}safeEmit(s,...e){try{return super.emit(s,...e)}catch(t){gd.error("safeEmit() | event listener threw an error [eventName:%s]:%o",s,t);try{super.emit("listenererror",s,t)}catch{}return!!super.listenerCount(s)}}on(s,e){return super.on(s,e),this}off(s,e){return super.off(s,e),this}addListener(s,e){return super.on(s,e),this}prependListener(s,e){return super.prependListener(s,e),this}once(s,e){return super.once(s,e),this}prependOnceListener(s,e){return super.prependOnceListener(s,e),this}removeListener(s,e){return super.off(s,e),this}removeAllListeners(s){return super.removeAllListeners(s),this}listenerCount(s){return super.listenerCount(s)}listeners(s){return super.listeners(s)}rawListeners(s){return super.rawListeners(s)}}Ae.EnhancedEventEmitter=_d;var ae={};Object.defineProperty(ae,"__esModule",{value:!0});ae.InvalidStateError=ae.UnsupportedError=void 0;class Gi extends Error{constructor(s){super(s),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Gi):this.stack=new Error(s).stack}}ae.UnsupportedError=Gi;class Qi extends Error{constructor(s){super(s),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Qi):this.stack=new Error(s).stack}}ae.InvalidStateError=Qi;var re={};Object.defineProperty(re,"__esModule",{value:!0});re.clone=wd;re.generateRandomNumber=vd;re.deepFreeze=Co;function wd(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}function vd(){return Math.round(Math.random()*1e7)}function Co(r){const s=Reflect.ownKeys(r);for(const e of s){const t=r[e];(t&&typeof t=="object"||typeof t=="function")&&Co(t)}return Object.freeze(r)}var W={},fe={},ks={},yd=Ct&&Ct.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ks,"__esModule",{value:!0});ks.Logger=void 0;const Kt=yd(Ts),Gt="h264-profile-level-id";let bd=class{constructor(s){s?(this._debug=(0,Kt.default)(`${Gt}:${s}`),this._warn=(0,Kt.default)(`${Gt}:WARN:${s}`),this._error=(0,Kt.default)(`${Gt}:ERROR:${s}`)):(this._debug=(0,Kt.default)(Gt),this._warn=(0,Kt.default)(`${Gt}:WARN`),this._error=(0,Kt.default)(`${Gt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};ks.Logger=bd;Object.defineProperty(fe,"__esModule",{value:!0});fe.ProfileLevelId=fe.Level=fe.Profile=void 0;fe.parseProfileLevelId=To;fe.profileLevelIdToString=Do;fe.profileToString=Td;fe.levelToString=Dd;fe.parseSdpProfileLevelId=Mt;fe.isSameProfile=kd;fe.isSameProfileAndLevel=Ed;fe.generateProfileLevelIdStringForAnswer=Pd;fe.supportedLevel=xd;const Sd=ks,Oe=new Sd.Logger;var Z;(function(r){r[r.ConstrainedBaseline=1]="ConstrainedBaseline",r[r.Baseline=2]="Baseline",r[r.Main=3]="Main",r[r.ConstrainedHigh=4]="ConstrainedHigh",r[r.High=5]="High",r[r.PredictiveHigh444=6]="PredictiveHigh444"})(Z||(fe.Profile=Z={}));var k;(function(r){r[r.L1_b=0]="L1_b",r[r.L1=10]="L1",r[r.L1_1=11]="L1_1",r[r.L1_2=12]="L1_2",r[r.L1_3=13]="L1_3",r[r.L2=20]="L2",r[r.L2_1=21]="L2_1",r[r.L2_2=22]="L2_2",r[r.L3=30]="L3",r[r.L3_1=31]="L3_1",r[r.L3_2=32]="L3_2",r[r.L4=40]="L4",r[r.L4_1=41]="L4_1",r[r.L4_2=42]="L4_2",r[r.L5=50]="L5",r[r.L5_1=51]="L5_1",r[r.L5_2=52]="L5_2"})(k||(fe.Level=k={}));class Es{constructor(s,e){this.profile=s,this.level=e}}fe.ProfileLevelId=Es;const Rd=new Es(Z.ConstrainedBaseline,k.L3_1);class st{constructor(s){this.mask=~ra("x",s),this.masked_value=ra("1",s)}isMatch(s){return this.masked_value===(s&this.mask)}}class it{constructor(s,e,t){this.profile_idc=s,this.profile_iop=e,this.profile=t}}const Cd=[new it(66,new st("x1xx0000"),Z.ConstrainedBaseline),new it(77,new st("1xxx0000"),Z.ConstrainedBaseline),new it(88,new st("11xx0000"),Z.ConstrainedBaseline),new it(66,new st("x0xx0000"),Z.Baseline),new it(88,new st("10xx0000"),Z.Baseline),new it(77,new st("0x0x0000"),Z.Main),new it(100,new st("00000000"),Z.High),new it(100,new st("00001100"),Z.ConstrainedHigh),new it(244,new st("00000000"),Z.PredictiveHigh444)],ta=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:k.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:k.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:k.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:k.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:k.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:k.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:k.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:k.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:k.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:k.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:k.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:k.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:k.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:k.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:k.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:k.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:k.L5_2}];function To(r){if(typeof r!="string"||r.length!==6)return;const e=parseInt(r,16);if(e===0)return;const t=e&255,i=e>>8&255,n=e>>16&255;let a;switch(t){case k.L1_1:{a=i&16?k.L1_b:k.L1_1;break}case k.L1:case k.L1_2:case k.L1_3:case k.L2:case k.L2_1:case k.L2_2:case k.L3:case k.L3_1:case k.L3_2:case k.L4:case k.L4_1:case k.L4_2:case k.L5:case k.L5_1:case k.L5_2:{a=t;break}default:{Oe.warn(`parseProfileLevelId() | unrecognized level_idc [str:${r}, level_idc:${t}]`);return}}for(const o of Cd)if(n===o.profile_idc&&o.profile_iop.isMatch(i))return Oe.debug(`parseProfileLevelId() | result [str:${r}, profile:${o.profile}, level:${a}]`),new Es(o.profile,a);Oe.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${r}, profile_idc:${n}, profile_iop:${i}]`)}function Do(r){if(r.level==k.L1_b)switch(r.profile){case Z.ConstrainedBaseline:return"42f00b";case Z.Baseline:return"42100b";case Z.Main:return"4d100b";default:{Oe.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${r.profile}`);return}}let s;switch(r.profile){case Z.ConstrainedBaseline:{s="42e0";break}case Z.Baseline:{s="4200";break}case Z.Main:{s="4d00";break}case Z.ConstrainedHigh:{s="640c";break}case Z.High:{s="6400";break}case Z.PredictiveHigh444:{s="f400";break}default:{Oe.warn(`profileLevelIdToString() | unrecognized profile ${r.profile}`);return}}let e=r.level.toString(16);return e.length===1&&(e=`0${e}`),`${s}${e}`}function Td(r){switch(r){case Z.ConstrainedBaseline:return"ConstrainedBaseline";case Z.Baseline:return"Baseline";case Z.Main:return"Main";case Z.ConstrainedHigh:return"ConstrainedHigh";case Z.High:return"High";case Z.PredictiveHigh444:return"PredictiveHigh444";default:{Oe.warn(`profileToString() | unrecognized profile ${r}`);return}}}function Dd(r){switch(r){case k.L1_b:return"1b";case k.L1:return"1";case k.L1_1:return"1.1";case k.L1_2:return"1.2";case k.L1_3:return"1.3";case k.L2:return"2";case k.L2_1:return"2.1";case k.L2_2:return"2.2";case k.L3:return"3";case k.L3_1:return"3.1";case k.L3_2:return"3.2";case k.L4:return"4";case k.L4_1:return"4.1";case k.L4_2:return"4.2";case k.L5:return"5";case k.L5_1:return"5.1";case k.L5_2:return"5.2";default:{Oe.warn(`levelToString() | unrecognized level ${r}`);return}}}function Mt(r={}){const s=r["profile-level-id"];return s?To(s):Rd}function kd(r={},s={}){const e=Mt(r),t=Mt(s);return!!(e&&t&&e.profile===t.profile)}function Ed(r={},s={}){const e=Mt(r),t=Mt(s);return!!(e&&t&&e.profile===t.profile&&e.level==t.level)}function Pd(r={},s={}){if(!r["profile-level-id"]&&!s["profile-level-id"]){Oe.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const e=Mt(r),t=Mt(s);if(!e)throw new TypeError("invalid local_profile_level_id");if(!t)throw new TypeError("invalid remote_profile_level_id");if(e.profile!==t.profile)throw new TypeError("H264 Profile mismatch");const i=sa(r)&&sa(s),n=e.level,a=t.level,o=Id(n,a),d=i?n:o;return Oe.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${e.profile}, level:${d}]`),Do(new Es(e.profile,d))}function xd(r,s){for(let t=ta.length-1;t>=0;--t){const i=ta[t];if(i.max_macroblock_frame_size*256<=r&&i.max_macroblocks_per_second<=s*i.max_macroblock_frame_size)return Oe.debug(`supportedLevel() | result [max_frame_pixel_count:${r}, max_fps:${s}, level:${i.level}]`),i.level}Oe.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${r}, max_fps:${s}]`)}function ra(r,s){return+(s[0]===r)<<7|+(s[1]===r)<<6|+(s[2]===r)<<5|+(s[3]===r)<<4|+(s[4]===r)<<3|+(s[5]===r)<<2|+(s[6]===r)<<1|+(s[7]===r)<<0}function Ld(r,s){return r===k.L1_b?s!==k.L1&&s!==k.L1_b:s===k.L1_b?r!==k.L1:r<s}function Id(r,s){return Ld(r,s)?r:s}function sa(r={}){const s=r["level-asymmetry-allowed"];return s===!0||s===1||s==="1"}Object.defineProperty(W,"__esModule",{value:!0});W.validateRtpCapabilities=jd;W.validateRtpParameters=Wi;W.validateSctpStreamParameters=$d;W.validateSctpCapabilities=Fd;W.getExtendedRtpCapabilities=Bd;W.getRecvRtpCapabilities=Ud;W.getSendingRtpParameters=zd;W.getSendingRemoteRtpParameters=Hd;W.reduceCodecs=qd;W.generateProbatorRtpParameters=Vd;W.canSend=Kd;W.canReceive=Gd;const ia=fe,Md=re,Od="probator",Ad=1234,Nd=127;function jd(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(const s of r.codecs)Qd(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const s of r.headerExtensions)Wd(s)}function Wi(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(const s of r.codecs)Yd(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const s of r.headerExtensions)Xd(s);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(const s of r.encodings)Jd(s);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),Zd(r.rtcp)}function $d(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let s=!1;if(typeof r.ordered=="boolean"?s=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(s&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!s&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}function Fd(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");ep(r.numStreams)}function Bd(r,s,e){const t={codecs:[],headerExtensions:[]};if(e)for(const i of r.codecs??[]){if(dr(i))continue;const n=(s.codecs??[]).find(o=>$i(o,i,{strict:!0,modify:!0}));if(!n)continue;const a={mimeType:i.mimeType,kind:i.kind,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:n.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters,remoteParameters:n.parameters,rtcpFeedback:na(i,n)};t.codecs.push(a)}else for(const i of s.codecs??[]){if(dr(i))continue;const n=(r.codecs??[]).find(o=>$i(o,i,{strict:!0,modify:!0}));if(!n)continue;const a={mimeType:n.mimeType,kind:n.kind,clockRate:n.clockRate,channels:n.channels,localPayloadType:n.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:i.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:n.parameters,remoteParameters:i.parameters,rtcpFeedback:na(n,i)};t.codecs.push(a)}for(const i of t.codecs){const n=r.codecs.find(o=>dr(o)&&o.parameters.apt===i.localPayloadType),a=s.codecs.find(o=>dr(o)&&o.parameters.apt===i.remotePayloadType);n&&a&&(i.localRtxPayloadType=n.preferredPayloadType,i.remoteRtxPayloadType=a.preferredPayloadType)}for(const i of s.headerExtensions){const n=r.headerExtensions.find(o=>tp(o,i));if(!n)continue;const a={kind:i.kind,uri:i.uri,sendId:n.preferredId,recvId:i.preferredId,encrypt:n.preferredEncrypt,direction:"sendrecv"};switch(i.direction){case"sendrecv":{a.direction="sendrecv";break}case"recvonly":{a.direction="sendonly";break}case"sendonly":{a.direction="recvonly";break}case"inactive":{a.direction="inactive";break}}t.headerExtensions.push(a)}return t}function Ud(r){const s={codecs:[],headerExtensions:[]};for(const e of r.codecs){const t={mimeType:e.mimeType,kind:e.kind,preferredPayloadType:e.remotePayloadType,clockRate:e.clockRate,channels:e.channels,parameters:e.localParameters,rtcpFeedback:e.rtcpFeedback};if(s.codecs.push(t),!e.remoteRtxPayloadType)continue;const i={mimeType:`${e.kind}/rtx`,kind:e.kind,preferredPayloadType:e.remoteRtxPayloadType,clockRate:e.clockRate,parameters:{apt:e.remotePayloadType},rtcpFeedback:[]};s.codecs.push(i)}for(const e of r.headerExtensions){if(e.direction!=="sendrecv"&&e.direction!=="recvonly")continue;const t={kind:e.kind,uri:e.uri,preferredId:e.recvId,preferredEncrypt:e.encrypt,direction:e.direction};s.headerExtensions.push(t)}return s}function zd(r,s){const e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const t of s.codecs){if(t.kind!==r)continue;const i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){const n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(const t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;const i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}return e}function Hd(r,s){const e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const t of s.codecs){if(t.kind!==r)continue;const i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.remoteParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){const n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(const t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;const i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}if(e.headerExtensions.some(t=>t.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="goog-remb");else if(e.headerExtensions.some(t=>t.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc");else for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return e}function qd(r,s){const e=[];if(!s)e.push(r[0]),dr(r[1])&&e.push(r[1]);else{for(let t=0;t<r.length;++t)if($i(r[t],s,{strict:!0})){e.push(r[t]),dr(r[t+1])&&e.push(r[t+1]);break}if(e.length===0)throw new TypeError("no matching codec found")}return e}function Vd(r){r=Md.clone(r),Wi(r);const s={mid:Od,codecs:[],headerExtensions:[],encodings:[{ssrc:Ad}],rtcp:{cname:"probator"}};return s.codecs.push(r.codecs[0]),s.codecs[0].payloadType=Nd,s.headerExtensions=r.headerExtensions,s}function Kd(r,s){return s.codecs.some(e=>e.kind===r)}function Gd(r,s){if(Wi(r),r.codecs.length===0)return!1;const e=r.codecs[0];return s.codecs.some(t=>t.remotePayloadType===e.payloadType)}function Qd(r){const s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(r.kind=e[1].toLowerCase(),r.preferredPayloadType&&typeof r.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const t of Object.keys(r.parameters)){let i=r.parameters[t];if(i===void 0&&(r.parameters[t]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if(t==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const t of r.rtcpFeedback)ko(t)}function ko(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}function Wd(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}function Yd(r){const s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");e[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const i of r.rtcpFeedback)ko(i)}function Xd(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const s of Object.keys(r.parameters)){let e=r.parameters[s];if(e===void 0&&(r.parameters[s]="",e=""),typeof e!="string"&&typeof e!="number")throw new TypeError("invalid header extension parameter")}}function Jd(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function Zd(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}function ep(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}function dr(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function $i(r,s,{strict:e=!1,modify:t=!1}={}){const i=r.mimeType.toLowerCase(),n=s.mimeType.toLowerCase();if(i!==n||r.clockRate!==s.clockRate||r.channels!==s.channels)return!1;switch(i){case"video/h264":{if(e){const a=r.parameters["packetization-mode"]??0,o=s.parameters["packetization-mode"]??0;if(a!==o||!ia.isSameProfile(r.parameters,s.parameters))return!1;let d;try{d=ia.generateProfileLevelIdStringForAnswer(r.parameters,s.parameters)}catch{return!1}t&&(d?(r.parameters["profile-level-id"]=d,s.parameters["profile-level-id"]=d):(delete r.parameters["profile-level-id"],delete s.parameters["profile-level-id"]))}break}case"video/vp9":{if(e){const a=r.parameters["profile-id"]??0,o=s.parameters["profile-id"]??0;if(a!==o)return!1}break}}return!0}function tp(r,s){return!(r.kind&&s.kind&&r.kind!==s.kind||r.uri!==s.uri)}function na(r,s){const e=[];for(const t of r.rtcpFeedback??[]){const i=(s.rtcpFeedback??[]).find(n=>n.type===t.type&&(n.parameter===t.parameter||!n.parameter&&!t.parameter));i&&e.push(i)}return e}var Br={},Eo={},Ps={},xs={};Object.defineProperty(xs,"__esModule",{value:!0});xs.Logger=void 0;const Qt=Ts,Wt="awaitqueue";class rp{constructor(s){f(this,"_debug");f(this,"_warn");f(this,"_error");s?(this._debug=Qt(`${Wt}:${s}`),this._warn=Qt(`${Wt}:WARN:${s}`),this._error=Qt(`${Wt}:ERROR:${s}`)):(this._debug=Qt(Wt),this._warn=Qt(`${Wt}:WARN`),this._error=Qt(`${Wt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}xs.Logger=rp;var Ot={};Object.defineProperty(Ot,"__esModule",{value:!0});Ot.AwaitQueueRemovedTaskError=Ot.AwaitQueueStoppedError=void 0;class Yi extends Error{constructor(s){super(s??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Yi)}}Ot.AwaitQueueStoppedError=Yi;class Xi extends Error{constructor(s){super(s??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Xi)}}Ot.AwaitQueueRemovedTaskError=Xi;Object.defineProperty(Ps,"__esModule",{value:!0});Ps.AwaitQueue=void 0;const sp=xs,aa=Ot,nt=new sp.Logger("AwaitQueue");class ip{constructor(){f(this,"pendingTasks",new Map);f(this,"nextTaskId",0);f(this,"stopping",!1);nt.debug("constructor()")}get size(){return this.pendingTasks.size}async push(s,e){if(e=e??s.name,nt.debug(`push() [name:${e}]`),typeof s!="function")throw new TypeError("given task is not a function");if(e)try{Object.defineProperty(s,"name",{value:e})}catch{}return new Promise((t,i)=>{const n={id:this.nextTaskId++,task:s,name:e,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),nt.debug(`resolving task [name:${n.name}]`),t(a);const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)},reject:a=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),nt.debug(`rejecting task [name:${n.name}]: %s`,String(a)),i(a),!this.stopping)){const[o]=this.pendingTasks.values();o&&!o.executedAt&&this.execute(o)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){nt.debug("stop()"),this.stopping=!0;for(const s of this.pendingTasks.values())nt.debug(`stop() | stopping task [name:${s.name}]`),s.reject(new aa.AwaitQueueStoppedError);this.stopping=!1}remove(s){nt.debug(`remove() [taskIdx:${s}]`);const e=Array.from(this.pendingTasks.values())[s];if(!e){nt.debug(`stop() | no task with given idx [taskIdx:${s}]`);return}e.reject(new aa.AwaitQueueRemovedTaskError)}dump(){const s=Date.now();let e=0;return Array.from(this.pendingTasks.values()).map(t=>({idx:e++,task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt-t.enqueuedAt:s-t.enqueuedAt,executionTime:t.executedAt?s-t.executedAt:0}))}async execute(s){if(nt.debug(`execute() [name:${s.name}]`),s.executedAt)throw new Error("task already being executed");s.executedAt=Date.now();try{const e=await s.task();s.resolve(e)}catch(e){s.reject(e)}}}Ps.AwaitQueue=ip;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.AwaitQueueRemovedTaskError=r.AwaitQueueStoppedError=r.AwaitQueue=void 0;var s=Ps;Object.defineProperty(r,"AwaitQueue",{enumerable:!0,get:function(){return s.AwaitQueue}});var e=Ot;Object.defineProperty(r,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return e.AwaitQueueStoppedError}}),Object.defineProperty(r,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return e.AwaitQueueRemovedTaskError}})})(Eo);var Ur={};Object.defineProperty(Ur,"__esModule",{value:!0});Ur.Producer=void 0;const np=te,oa=Ae,Yt=ae,$e=new np.Logger("Producer");class ap extends oa.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:i,track:n,rtpParameters:a,stopTracks:o,disableTrackOnPause:d,zeroRtpOnPause:p,appData:l}){super();f(this,"_id");f(this,"_localId");f(this,"_closed",!1);f(this,"_rtpSender");f(this,"_track");f(this,"_kind");f(this,"_rtpParameters");f(this,"_paused");f(this,"_maxSpatialLayer");f(this,"_stopTracks");f(this,"_disableTrackOnPause");f(this,"_zeroRtpOnPause");f(this,"_appData");f(this,"_observer",new oa.EnhancedEventEmitter);$e.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=i,this._track=n,this._kind=n.kind,this._rtpParameters=a,this._paused=d?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=o,this._disableTrackOnPause=d,this._zeroRtpOnPause=p,this._appData=l??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||($e.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||($e.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Yt.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if($e.debug("pause()"),this._closed){$e.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if($e.debug("resume()"),this._closed){$e.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if($e.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new Yt.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new Yt.InvalidStateError("track ended");if(e===this._track){$e.debug("replaceTrack() | same track, ignored");return}await new Promise((t,i)=>{this.safeEmit("@replacetrack",e,t,i)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new Yt.InvalidStateError("closed");if(this._kind!=="video")throw new Yt.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,i)=>{this.safeEmit("@setmaxspatiallayer",e,t,i)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new Yt.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,i)=>{this.safeEmit("@setrtpencodingparameters",e,t,i)})}onTrackEnded(){$e.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}}Ur.Producer=ap;var zr={};Object.defineProperty(zr,"__esModule",{value:!0});zr.Consumer=void 0;const op=te,ca=Ae,cp=ae,Fe=new op.Logger("Consumer");class dp extends ca.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:n,track:a,rtpParameters:o,appData:d}){super();f(this,"_id");f(this,"_localId");f(this,"_producerId");f(this,"_closed",!1);f(this,"_rtpReceiver");f(this,"_track");f(this,"_rtpParameters");f(this,"_paused");f(this,"_appData");f(this,"_observer",new ca.EnhancedEventEmitter);Fe.debug("constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=n,this._track=a,this._rtpParameters=o,this._paused=!a.enabled,this._appData=d??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Fe.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Fe.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new cp.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(Fe.debug("pause()"),this._closed){Fe.error("pause() | Consumer closed");return}if(this._paused){Fe.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(Fe.debug("resume()"),this._closed){Fe.error("resume() | Consumer closed");return}if(!this._paused){Fe.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){Fe.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}}zr.Consumer=dp;var Hr={};Object.defineProperty(Hr,"__esModule",{value:!0});Hr.DataProducer=void 0;const pp=te,da=Ae,lp=ae,at=new pp.Logger("DataProducer");class hp extends da.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:i,appData:n}){super();f(this,"_id");f(this,"_dataChannel");f(this,"_closed",!1);f(this,"_sctpStreamParameters");f(this,"_appData");f(this,"_observer",new da.EnhancedEventEmitter);at.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=i,this._appData=n??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(at.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(at.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(at.debug("send()"),this._closed)throw new lp.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(at.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?at.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):at.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(at.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||at.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}Hr.DataProducer=hp;var qr={};Object.defineProperty(qr,"__esModule",{value:!0});qr.DataConsumer=void 0;const up=te,pa=Ae,St=new up.Logger("DataConsumer");class fp extends pa.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:i,sctpStreamParameters:n,appData:a}){super();f(this,"_id");f(this,"_dataProducerId");f(this,"_dataChannel");f(this,"_closed",!1);f(this,"_sctpStreamParameters");f(this,"_appData");f(this,"_observer",new pa.EnhancedEventEmitter);St.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=i,this._sctpStreamParameters=n,this._appData=a??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(St.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(St.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(St.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?St.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):St.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(St.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}qr.DataConsumer=fp;Object.defineProperty(Br,"__esModule",{value:!0});Br.Transport=void 0;const mp=Eo,gp=te,la=Ae,le=ae,_i=re,Mr=W,_p=Ur,wp=zr,vp=Hr,yp=qr,ne=new gp.Logger("Transport");class bp{constructor(s){f(this,"consumerOptions");f(this,"promise");f(this,"resolve");f(this,"reject");this.consumerOptions=s,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Sp extends la.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:a,sctpParameters:o,iceServers:d,iceTransportPolicy:p,additionalSettings:l,proprietaryConstraints:c,appData:h,handlerFactory:u,extendedRtpCapabilities:m,canProduceByKind:_}){super();f(this,"_id");f(this,"_closed",!1);f(this,"_direction");f(this,"_extendedRtpCapabilities");f(this,"_canProduceByKind");f(this,"_maxSctpMessageSize");f(this,"_handler");f(this,"_iceGatheringState","new");f(this,"_connectionState","new");f(this,"_appData");f(this,"_producers",new Map);f(this,"_consumers",new Map);f(this,"_dataProducers",new Map);f(this,"_dataConsumers",new Map);f(this,"_probatorConsumerCreated",!1);f(this,"_awaitQueue",new mp.AwaitQueue);f(this,"_pendingConsumerTasks",[]);f(this,"_consumerCreationInProgress",!1);f(this,"_pendingPauseConsumers",new Map);f(this,"_consumerPauseInProgress",!1);f(this,"_pendingResumeConsumers",new Map);f(this,"_consumerResumeInProgress",!1);f(this,"_pendingCloseConsumers",new Map);f(this,"_consumerCloseInProgress",!1);f(this,"_observer",new la.EnhancedEventEmitter);ne.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=m,this._canProduceByKind=_,this._maxSctpMessageSize=o?o.maxMessageSize:null;const w=_i.clone(l)??{};delete w.iceServers,delete w.iceTransportPolicy,delete w.bundlePolicy,delete w.rtcpMuxPolicy,delete w.sdpSemantics,this._handler=u(),this._handler.run({direction:e,iceParameters:i,iceCandidates:n,dtlsParameters:a,sctpParameters:o,iceServers:d,iceTransportPolicy:p,additionalSettings:w,proprietaryConstraints:c,extendedRtpCapabilities:m}),this._appData=h??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){ne.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new le.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(ne.debug("restartIce()"),this._closed)throw new le.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(ne.debug("updateIceServers()"),this._closed)throw new le.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:i,codec:n,stopTracks:a=!0,disableTrackOnPause:o=!0,zeroRtpOnPause:d=!1,onRtpSender:p,appData:l={}}={}){if(ne.debug("produce() [track:%o]",e),this._closed)throw new le.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new le.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new le.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(l&&typeof l!="object")throw new TypeError("if given, appData must be an object")}else throw new le.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let c;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?c=void 0:t&&(c=t.map(_=>{const w={active:!0};return _.active===!1&&(w.active=!1),typeof _.dtx=="boolean"&&(w.dtx=_.dtx),typeof _.scalabilityMode=="string"&&(w.scalabilityMode=_.scalabilityMode),typeof _.scaleResolutionDownBy=="number"&&(w.scaleResolutionDownBy=_.scaleResolutionDownBy),typeof _.maxBitrate=="number"&&(w.maxBitrate=_.maxBitrate),typeof _.maxFramerate=="number"&&(w.maxFramerate=_.maxFramerate),typeof _.adaptivePtime=="boolean"&&(w.adaptivePtime=_.adaptivePtime),typeof _.priority=="string"&&(w.priority=_.priority),typeof _.networkPriority=="string"&&(w.networkPriority=_.networkPriority),w}));const{localId:h,rtpParameters:u,rtpSender:m}=await this._handler.send({track:e,encodings:c,codecOptions:i,codec:n,onRtpSender:p});try{Mr.validateRtpParameters(u);const{id:_}=await new Promise((S,x)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:u,appData:l},S,x)}),w=new _p.Producer({id:_,localId:h,rtpSender:m,track:e,rtpParameters:u,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:d,appData:l});return this._producers.set(w.id,w),this.handleProducer(w),this._observer.safeEmit("newproducer",w),w}catch(_){throw this._handler.stopSending(h).catch(()=>{}),_}},"transport.produce()").catch(c=>{if(a)try{e.stop()}catch{}throw c})}async consume({id:e,producerId:t,kind:i,rtpParameters:n,streamId:a,onRtpReceiver:o,appData:d={}}){if(ne.debug("consume()"),this._closed)throw new le.InvalidStateError("closed");if(this._direction!=="recv")throw new le.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(i!=="audio"&&i!=="video")throw new TypeError(`invalid kind '${i}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object");const p=_i.clone(n);if(!Mr.canReceive(p,this._extendedRtpCapabilities))throw new le.UnsupportedError("cannot consume this Producer");const c=new bp({id:e,producerId:t,kind:i,rtpParameters:p,streamId:a,onRtpReceiver:o,appData:d});return this._pendingConsumerTasks.push(c),queueMicrotask(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),c.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:i,label:n="",protocol:a="",appData:o={}}={}){if(ne.debug("produceData()"),this._closed)throw new le.InvalidStateError("closed");if(this._direction!=="send")throw new le.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new le.UnsupportedError("SCTP not enabled by remote Transport");return(t||i)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:d,sctpStreamParameters:p}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a});Mr.validateSctpStreamParameters(p);const{id:l}=await new Promise((h,u)=>{this.safeEmit("producedata",{sctpStreamParameters:p,label:n,protocol:a,appData:o},h,u)}),c=new vp.DataProducer({id:l,dataChannel:d,sctpStreamParameters:p,appData:o});return this._dataProducers.set(c.id,c),this.handleDataProducer(c),this._observer.safeEmit("newdataproducer",c),c},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:i,label:n="",protocol:a="",appData:o={}}){if(ne.debug("consumeData()"),this._closed)throw new le.InvalidStateError("closed");if(this._direction!=="recv")throw new le.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new le.UnsupportedError("SCTP not enabled by remote Transport");const d=_i.clone(i);return Mr.validateSctpStreamParameters(d),this._awaitQueue.push(async()=>{const{dataChannel:p}=await this._handler.receiveDataChannel({sctpStreamParameters:d,label:n,protocol:a}),l=new yp.DataConsumer({id:e,dataProducerId:t,dataChannel:p,sctpStreamParameters:d,appData:o});return this._dataConsumers.set(l.id,l),this.handleDataConsumer(l),this._observer.safeEmit("newdataconsumer",l),l},"transport.consumeData()")}createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){ne.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const i=[];for(const n of e){const{id:a,kind:o,rtpParameters:d,streamId:p,onRtpReceiver:l}=n.consumerOptions;i.push({trackId:a,kind:o,rtpParameters:d,streamId:p,onRtpReceiver:l})}try{const n=await this._handler.receive(i);for(let a=0;a<n.length;++a){const o=e[a],d=n[a],{id:p,producerId:l,kind:c,rtpParameters:h,appData:u}=o.consumerOptions,{localId:m,rtpReceiver:_,track:w}=d,S=new wp.Consumer({id:p,localId:m,producerId:l,rtpReceiver:_,track:w,rtpParameters:h,appData:u});this._consumers.set(S.id,S),this.handleConsumer(S),!this._probatorConsumerCreated&&!t&&c==="video"&&(t=S),this._observer.safeEmit("newconsumer",S),o.resolve(S)}}catch(n){for(const a of e)a.reject(n)}if(t)try{const n=Mr.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:n}]),ne.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(n){ne.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",n)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){ne.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(i=>i.localId);await this._handler.pauseReceiving(t)}catch(t){ne.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){ne.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(i=>i.localId);await this._handler.resumeReceiving(t)}catch(t){ne.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){ne.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){ne.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},i,n)=>{if(this._closed){n(new le.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},i,n)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(ne.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@icecandidateerror",t=>{ne.warn(`ICE candidate error [url:${t.url}, localAddress:${t.address}, localPort:${t.port}]: ${t.errorCode} "${t.errorText}"`),this.safeEmit("icecandidateerror",t)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(ne.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>ne.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(i)}),e.on("@resume",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(i)}),e.on("@replacetrack",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(n)}),e.on("@setmaxspatiallayer",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(n)}),e.on("@setrtpencodingparameters",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(n)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new le.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new le.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}Br.Transport=Sp;var Ls={},se={},Po={},xo={exports:{}},ha=xo.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var s="candidate:%s %d %s %d %s %d typ %s";return s+=r.raddr!=null?" raddr %s rport %d":"%v%v",s+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(s+=" generation %d"),s+=r["network-id"]!=null?" network-id %d":"%v",s+=r["network-cost"]!=null?" network-cost %d":"%v",s}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var s="ssrc:%d";return r.attribute!=null&&(s+=" %s",r.value!=null&&(s+=":%s")),s}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var s="mediaclk:";return s+=r.id!=null?"id=%s %s":"%v%s",s+=r.mediaClockValue!=null?"=%s":"",s+=r.rateNumerator!=null?" rate=%s":"",s+=r.rateDenominator!=null?"/%s":"",s}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(ha).forEach(function(r){var s=ha[r];s.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})});var Ji=xo.exports;(function(r){var s=function(o){return String(Number(o))===o?Number(o):o},e=function(o,d,p,l){if(l&&!p)d[l]=s(o[1]);else for(var c=0;c<p.length;c+=1)o[c+1]!=null&&(d[p[c]]=s(o[c+1]))},t=function(o,d,p){var l=o.name&&o.names;o.push&&!d[o.push]?d[o.push]=[]:l&&!d[o.name]&&(d[o.name]={});var c=o.push?{}:l?d[o.name]:d;e(p.match(o.reg),c,o.names,o.name),o.push&&d[o.push].push(c)},i=Ji,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(o){var d={},p=[],l=d;return o.split(/(\r\n|\r|\n)/).filter(n).forEach(function(c){var h=c[0],u=c.slice(2);h==="m"&&(p.push({rtp:[],fmtp:[]}),l=p[p.length-1]);for(var m=0;m<(i[h]||[]).length;m+=1){var _=i[h][m];if(_.reg.test(u))return t(_,l,u)}}),d.media=p,d};var a=function(o,d){var p=d.split(/=(.+)/,2);return p.length===2?o[p[0]]=s(p[1]):p.length===1&&d.length>1&&(o[p[0]]=void 0),o};r.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(o){return o.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(o){for(var d=[],p=o.split(" ").map(s),l=0;l<p.length;l+=3)d.push({component:p[l],ip:p[l+1],port:p[l+2]});return d},r.parseImageAttributes=function(o){return o.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(a,{})})},r.parseSimulcastStreamList=function(o){return o.split(";").map(function(d){return d.split(",").map(function(p){var l,c=!1;return p[0]!=="~"?l=s(p):(l=s(p.substring(1,p.length)),c=!0),{scid:l,paused:c}})})}})(Po);var wi=Ji,Rp=/%[sdv%]/g,Cp=function(r){var s=1,e=arguments,t=e.length;return r.replace(Rp,function(i){if(s>=t)return i;var n=e[s];switch(s+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},Or=function(r,s,e){var t=s.format instanceof Function?s.format(s.push?e:e[s.name]):s.format,i=[r+"="+t];if(s.names)for(var n=0;n<s.names.length;n+=1){var a=s.names[n];s.name?i.push(e[s.name][a]):i.push(e[s.names[n]])}else i.push(e[s.name]);return Cp.apply(null,i)},Tp=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Dp=["i","c","b","a"],kp=function(r,s){s=s||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var e=s.outerOrder||Tp,t=s.innerOrder||Dp,i=[];return e.forEach(function(n){wi[n].forEach(function(a){a.name in r&&r[a.name]!=null?i.push(Or(n,a,r)):a.push in r&&r[a.push]!=null&&r[a.push].forEach(function(o){i.push(Or(n,a,o))})})}),r.media.forEach(function(n){i.push(Or("m",wi.m[0],n)),t.forEach(function(a){wi[a].forEach(function(o){o.name in n&&n[o.name]!=null?i.push(Or(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(d){i.push(Or(a,o,d))})})})}),i.join(`\r
`)+`\r
`},Nt=Po,Ep=kp,Pp=Ji;se.grammar=Pp;se.write=Ep;se.parse=Nt.parse;se.parseParams=Nt.parseParams;se.parseFmtpConfig=Nt.parseFmtpConfig;se.parsePayloads=Nt.parsePayloads;se.parseRemoteCandidates=Nt.parseRemoteCandidates;se.parseImageAttributes=Nt.parseImageAttributes;se.parseSimulcastStreamList=Nt.parseSimulcastStreamList;var Se={};Object.defineProperty(Se,"__esModule",{value:!0});Se.extractRtpCapabilities=xp;Se.extractDtlsParameters=Lp;Se.getCname=Ip;Se.applyCodecParameters=Mp;const Lo=se;function xp({sdpObject:r}){const s=new Map,e=[];let t=!1,i=!1;for(const a of r.media){const o=a.type;switch(o){case"audio":{if(t)continue;t=!0;break}case"video":{if(i)continue;i=!0;break}default:continue}for(const d of a.rtp){const p={kind:o,mimeType:`${o}/${d.codec}`,preferredPayloadType:d.payload,clockRate:d.rate,channels:d.encoding,parameters:{},rtcpFeedback:[]};s.set(p.preferredPayloadType,p)}for(const d of a.fmtp??[]){const p=Lo.parseParams(d.config),l=s.get(d.payload);l&&(p!=null&&p.hasOwnProperty("profile-level-id")&&(p["profile-level-id"]=String(p["profile-level-id"])),l.parameters=p)}for(const d of a.rtcpFb??[]){const p={type:d.type,parameter:d.subtype};if(p.parameter||delete p.parameter,d.payload!=="*"){const l=s.get(d.payload);if(!l)continue;l.rtcpFeedback.push(p)}else for(const l of s.values())l.kind===o&&!/.+\/rtx$/i.test(l.mimeType)&&l.rtcpFeedback.push(p)}for(const d of a.ext??[]){if(d["encrypt-uri"])continue;const p={kind:o,uri:d.uri,preferredId:d.value};e.push(p)}}return{codecs:Array.from(s.values()),headerExtensions:e}}function Lp({sdpObject:r}){let s=r.setup,e=r.fingerprint;if(!s||!e){const n=(r.media??[]).find(a=>a.port!==0);n&&(s??(s=n.setup),e??(e=n.fingerprint))}if(s){if(!e)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let t;switch(s){case"active":{t="client";break}case"passive":{t="server";break}case"actpass":{t="auto";break}}return{role:t,fingerprints:[{algorithm:e.type,value:e.hash}]}}function Ip({offerMediaObject:r}){const s=(r.ssrcs??[]).find(e=>e.attribute==="cname");return s?s.value:""}function Mp({offerRtpParameters:r,answerMediaObject:s}){for(const e of r.codecs){const t=e.mimeType.toLowerCase();if(t!=="audio/opus"||!(s.rtp??[]).find(o=>o.payload===e.payloadType))continue;s.fmtp=s.fmtp??[];let n=s.fmtp.find(o=>o.payload===e.payloadType);n||(n={payload:e.payloadType,config:""},s.fmtp.push(n));const a=Lo.parseParams(n.config);switch(t){case"audio/opus":{const o=e.parameters["sprop-stereo"];o!==void 0&&(a.stereo=Number(o)?1:0);break}}n.config="";for(const o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}var Je={};Object.defineProperty(Je,"__esModule",{value:!0});Je.getRtpEncodings=Op;Je.addLegacySimulcast=Ap;function Op({offerMediaObject:r}){const s=new Set;for(const i of r.ssrcs??[]){const n=i.id;s.add(n)}if(s.size===0)throw new Error("no a=ssrc lines found");const e=new Map;for(const i of r.ssrcGroups??[]){if(i.semantics!=="FID")continue;let[n,a]=i.ssrcs.split(/\s+/);n=Number(n),a=Number(a),s.has(n)&&(s.delete(n),s.delete(a),e.set(n,a))}for(const i of s)e.set(i,null);const t=[];for(const[i,n]of e){const a={ssrc:i};n&&(a.rtx={ssrc:n}),t.push(a)}return t}function Ap({offerMediaObject:r,numStreams:s}){if(s<=1)throw new TypeError("numStreams must be greater than 1");const e=(r.ssrcs??[]).find(c=>c.attribute==="msid");if(!e)throw new Error("a=ssrc line with msid information not found");const[t,i]=e.value.split(" "),n=Number(e.id);let a;(r.ssrcGroups??[]).some(c=>{if(c.semantics!=="FID")return!1;const h=c.ssrcs.split(/\s+/);return Number(h[0])===n?(a=Number(h[1]),!0):!1});const o=r.ssrcs.find(c=>c.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");const d=o.value,p=[],l=[];for(let c=0;c<s;++c)p.push(n+c),a&&l.push(a+c);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(const c of p)r.ssrcs.push({id:c,attribute:"cname",value:d}),r.ssrcs.push({id:c,attribute:"msid",value:`${t} ${i}`});for(let c=0;c<l.length;++c){const h=p[c],u=l[c];r.ssrcs.push({id:u,attribute:"cname",value:d}),r.ssrcs.push({id:u,attribute:"msid",value:`${t} ${i}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${u}`})}}var _r={};Object.defineProperty(_r,"__esModule",{value:!0});_r.addNackSupportForOpus=Np;function Np(r){var s;for(const e of r.codecs??[])(e.mimeType.toLowerCase()==="audio/opus"||e.mimeType.toLowerCase()==="audio/multiopus")&&!((s=e.rtcpFeedback)!=null&&s.some(t=>t.type==="nack"&&!t.parameter))&&(e.rtcpFeedback||(e.rtcpFeedback=[]),e.rtcpFeedback.push({type:"nack"}))}var me={};Object.defineProperty(me,"__esModule",{value:!0});me.HandlerInterface=void 0;const jp=Ae;class $p extends jp.EnhancedEventEmitter{constructor(){super()}}me.HandlerInterface=$p;var Ce={},vt={};Object.defineProperty(vt,"__esModule",{value:!0});vt.OfferMediaSection=vt.AnswerMediaSection=vt.MediaSection=void 0;const Fp=se,ua=re;class Zi{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,planB:i=!1}){f(this,"_mediaObject");f(this,"_planB");if(this._mediaObject={},this._planB=i,s&&this.setIceParameters(s),e){this._mediaObject.candidates=[];for(const n of e){const a={};a.component=1,a.foundation=n.foundation,a.ip=n.address??n.ip,a.port=n.port,a.priority=n.priority,a.transport=n.protocol,a.type=n.type,n.tcpType&&(a.tcptype=n.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}t&&this.setDtlsRole(t.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(s){this._mediaObject.iceUfrag=s.usernameFragment,this._mediaObject.icePwd=s.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}}vt.MediaSection=Zi;class Bp extends Zi{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,planB:a=!1,offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:p,codecOptions:l}){switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const c of p.codecs){const h={payload:c.payloadType,codec:Fi(c),rate:c.clockRate};c.channels>1&&(h.encoding=c.channels),this._mediaObject.rtp.push(h);const u=ua.clone(c.parameters)??{};let m=ua.clone(c.rtcpFeedback)??[];if(l){const{opusStereo:w,opusFec:S,opusDtx:x,opusMaxPlaybackRate:v,opusMaxAverageBitrate:g,opusPtime:b,opusNack:R,videoGoogleStartBitrate:pe,videoGoogleMaxBitrate:Le,videoGoogleMinBitrate:y}=l,De=d.codecs.find(L=>L.payloadType===c.payloadType);switch(c.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{w!==void 0&&(De.parameters["sprop-stereo"]=w?1:0,u.stereo=w?1:0),S!==void 0&&(De.parameters.useinbandfec=S?1:0,u.useinbandfec=S?1:0),x!==void 0&&(De.parameters.usedtx=x?1:0,u.usedtx=x?1:0),v!==void 0&&(u.maxplaybackrate=v),g!==void 0&&(u.maxaveragebitrate=g),b!==void 0&&(De.parameters.ptime=b,u.ptime=b),R||(De.rtcpFeedback=De.rtcpFeedback.filter(L=>L.type!=="nack"||L.parameter),m=m.filter(L=>L.type!=="nack"||L.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{pe!==void 0&&(u["x-google-start-bitrate"]=pe),Le!==void 0&&(u["x-google-max-bitrate"]=Le),y!==void 0&&(u["x-google-min-bitrate"]=y);break}}}const _={payload:c.payloadType,config:""};for(const w of Object.keys(u))_.config&&(_.config+=";"),_.config+=`${w}=${u[w]}`;_.config&&this._mediaObject.fmtp.push(_);for(const w of m)this._mediaObject.rtcpFb.push({payload:c.payloadType,type:w.type,subtype:w.parameter})}this._mediaObject.payloads=p.codecs.map(c=>c.payloadType).join(" "),this._mediaObject.ext=[];for(const c of p.headerExtensions)(o.ext??[]).some(u=>u.uri===c.uri)&&this._mediaObject.ext.push({uri:c.uri,value:c.id});if(o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const c of o.rids??[])c.direction==="send"&&this._mediaObject.rids.push({id:c.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const c of o.rids??[])c.direction==="send"&&this._mediaObject.rids.push({id:c.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(s){switch(s){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(s){var n,a;if(!((n=this._mediaObject.simulcast)!=null&&n.list1))return;const e={};for(const o of s)o.rid&&(e[o.rid]=o);const t=this._mediaObject.simulcast.list1,i=Fp.parseSimulcastStreamList(t);for(const o of i)for(const d of o)d.paused=!((a=e[d.scid])!=null&&a.active);this._mediaObject.simulcast.list1=i.map(o=>o.map(d=>`${d.paused?"~":""}${d.scid}`).join(",")).join(";")}}vt.AnswerMediaSection=Bp;class Up extends Zi{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,planB:a=!1,mid:o,kind:d,offerRtpParameters:p,streamId:l,trackId:c,oldDataChannelSpec:h=!1}){var u;switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=d,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),this._mediaObject.extmapAllowMixed="extmap-allow-mixed",d){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l??"-"} ${c}`);for(const S of p.codecs){const x={payload:S.payloadType,codec:Fi(S),rate:S.clockRate};S.channels>1&&(x.encoding=S.channels),this._mediaObject.rtp.push(x);const v={payload:S.payloadType,config:""};for(const g of Object.keys(S.parameters))v.config&&(v.config+=";"),v.config+=`${g}=${S.parameters[g]}`;v.config&&this._mediaObject.fmtp.push(v);for(const g of S.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:S.payloadType,type:g.type,subtype:g.parameter})}this._mediaObject.payloads=p.codecs.map(S=>S.payloadType).join(" "),this._mediaObject.ext=[];for(const S of p.headerExtensions)this._mediaObject.ext.push({uri:S.uri,value:S.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const m=p.encodings[0],_=m.ssrc,w=(u=m.rtx)==null?void 0:u.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],p.rtcp.cname&&this._mediaObject.ssrcs.push({id:_,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:_,attribute:"msid",value:`${l??"-"} ${c}`}),w&&(p.rtcp.cname&&this._mediaObject.ssrcs.push({id:w,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:w,attribute:"msid",value:`${l??"-"} ${c}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${_} ${w}`}));break}case"application":{h?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize);break}}}setDtlsRole(s){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:s,streamId:e,trackId:t}){var d;const i=s.encodings[0],n=i.ssrc,a=(d=i.rtx)==null?void 0:d.ssrc,o=this._mediaObject.payloads.split(" ");for(const p of s.codecs){if(o.includes(String(p.payloadType)))continue;const l={payload:p.payloadType,codec:Fi(p),rate:p.clockRate};p.channels>1&&(l.encoding=p.channels),this._mediaObject.rtp.push(l);const c={payload:p.payloadType,config:""};for(const h of Object.keys(p.parameters))c.config&&(c.config+=";"),c.config+=`${h}=${p.parameters[h]}`;c.config&&this._mediaObject.fmtp.push(c);for(const h of p.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:p.payloadType,type:h.type,subtype:h.parameter})}this._mediaObject.payloads+=` ${s.codecs.filter(p=>!this._mediaObject.payloads.includes(p.payloadType)).map(p=>p.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),s.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:s.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${e??"-"} ${t}`}),a&&(s.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:s.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${e??"-"} ${t}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${a}`}))}planBStopReceiving({offerRtpParameters:s}){var n;const e=s.encodings[0],t=e.ssrc,i=(n=e.rtx)==null?void 0:n.ssrc;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(a=>a.id!==t&&a.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(a=>a.ssrcs!==`${t} ${i}`))}}vt.OfferMediaSection=Up;function Fi(r){const e=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");return e[2]}Object.defineProperty(Ce,"__esModule",{value:!0});Ce.RemoteSdp=void 0;const zp=se,Hp=te,ss=vt,is=new Hp.Logger("RemoteSdp");class qp{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,planB:a=!1}){f(this,"_iceParameters");f(this,"_iceCandidates");f(this,"_dtlsParameters");f(this,"_sctpParameters");f(this,"_plainRtpParameters");f(this,"_planB");f(this,"_mediaSections",[]);f(this,"_midToIndex",new Map);f(this,"_firstMid");f(this,"_sdpObject");if(this._iceParameters=s,this._iceCandidates=e,this._dtlsParameters=t,this._sctpParameters=i,this._plainRtpParameters=n,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},s!=null&&s.iceLite&&(this._sdpObject.icelite="ice-lite"),t){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:t.fingerprints[o-1].algorithm,hash:t.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(s){is.debug("updateIceParameters() [iceParameters:%o]",s),this._iceParameters=s,this._sdpObject.icelite=s.iceLite?"ice-lite":void 0;for(const e of this._mediaSections)e.setIceParameters(s)}updateDtlsRole(s){is.debug("updateDtlsRole() [role:%s]",s),this._dtlsParameters.role=s;for(const e of this._mediaSections)e.setDtlsRole(s)}setSessionExtmapAllowMixed(){is.debug("setSessionExtmapAllowMixed()"),this._sdpObject.extmapAllowMixed="extmap-allow-mixed"}getNextMediaSectionIdx(){for(let s=0;s<this._mediaSections.length;++s){const e=this._mediaSections[s];if(e.closed)return{idx:s,reuseMid:e.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:s,reuseMid:e,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n}){const a=new ss.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:s,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n});e?this._replaceMediaSection(a,e):this._midToIndex.has(a.mid)?this._replaceMediaSection(a):this._addMediaSection(a)}receive({mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n}){const a=this._midToIndex.get(s);let o;if(a!==void 0&&(o=this._mediaSections[a]),this.setSessionExtmapAllowMixed(),o)o.planBReceive({offerRtpParameters:t,streamId:i,trackId:n}),this._replaceMediaSection(o);else{o=new ss.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n});const d=this._mediaSections.find(p=>p.closed);d?this._replaceMediaSection(o,d.mid):this._addMediaSection(o)}}pauseMediaSection(s){this._findMediaSection(s).pause()}resumeSendingMediaSection(s){this._findMediaSection(s).resume()}resumeReceivingMediaSection(s){this._findMediaSection(s).resume()}disableMediaSection(s){this._findMediaSection(s).disable()}closeMediaSection(s){const e=this._findMediaSection(s);return s===this._firstMid?(is.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",s),this.disableMediaSection(s),!1):(e.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(s,e){const t=this._findMediaSection(s);t.muxSimulcastStreams(e),this._replaceMediaSection(t)}planBStopReceiving({mid:s,offerRtpParameters:e}){const t=this._findMediaSection(s);t.planBStopReceiving({offerRtpParameters:e}),this._replaceMediaSection(t)}sendSctpAssociation({offerMediaObject:s}){const e=new ss.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:s});this._addMediaSection(e)}receiveSctpAssociation({oldDataChannelSpec:s=!1}={}){const e=new ss.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:s});this._addMediaSection(e)}getSdp(){return this._sdpObject.origin.sessionVersion++,zp.write(this._sdpObject)}_addMediaSection(s){this._firstMid||(this._firstMid=s.mid),this._mediaSections.push(s),this._midToIndex.set(s.mid,this._mediaSections.length-1),this._sdpObject.media.push(s.getObject()),this._regenerateBundleMids()}_replaceMediaSection(s,e){if(typeof e=="string"){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found for reuseMid '${e}'`);const i=this._mediaSections[t];this._mediaSections[t]=s,this._midToIndex.delete(i.mid),this._midToIndex.set(s.mid,t),this._sdpObject.media[t]=s.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(s.mid);if(t===void 0)throw new Error(`no media section found with mid '${s.mid}'`);this._mediaSections[t]=s,this._sdpObject.media[t]=s.getObject()}}_findMediaSection(s){const e=this._midToIndex.get(s);if(e===void 0)throw new Error(`no media section found with mid '${s}'`);return this._mediaSections[e]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(s=>!s.closed).map(s=>s.mid).join(" "))}}Ce.RemoteSdp=qp;var Ze={};Object.defineProperty(Ze,"__esModule",{value:!0});Ze.parse=Kp;const Vp=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Kp(r){const s=Vp.exec(r??"");return s?{spatialLayers:Number(s[1]),temporalLayers:Number(s[2])}:{spatialLayers:1,temporalLayers:1}}Object.defineProperty(Ls,"__esModule",{value:!0});Ls.Chrome111=void 0;const ht=se,Gp=te,fa=re,Xt=W,ns=Se,ma=Je,Qp=_r,Wp=ae,Yp=me,Xp=Ce,Jp=Ze,O=new Gp.Logger("Chrome111"),Zp="Chrome111",ga={OS:1024,MIS:1024};class en extends Yp.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new en}get name(){return Zp}close(){if(O.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){O.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const i=ht.parse(t.sdp),n=ns.extractRtpCapabilities({sdpObject:i});return Qp.addNackSupportForOpus(n),n}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return O.debug("getNativeSctpCapabilities()"),{numStreams:ga}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){this.assertNotClosed(),O.debug("run()"),this._direction=e,this._remoteSdp=new Xp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:Xt.getSendingRtpParameters("audio",c),video:Xt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Xt.getSendingRemoteRtpParameters("audio",c),video:Xt.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(O.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),O.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),O.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});O.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();O.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:a}){if(this.assertNotClosed(),this.assertSendDirection(),O.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){let w=1;for(const S of t){const x=S.scalabilityMode?(0,Jp.parse)(S.scalabilityMode).temporalLayers:3;x>w&&(w=x)}t.forEach((S,x)=>{S.rid=`r${x}`,S.scalabilityMode=`L1T${w}`})}const o=fa.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=Xt.reduceCodecs(o.codecs,n);const d=fa.clone(this._sendingRemoteRtpParametersByKind[e.kind]);d.codecs=Xt.reduceCodecs(d.codecs,n);const p=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});a&&a(l.sender);const c=await this._pc.createOffer();let h=ht.parse(c.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed(),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h}),O.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const u=l.mid;o.mid=u,h=ht.parse(this._pc.localDescription.sdp);const m=h.media[p.idx];if(o.rtcp.cname=ns.getCname({offerMediaObject:m}),!t)o.encodings=ma.getRtpEncodings({offerMediaObject:m});else if(t.length===1){const w=ma.getRtpEncodings({offerMediaObject:m});Object.assign(w[0],t[0]),o.encodings=w}else o.encodings=t;this._remoteSdp.send({offerMediaObject:m,reuseMid:p.reuseMid,offerRtpParameters:o,answerRtpParameters:d,codecOptions:i});const _={type:"answer",sdp:this._remoteSdp.getSdp()};return O.debug("send() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.set(u,l),{localId:u,rtpParameters:o,rtpSender:l.sender}}async stopSending(e){if(this.assertSendDirection(),O.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();O.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),O.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();O.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),O.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();O.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?O.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):O.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),O.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();O.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),O.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();O.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};O.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ga.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=ht.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),O.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;O.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const d of e){const{trackId:p,onRtpReceiver:l}=d;if(l){const c=i.get(p),h=this._pc.getTransceivers().find(u=>u.mid===c);if(!h)throw new Error("transceiver not found");l(h.receiver)}}let a=await this._pc.createAnswer();const o=ht.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);ns.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:ht.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),O.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(c)this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){O.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();O.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){O.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();O.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){O.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();O.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};O.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=ht.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ht.parse(this._pc.localDescription.sdp));const i=ns.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Wp.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ls.Chrome111=en;var Is={};Object.defineProperty(Is,"__esModule",{value:!0});Is.Chrome74=void 0;const Be=se,el=te,_a=re,Jt=W,as=Se,vi=Je,tl=_r,rl=ae,sl=me,il=Ce,nl=Ze,I=new el.Logger("Chrome74"),al="Chrome74",wa={OS:1024,MIS:1024};class tn extends sl.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new tn}get name(){return al}close(){if(I.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){I.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const i=Be.parse(t.sdp),n=as.extractRtpCapabilities({sdpObject:i});return tl.addNackSupportForOpus(n),n}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return I.debug("getNativeSctpCapabilities()"),{numStreams:wa}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){I.debug("run()"),this._direction=e,this._remoteSdp=new il.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:Jt.getSendingRtpParameters("audio",c),video:Jt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Jt.getSendingRemoteRtpParameters("audio",c),video:Jt.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(I.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),I.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),I.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});I.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertNotClosed(),this.assertSendDirection(),I.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((S,x)=>{S.rid=`r${x}`});const a=_a.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=Jt.reduceCodecs(a.codecs,n);const o=_a.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=Jt.reduceCodecs(o.codecs,n);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let l=await this._pc.createOffer(),c=Be.parse(l.sdp);c.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let h;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c});let u=!1;const m=(0,nl.parse)((t??[{}])[0].scalabilityMode);t&&t.length===1&&m.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(I.debug("send() | enabling legacy simulcast for VP9 SVC"),u=!0,c=Be.parse(l.sdp),h=c.media[d.idx],vi.addLegacySimulcast({offerMediaObject:h,numStreams:m.spatialLayers}),l={type:"offer",sdp:Be.write(c)}),I.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const _=p.mid;if(a.mid=_,c=Be.parse(this._pc.localDescription.sdp),h=c.media[d.idx],a.rtcp.cname=as.getCname({offerMediaObject:h}),!t)a.encodings=vi.getRtpEncodings({offerMediaObject:h});else if(t.length===1){let S=vi.getRtpEncodings({offerMediaObject:h});Object.assign(S[0],t[0]),u&&(S=[S[0]]),a.encodings=S}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const S of a.encodings)S.scalabilityMode?S.scalabilityMode=`L1T${m.temporalLayers}`:S.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:h,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:i});const w={type:"answer",sdp:this._remoteSdp.getSdp()};return I.debug("send() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setRemoteDescription(w),this._mapMidTransceiver.set(_,p),{localId:_,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),I.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();I.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();I.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();I.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?I.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):I.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();I.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();I.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};I.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%wa.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=Be.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),I.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;I.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=Be.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);as.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:Be.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),I.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(c)this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){I.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){I.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){I.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};I.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=Be.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Be.parse(this._pc.localDescription.sdp));const i=as.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new rl.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Is.Chrome74=tn;var Ms={};Object.defineProperty(Ms,"__esModule",{value:!0});Ms.Chrome70=void 0;const ke=se,ol=te,va=re,Zt=W,os=Se,yi=Je,cl=me,dl=Ce,pl=Ze,F=new ol.Logger("Chrome70"),ll="Chrome70",ya={OS:1024,MIS:1024};class rn extends cl.HandlerInterface{constructor(){super();f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new rn}get name(){return ll}close(){if(F.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){F.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const i=ke.parse(t.sdp);return os.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return F.debug("getNativeSctpCapabilities()"),{numStreams:ya}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){F.debug("run()"),this._direction=e,this._remoteSdp=new dl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:Zt.getSendingRtpParameters("audio",c),video:Zt.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:Zt.getSendingRemoteRtpParameters("audio",c),video:Zt.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(F.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){F.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(F.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});F.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();F.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),F.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=va.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=Zt.reduceCodecs(a.codecs,n);const o=va.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=Zt.reduceCodecs(o.codecs,n);const d=this._remoteSdp.getNextMediaSectionIdx(),p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let l=await this._pc.createOffer(),c=ke.parse(l.sdp);c.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let h;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),t&&t.length>1&&(F.debug("send() | enabling legacy simulcast"),c=ke.parse(l.sdp),h=c.media[d.idx],yi.addLegacySimulcast({offerMediaObject:h,numStreams:t.length}),l={type:"offer",sdp:ke.write(c)});let u=!1;const m=(0,pl.parse)((t??[{}])[0].scalabilityMode);if(t&&t.length===1&&m.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(F.debug("send() | enabling legacy simulcast for VP9 SVC"),u=!0,c=ke.parse(l.sdp),h=c.media[d.idx],yi.addLegacySimulcast({offerMediaObject:h,numStreams:m.spatialLayers}),l={type:"offer",sdp:ke.write(c)}),F.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),t){F.debug("send() | applying given encodings");const S=p.sender.getParameters();for(let x=0;x<(S.encodings??[]).length;++x){const v=S.encodings[x],g=t[x];if(!g)break;S.encodings[x]=Object.assign(v,g)}await p.sender.setParameters(S)}const _=p.mid;if(a.mid=_,c=ke.parse(this._pc.localDescription.sdp),h=c.media[d.idx],a.rtcp.cname=os.getCname({offerMediaObject:h}),a.encodings=yi.getRtpEncodings({offerMediaObject:h}),t)for(let S=0;S<a.encodings.length;++S)t[S]&&Object.assign(a.encodings[S],t[S]);if(u&&(a.encodings=[a.encodings[0]]),a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const S of a.encodings)S.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:h,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:i});const w={type:"answer",sdp:this._remoteSdp.getSdp()};return F.debug("send() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setRemoteDescription(w),this._mapMidTransceiver.set(_,p),{localId:_,rtpParameters:a,rtpSender:p.sender}}async stopSending(e){this.assertSendDirection(),F.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();F.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?F.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):F.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),F.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();F.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),F.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();F.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:a};F.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ya.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=ke.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),F.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;F.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ke.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);os.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:ke.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),F.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){this.assertRecvDirection();for(const n of e){F.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();F.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:i};F.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=ke.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ke.parse(this._pc.localDescription.sdp));const i=os.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ms.Chrome70=rn;var Os={},jt={};Object.defineProperty(jt,"__esModule",{value:!0});jt.getRtpEncodings=hl;jt.addLegacySimulcast=ul;function hl({offerMediaObject:r,track:s}){const e=new Set;for(const n of r.ssrcs??[]){if(n.attribute!=="msid")continue;if(n.value.split(" ")[1]===s.id){const o=n.id;e.add(o)}}if(e.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${s.id}]`);const t=new Map;for(const n of r.ssrcGroups??[]){if(n.semantics!=="FID")continue;let[a,o]=n.ssrcs.split(/\s+/);a=Number(a),o=Number(o),e.has(a)&&(e.delete(a),e.delete(o),t.set(a,o))}for(const n of e)t.set(n,null);const i=[];for(const[n,a]of t){const o={ssrc:n};a&&(o.rtx={ssrc:a}),i.push(o)}return i}function ul({offerMediaObject:r,track:s,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");let t,i,n;if(!(r.ssrcs??[]).find(c=>c.attribute!=="msid"?!1:c.value.split(" ")[1]===s.id?(t=c.id,n=c.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${s.id}]`);(r.ssrcGroups??[]).some(c=>{if(c.semantics!=="FID")return!1;const h=c.ssrcs.split(/\s+/);return Number(h[0])===t?(i=Number(h[1]),!0):!1});const o=r.ssrcs.find(c=>c.attribute==="cname"&&c.id===t);if(!o)throw new Error(`a=ssrc line with cname information not found [track.id:${s.id}]`);const d=o.value,p=[],l=[];for(let c=0;c<e;++c)p.push(t+c),i&&l.push(i+c);r.ssrcGroups=r.ssrcGroups??[],r.ssrcs=r.ssrcs??[],r.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(const c of p)r.ssrcs.push({id:c,attribute:"cname",value:d}),r.ssrcs.push({id:c,attribute:"msid",value:`${n} ${s.id}`});for(let c=0;c<l.length;++c){const h=p[c],u=l[c];r.ssrcs.push({id:u,attribute:"cname",value:d}),r.ssrcs.push({id:u,attribute:"msid",value:`${n} ${s.id}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${u}`})}}Object.defineProperty(Os,"__esModule",{value:!0});Os.Chrome67=void 0;const Ue=se,fl=te,ba=re,er=W,cs=Se,Sa=jt,ml=me,gl=Ce,U=new fl.Logger("Chrome67"),_l="Chrome67",Ra={OS:1024,MIS:1024};class sn extends ml.HandlerInterface{constructor(){super();f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_sendStream",new MediaStream);f(this,"_mapSendLocalIdRtpSender",new Map);f(this,"_nextSendLocalId",0);f(this,"_mapRecvLocalIdInfo",new Map);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new sn}get name(){return _l}close(){if(U.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){U.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const i=Ue.parse(t.sdp);return cs.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return U.debug("getNativeSctpCapabilities()"),{numStreams:Ra}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){U.debug("run()"),this._direction=e,this._remoteSdp=new gl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:er.getSendingRtpParameters("audio",c),video:er.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:er.getSendingRemoteRtpParameters("audio",c),video:er.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(U.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){U.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(U.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});U.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();U.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),U.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&U.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let a=await this._pc.createOffer(),o=Ue.parse(a.sdp);o.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let d;const p=ba.clone(this._sendingRtpParametersByKind[e.kind]);p.codecs=er.reduceCodecs(p.codecs);const l=ba.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(l.codecs=er.reduceCodecs(l.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(U.debug("send() | enabling simulcast"),o=Ue.parse(a.sdp),d=o.media.find(m=>m.type==="video"),Sa.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),a={type:"offer",sdp:Ue.write(o)}),U.debug("send() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a),o=Ue.parse(this._pc.localDescription.sdp),d=o.media.find(m=>m.type===e.kind),p.rtcp.cname=cs.getCname({offerMediaObject:d}),p.encodings=Sa.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let m=0;m<p.encodings.length;++m)t[m]&&Object.assign(p.encodings[m],t[m]);if(p.encodings.length>1&&p.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const m of p.encodings)m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:p,answerRtpParameters:l,codecOptions:i});const c={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const h=String(this._nextSendLocalId);this._nextSendLocalId++;const u=this._pc.getSenders().find(m=>m.track===e);return this._mapSendLocalIdRtpSender.set(h,u),{localId:h,rtpParameters:p,rtpSender:u}}async stopSending(e){this.assertSendDirection(),U.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const i=await this._pc.createOffer();U.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(a){if(this._sendStream.getTracks().length===0){U.warn("stopSending() | ignoring expected error due no sending tracks: %s",a.toString());return}throw a}if(this._pc.signalingState==="stable")return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?U.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):U.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.track;await i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),U.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{o<=t?a.active=!0:a.active=!1}),await i.setParameters(n)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),U.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...t}}),await i.setParameters(n)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:a};U.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ra.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=Ue.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),U.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:p,rtpParameters:l,streamId:c}=o;U.debug("receive() [trackId:%s, kind:%s]",d,p);const h=p;this._remoteSdp.receive({mid:h,kind:p,offerRtpParameters:l,streamId:c??l.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=Ue.parse(n.sdp);for(const o of e){const{kind:d,rtpParameters:p}=o,l=d,c=a.media.find(h=>String(h.mid)===l);cs.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:Ue.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),U.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{kind:d,trackId:p,rtpParameters:l}=o,c=p,h=d,u=this._pc.getReceivers().find(m=>m.track&&m.track.id===c);if(!u)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(c,{mid:h,rtpParameters:l,rtpReceiver:u}),t.push({localId:c,track:u.track,rtpReceiver:u})}return t}async stopReceiving(e){this.assertRecvDirection();for(const n of e){U.debug("stopReceiving() [localId:%s]",n);const{mid:a,rtpParameters:o}=this._mapRecvLocalIdInfo.get(n)??{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:a,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();U.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)??{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:i};U.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=Ue.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ue.parse(this._pc.localDescription.sdp));const i=cs.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Os.Chrome67=sn;var As={};Object.defineProperty(As,"__esModule",{value:!0});As.Chrome55=void 0;const ze=se,wl=te,Ar=ae,Ca=re,tr=W,ds=Se,Ta=jt,vl=me,yl=Ce,V=new wl.Logger("Chrome55"),bl="Chrome55",Da={OS:1024,MIS:1024};class nn extends vl.HandlerInterface{constructor(){super();f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_sendStream",new MediaStream);f(this,"_mapSendLocalIdTrack",new Map);f(this,"_nextSendLocalId",0);f(this,"_mapRecvLocalIdInfo",new Map);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new nn}get name(){return bl}close(){if(V.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){V.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const i=ze.parse(t.sdp);return ds.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return V.debug("getNativeSctpCapabilities()"),{numStreams:Da}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){V.debug("run()"),this._direction=e,this._remoteSdp=new yl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:tr.getSendingRtpParameters("audio",c),video:tr.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:tr.getSendingRemoteRtpParameters("audio",c),video:tr.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(V.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){V.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(V.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});V.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};V.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};V.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();V.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),V.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&V.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let a=await this._pc.createOffer(),o=ze.parse(a.sdp);o.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let d;const p=Ca.clone(this._sendingRtpParametersByKind[e.kind]);p.codecs=tr.reduceCodecs(p.codecs);const l=Ca.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(l.codecs=tr.reduceCodecs(l.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(V.debug("send() | enabling simulcast"),o=ze.parse(a.sdp),d=o.media.find(u=>u.type==="video"),Ta.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),a={type:"offer",sdp:ze.write(o)}),V.debug("send() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a),o=ze.parse(this._pc.localDescription.sdp),d=o.media.find(u=>u.type===e.kind),p.rtcp.cname=ds.getCname({offerMediaObject:d}),p.encodings=Ta.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let u=0;u<p.encodings.length;++u)t[u]&&Object.assign(p.encodings[u],t[u]);if(p.encodings.length>1&&p.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const u of p.encodings)u.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:p,answerRtpParameters:l,codecOptions:i});const c={type:"answer",sdp:this._remoteSdp.getSdp()};V.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const h=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(h,e),{localId:h,rtpParameters:p}}async stopSending(e){this.assertSendDirection(),V.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const i=await this._pc.createOffer();V.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(a){if(this._sendStream.getTracks().length===0){V.warn("stopSending() | ignoring expected error due no sending tracks: %s",a.toString());return}throw a}if(this._pc.signalingState==="stable")return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};V.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new Ar.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new Ar.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new Ar.UnsupportedError("not supported")}async getSenderStats(e){throw new Ar.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:a};V.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Da.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=ze.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),V.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};V.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:p,rtpParameters:l,streamId:c}=o;V.debug("receive() [trackId:%s, kind:%s]",d,p);const h=p;this._remoteSdp.receive({mid:h,kind:p,offerRtpParameters:l,streamId:c??l.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};V.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=ze.parse(n.sdp);for(const o of e){const{kind:d,rtpParameters:p}=o,l=d,c=a.media.find(h=>String(h.mid)===l);ds.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:ze.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),V.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{kind:d,trackId:p,rtpParameters:l}=o,c=d,h=p,u=o.streamId??l.rtcp.cname,_=this._pc.getRemoteStreams().find(w=>w.id===u).getTrackById(h);if(!_)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(h,{mid:c,rtpParameters:l}),t.push({localId:h,track:_})}return t}async stopReceiving(e){this.assertRecvDirection();for(const n of e){V.debug("stopReceiving() [localId:%s]",n);const{mid:a,rtpParameters:o}=this._mapRecvLocalIdInfo.get(n)??{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:a,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};V.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();V.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new Ar.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:i};V.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};V.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=ze.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}V.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ze.parse(this._pc.localDescription.sdp));const i=ds.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}As.Chrome55=nn;var Ns={};Object.defineProperty(Ns,"__esModule",{value:!0});Ns.Firefox120=void 0;const ut=se,Sl=te,ka=ae,Ea=re,rr=W,ps=Se,Pa=Je,Rl=me,Cl=Ce,Tl=Ze,N=new Sl.Logger("Firefox120"),Dl="Firefox120",xa={OS:16,MIS:2048};class an extends Rl.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new an}get name(){return Dl}close(){if(N.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){N.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const n=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(n,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const a=await e.createOffer();try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}const o=ut.parse(a.sdp);return ps.extractRtpCapabilities({sdpObject:o})}catch(a){try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}throw a}}async getNativeSctpCapabilities(){return N.debug("getNativeSctpCapabilities()"),{numStreams:xa}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){this.assertNotClosed(),N.debug("run()"),this._direction=e,this._remoteSdp=new Cl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:rr.getSendingRtpParameters("audio",c),video:rr.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:rr.getSendingRemoteRtpParameters("audio",c),video:rr.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(N.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new ka.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),N.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});N.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();N.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:a}){this.assertNotClosed(),this.assertSendDirection(),N.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((w,S)=>{w.rid=`r${S}`});const o=Ea.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=rr.reduceCodecs(o.codecs,n);const d=Ea.clone(this._sendingRemoteRtpParametersByKind[e.kind]);d.codecs=rr.reduceCodecs(d.codecs,n);const p=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});a&&a(p.sender);const l=await this._pc.createOffer();let c=ut.parse(l.sdp);c.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed(),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c});const h=(0,Tl.parse)((t??[{}])[0].scalabilityMode);N.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const u=p.mid;o.mid=u,c=ut.parse(this._pc.localDescription.sdp);const m=c.media[c.media.length-1];if(o.rtcp.cname=ps.getCname({offerMediaObject:m}),!t)o.encodings=Pa.getRtpEncodings({offerMediaObject:m});else if(t.length===1){const w=Pa.getRtpEncodings({offerMediaObject:m});Object.assign(w[0],t[0]),o.encodings=w}else o.encodings=t;if(o.encodings.length>1&&(o.codecs[0].mimeType.toLowerCase()==="video/vp8"||o.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const w of o.encodings)w.scalabilityMode?w.scalabilityMode=`L1T${h.temporalLayers}`:w.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:m,offerRtpParameters:o,answerRtpParameters:d,codecOptions:i});const _={type:"answer",sdp:this._remoteSdp.getSdp()};return N.debug("send() | calling pc.setRemoteDescription() [answer:%o]",_),await this._pc.setRemoteDescription(_),this._mapMidTransceiver.set(u,p),{localId:u,rtpParameters:o,rtpSender:p.sender}}async stopSending(e){if(this.assertSendDirection(),N.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const i=await this._pc.createOffer();N.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),N.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();N.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),N.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=await this._pc.createOffer();N.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?N.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):N.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),N.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();N.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),N.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();N.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};N.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%xa.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=ut.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),N.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};N.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;N.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const d of e){const{trackId:p,onRtpReceiver:l}=d;if(l){const c=i.get(p),h=this._pc.getTransceivers().find(u=>u.mid===c);if(!h)throw new Error("transceiver not found");l(h.receiver)}}let a=await this._pc.createAnswer();const o=ut.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);ps.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h}),a={type:"answer",sdp:ut.write(o)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:o}),N.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){N.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();N.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){N.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();N.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){N.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();N.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};N.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};N.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=ut.parse(h.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:u})}N.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ut.parse(this._pc.localDescription.sdp));const i=ps.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new ka.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ns.Firefox120=an;var js={};Object.defineProperty(js,"__esModule",{value:!0});js.Firefox60=void 0;const ft=se,kl=te,La=ae,bi=re,sr=W,ls=Se,Ia=Je,El=me,Pl=Ce,xl=Ze,j=new kl.Logger("Firefox60"),Ll="Firefox60",Ma={OS:16,MIS:2048};class on extends El.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new on}get name(){return Ll}close(){if(j.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){j.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const n=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const a=e.addTransceiver(n,{direction:"sendrecv"}),o=a.sender.getParameters(),d=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];o.encodings=d,await a.sender.setParameters(o);const p=await e.createOffer();try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}const l=ft.parse(p.sdp);return ls.extractRtpCapabilities({sdpObject:l})}catch(a){try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}throw a}}async getNativeSctpCapabilities(){return j.debug("getNativeSctpCapabilities()"),{numStreams:Ma}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){this.assertNotClosed(),j.debug("run()"),this._direction=e,this._remoteSdp=new Pl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:sr.getSendingRtpParameters("audio",c),video:sr.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:sr.getSendingRemoteRtpParameters("audio",c),video:sr.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(j.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new La.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),j.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});j.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();j.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertNotClosed(),this.assertSendDirection(),j.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=bi.clone(t),t.forEach((_,w)=>{_.rid=`r${w}`}),t.reverse());const a=bi.clone(this._sendingRtpParametersByKind[e.kind]);a.codecs=sr.reduceCodecs(a.codecs,n);const o=bi.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=sr.reduceCodecs(o.codecs,n);const d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const _=d.sender.getParameters();_.encodings=t,await d.sender.setParameters(_)}const p=await this._pc.createOffer();let l=ft.parse(p.sdp);l.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed(),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:l});const c=(0,xl.parse)((t??[{}])[0].scalabilityMode);j.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const h=d.mid;a.mid=h,l=ft.parse(this._pc.localDescription.sdp);const u=l.media[l.media.length-1];if(a.rtcp.cname=ls.getCname({offerMediaObject:u}),!t)a.encodings=Ia.getRtpEncodings({offerMediaObject:u});else if(t.length===1){const _=Ia.getRtpEncodings({offerMediaObject:u});Object.assign(_[0],t[0]),a.encodings=_}else a.encodings=t.reverse();if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const _ of a.encodings)_.scalabilityMode?_.scalabilityMode=`L1T${c.temporalLayers}`:_.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,offerRtpParameters:a,answerRtpParameters:o,codecOptions:i});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return j.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(h,d),{localId:h,rtpParameters:a,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),j.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const i=await this._pc.createOffer();j.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),j.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();j.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),j.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=await this._pc.createOffer();j.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?j.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):j.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),j.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");const n=i.sender.getParameters();t=n.encodings.length-1-t,n.encodings.forEach((d,p)=>{p>=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();j.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),j.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();j.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};j.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ma.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=ft.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:c}),j.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;j.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=ft.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);ls.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h}),a={type:"answer",sdp:ft.write(o)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:o}),j.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){j.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();j.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){j.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();j.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){j.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();j.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};j.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=ft.parse(h.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:u})}j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ft.parse(this._pc.localDescription.sdp));const i=ls.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new La.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}js.Firefox60=on;var $s={};Object.defineProperty($s,"__esModule",{value:!0});$s.Safari12=void 0;const He=se,Il=te,Oa=re,ir=W,hs=Se,Aa=Je,Ml=_r,Ol=ae,Al=me,Nl=Ce,jl=Ze,M=new Il.Logger("Safari12"),$l="Safari12",Na={OS:1024,MIS:1024};class cn extends Al.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new cn}get name(){return $l}close(){if(M.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){M.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const i=He.parse(t.sdp),n=hs.extractRtpCapabilities({sdpObject:i});return Ml.addNackSupportForOpus(n),n}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return M.debug("getNativeSctpCapabilities()"),{numStreams:Na}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){this.assertNotClosed(),M.debug("run()"),this._direction=e,this._remoteSdp=new Nl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:ir.getSendingRtpParameters("audio",c),video:ir.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ir.getSendingRemoteRtpParameters("audio",c),video:ir.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(M.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),M.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),M.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});M.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();M.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:a}){this.assertNotClosed(),this.assertSendDirection(),M.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const o=Oa.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=ir.reduceCodecs(o.codecs,n);const d=Oa.clone(this._sendingRemoteRtpParametersByKind[e.kind]);d.codecs=ir.reduceCodecs(d.codecs,n);const p=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});a&&a(l.sender);let c=await this._pc.createOffer(),h=He.parse(c.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h});const m=(0,jl.parse)((t??[{}])[0].scalabilityMode);t&&t.length>1&&(M.debug("send() | enabling legacy simulcast"),h=He.parse(c.sdp),u=h.media[p.idx],Aa.addLegacySimulcast({offerMediaObject:u,numStreams:t.length}),c={type:"offer",sdp:He.write(h)}),M.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const _=l.mid;if(o.mid=_,h=He.parse(this._pc.localDescription.sdp),u=h.media[p.idx],o.rtcp.cname=hs.getCname({offerMediaObject:u}),o.encodings=Aa.getRtpEncodings({offerMediaObject:u}),t)for(let S=0;S<o.encodings.length;++S)t[S]&&Object.assign(o.encodings[S],t[S]);if(o.encodings.length>1&&(o.codecs[0].mimeType.toLowerCase()==="video/vp8"||o.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const S of o.encodings)S.scalabilityMode?S.scalabilityMode=`L1T${m.temporalLayers}`:S.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:p.reuseMid,offerRtpParameters:o,answerRtpParameters:d,codecOptions:i});const w={type:"answer",sdp:this._remoteSdp.getSdp()};return M.debug("send() | calling pc.setRemoteDescription() [answer:%o]",w),await this._pc.setRemoteDescription(w),this._mapMidTransceiver.set(_,l),{localId:_,rtpParameters:o,rtpSender:l.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;M.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();M.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),M.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();M.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),M.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=await this._pc.createOffer();M.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?M.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):M.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),M.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();M.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),M.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();M.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};M.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Na.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=He.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),M.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;M.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const d of e){const{trackId:p,onRtpReceiver:l}=d;if(l){const c=i.get(p),h=this._pc.getTransceivers().find(u=>u.mid===c);if(!h)throw new Error("transceiver not found");l(h.receiver)}}let a=await this._pc.createAnswer();const o=He.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);hs.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:He.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),M.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(!c)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){M.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();M.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){M.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();M.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){M.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();M.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};M.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=He.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=He.parse(this._pc.localDescription.sdp));const i=hs.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Ol.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}$s.Safari12=cn;var Fs={};Object.defineProperty(Fs,"__esModule",{value:!0});Fs.Safari11=void 0;const qe=se,Fl=te,ja=re,nr=W,us=Se,$a=jt,Bl=me,Ul=Ce,z=new Fl.Logger("Safari11"),zl="Safari11",Fa={OS:1024,MIS:1024};class dn extends Bl.HandlerInterface{constructor(){super();f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_sendStream",new MediaStream);f(this,"_mapSendLocalIdRtpSender",new Map);f(this,"_nextSendLocalId",0);f(this,"_mapRecvLocalIdInfo",new Map);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new dn}get name(){return zl}close(){if(z.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){z.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const i=qe.parse(t.sdp);return us.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return z.debug("getNativeSctpCapabilities()"),{numStreams:Fa}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){z.debug("run()"),this._direction=e,this._remoteSdp=new Ul.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:nr.getSendingRtpParameters("audio",c),video:nr.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:nr.getSendingRemoteRtpParameters("audio",c),video:nr.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(z.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){z.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(z.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});z.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();z.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),z.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&z.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let a=await this._pc.createOffer(),o=qe.parse(a.sdp);o.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let d;const p=ja.clone(this._sendingRtpParametersByKind[e.kind]);p.codecs=nr.reduceCodecs(p.codecs);const l=ja.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(l.codecs=nr.reduceCodecs(l.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(z.debug("send() | enabling simulcast"),o=qe.parse(a.sdp),d=o.media.find(m=>m.type==="video"),$a.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),a={type:"offer",sdp:qe.write(o)}),z.debug("send() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a),o=qe.parse(this._pc.localDescription.sdp),d=o.media.find(m=>m.type===e.kind),p.rtcp.cname=us.getCname({offerMediaObject:d}),p.encodings=$a.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let m=0;m<p.encodings.length;++m)t[m]&&Object.assign(p.encodings[m],t[m]);if(p.encodings.length>1&&p.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const m of p.encodings)m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:p,answerRtpParameters:l,codecOptions:i});const c={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const h=String(this._nextSendLocalId);this._nextSendLocalId++;const u=this._pc.getSenders().find(m=>m.track===e);return this._mapSendLocalIdRtpSender.set(h,u),{localId:h,rtpParameters:p,rtpSender:u}}async stopSending(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const i=await this._pc.createOffer();z.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(a){if(this._sendStream.getTracks().length===0){z.warn("stopSending() | ignoring expected error due no sending tracks: %s",a.toString());return}throw a}if(this._pc.signalingState==="stable")return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?z.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):z.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.track;await i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),z.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{o<=t?a.active=!0:a.active=!1}),await i.setParameters(n)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),z.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...t}}),await i.setParameters(n)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};z.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Fa.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=qe.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),z.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};z.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:p,rtpParameters:l,streamId:c}=o;z.debug("receive() [trackId:%s, kind:%s]",d,p);const h=p;this._remoteSdp.receive({mid:h,kind:p,offerRtpParameters:l,streamId:c??l.rtcp.cname,trackId:d})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const a=qe.parse(n.sdp);for(const o of e){const{kind:d,rtpParameters:p}=o,l=d,c=a.media.find(h=>String(h.mid)===l);us.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:qe.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),z.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const o of e){const{kind:d,trackId:p,rtpParameters:l}=o,c=d,h=p,u=this._pc.getReceivers().find(m=>m.track&&m.track.id===h);if(!u)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(h,{mid:c,rtpParameters:l,rtpReceiver:u}),t.push({localId:h,track:u.track,rtpReceiver:u})}return t}async stopReceiving(e){this.assertRecvDirection();for(const n of e){z.debug("stopReceiving() [localId:%s]",n);const{mid:a,rtpParameters:o}=this._mapRecvLocalIdInfo.get(n)??{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:a,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();z.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)??{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async pauseReceiving(e){}async resumeReceiving(e){}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};z.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};z.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=qe.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}z.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=qe.parse(this._pc.localDescription.sdp));const i=us.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Fs.Safari11=dn;var Bs={},Us={};Object.defineProperty(Us,"__esModule",{value:!0});Us.getCapabilities=Hl;Us.mangleRtpParameters=ql;const Io=re;function Hl(){const r=RTCRtpReceiver.getCapabilities(),s=Io.clone(r);for(const e of s.codecs??[]){if(e.channels=e.numChannels,delete e.numChannels,e.mimeType=e.mimeType??`${e.kind}/${e.name}`,e.parameters){const t=e.parameters;t.apt&&(t.apt=Number(t.apt)),t["packetization-mode"]&&(t["packetization-mode"]=Number(t["packetization-mode"]))}for(const t of e.rtcpFeedback??[])t.parameter||(t.parameter="")}return s}function ql(r){const s=Io.clone(r);s.mid&&(s.muxId=s.mid,delete s.mid);for(const e of s.codecs)e.channels&&(e.numChannels=e.channels,delete e.channels),e.mimeType&&!e.name&&(e.name=e.mimeType.split("/")[1]),delete e.mimeType;return s}Object.defineProperty(Bs,"__esModule",{value:!0});Bs.Edge11=void 0;const Vl=te,Si=ae,fs=re,Ri=W,Ci=Us,Kl=me,G=new Vl.Logger("Edge11"),Gl="Edge11";class pn extends Kl.HandlerInterface{constructor(){super();f(this,"_sendingRtpParametersByKind");f(this,"_remoteIceParameters");f(this,"_remoteIceCandidates");f(this,"_remoteDtlsParameters");f(this,"_iceGatherer");f(this,"_iceTransport");f(this,"_dtlsTransport");f(this,"_rtpSenders",new Map);f(this,"_rtpReceivers",new Map);f(this,"_nextSendLocalId",0);f(this,"_cname");f(this,"_transportReady",!1)}static createFactory(){return()=>new pn}get name(){return Gl}close(){G.debug("close()");try{this._iceGatherer.close()}catch{}try{this._iceTransport.stop()}catch{}try{this._dtlsTransport.stop()}catch{}for(const e of this._rtpSenders.values())try{e.stop()}catch{}for(const e of this._rtpReceivers.values())try{e.stop()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){return G.debug("getNativeRtpCapabilities()"),Ci.getCapabilities()}async getNativeSctpCapabilities(){return G.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){G.debug("run()"),this._sendingRtpParametersByKind={audio:Ri.getSendingRtpParameters("audio",c),video:Ri.getSendingRtpParameters("video",c)},this._remoteIceParameters=t,this._remoteIceCandidates=i,this._remoteDtlsParameters=n,this._cname=`CNAME-${fs.generateRandomNumber()}`,this.setIceGatherer({iceServers:o,iceTransportPolicy:d}),this.setIceTransport(),this.setDtlsTransport()}async updateIceServers(e){throw new Si.UnsupportedError("not supported")}async restartIce(e){if(G.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){G.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){G.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),G.debug("send() | calling new RTCRtpSender()");const a=new RTCRtpSender(e,this._dtlsTransport),o=fs.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=Ri.reduceCodecs(o.codecs,n);const d=o.codecs.some(c=>/.+\/rtx$/i.test(c.mimeType));t||(t=[{}]);for(const c of t)c.ssrc=fs.generateRandomNumber(),d&&(c.rtx={ssrc:fs.generateRandomNumber()});o.encodings=t,o.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const p=Ci.mangleRtpParameters(o);G.debug("send() | calling rtpSender.send() [params:%o]",p),await a.send(p);const l=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(l,a),{localId:l,rtpParameters:o,rtpSender:a}}async stopSending(e){G.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{G.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(i){throw G.warn("stopSending() | rtpSender.stop() failed:%o",i),i}}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){t?G.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):G.debug("replaceTrack() [localId:%s, no track]",e);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");i.setTrack(t)}async setMaxSpatialLayer(e,t){G.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{o<=t?a.active=!0:a.active=!1}),await i.setParameters(n)}async setRtpEncodingParameters(e,t){G.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");const n=i.getParameters();n.encodings.forEach((a,o)=>{n.encodings[o]={...a,...t}}),await i.setParameters(n)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new Si.UnsupportedError("not implemented")}async receive(e){const t=[];for(const i of e){const{trackId:n,kind:a}=i;G.debug("receive() [trackId:%s, kind:%s]",n,a)}this._transportReady||await this.setupTransport({localDtlsRole:"server"});for(const i of e){const{trackId:n,kind:a,rtpParameters:o}=i;G.debug("receive() | calling new RTCRtpReceiver()");const d=new RTCRtpReceiver(this._dtlsTransport,a);d.addEventListener("error",c=>{G.error('rtpReceiver "error" event [event:%o]',c)});const p=Ci.mangleRtpParameters(o);G.debug("receive() | calling rtpReceiver.receive() [params:%o]",p),await d.receive(p);const l=n;this._rtpReceivers.set(l,d),t.push({localId:l,track:d.track,rtpReceiver:d})}return t}async stopReceiving(e){for(const t of e){G.debug("stopReceiving() [localId:%s]",t);const i=this._rtpReceivers.get(t);if(!i)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(t);try{G.debug("stopReceiving() | calling rtpReceiver.stop()"),i.stop()}catch(n){G.warn("stopReceiving() | rtpReceiver.stop() failed:%o",n)}}}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new Si.UnsupportedError("not implemented")}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const i=new RTCIceGatherer({iceServers:e??[],gatherPolicy:t??"all"});i.addEventListener("error",n=>{G.error('iceGatherer "error" event [event:%o]',n)});try{i.gather()}catch(n){G.debug("setIceGatherer() | iceGatherer.gather() failed: %s",n.toString())}this._iceGatherer=i}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("candidatepairchange",t=>{G.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{G.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{G.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{G.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}async setupTransport({localDtlsRole:e}){G.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:t},i,n)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const i of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(i);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(i=>i.algorithm==="sha-256"||i.algorithm==="sha-384"||i.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}Bs.Edge11=pn;var zs={};Object.defineProperty(zs,"__esModule",{value:!0});zs.ReactNativeUnifiedPlan=void 0;const Ve=se,Ql=te,Ba=re,ar=W,ms=Se,Ti=Je,Wl=_r,Yl=ae,Xl=me,Jl=Ce,Zl=Ze,P=new Ql.Logger("ReactNativeUnifiedPlan"),eh="ReactNativeUnifiedPlan",Ua={OS:1024,MIS:1024};class ln extends Xl.HandlerInterface{constructor(){super();f(this,"_closed",!1);f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_mapMidTransceiver",new Map);f(this,"_sendStream",new MediaStream);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new ln}get name(){return eh}close(){if(P.debug("close()"),!this._closed){if(this._closed=!0,this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){P.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const i=Ve.parse(t.sdp),n=ms.extractRtpCapabilities({sdpObject:i});return Wl.addNackSupportForOpus(n),n}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return P.debug("getNativeSctpCapabilities()"),{numStreams:Ua}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){this.assertNotClosed(),P.debug("run()"),this._direction=e,this._remoteSdp=new Jl.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a}),this._sendingRtpParametersByKind={audio:ar.getSendingRtpParameters("audio",c),video:ar.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:ar.getSendingRemoteRtpParameters("audio",c),video:ar.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(P.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),P.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),P.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});P.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:a}){this.assertNotClosed(),this.assertSendDirection(),P.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((x,v)=>{x.rid=`r${v}`});const o=Ba.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=ar.reduceCodecs(o.codecs,n);const d=Ba.clone(this._sendingRemoteRtpParametersByKind[e.kind]);d.codecs=ar.reduceCodecs(d.codecs,n);const p=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});a&&a(l.sender);let c=await this._pc.createOffer(),h=Ve.parse(c.sdp);h.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let u;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:h});let m=!1;const _=(0,Zl.parse)((t??[{}])[0].scalabilityMode);t&&t.length===1&&_.spatialLayers>1&&o.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(P.debug("send() | enabling legacy simulcast for VP9 SVC"),m=!0,h=Ve.parse(c.sdp),u=h.media[p.idx],Ti.addLegacySimulcast({offerMediaObject:u,numStreams:_.spatialLayers}),c={type:"offer",sdp:Ve.write(h)}),P.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);let w=l.mid??void 0;if(w||P.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),o.mid=w,h=Ve.parse(this._pc.localDescription.sdp),u=h.media[p.idx],o.rtcp.cname=ms.getCname({offerMediaObject:u}),!t)o.encodings=Ti.getRtpEncodings({offerMediaObject:u});else if(t.length===1){let x=Ti.getRtpEncodings({offerMediaObject:u});Object.assign(x[0],t[0]),m&&(x=[x[0]]),o.encodings=x}else o.encodings=t;if(o.encodings.length>1&&(o.codecs[0].mimeType.toLowerCase()==="video/vp8"||o.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const x of o.encodings)x.scalabilityMode?x.scalabilityMode=`L1T${_.temporalLayers}`:x.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:p.reuseMid,offerRtpParameters:o,answerRtpParameters:d,codecOptions:i});const S={type:"answer",sdp:this._remoteSdp.getSdp()};return P.debug("send() | calling pc.setRemoteDescription() [answer:%o]",S),await this._pc.setRemoteDescription(S),w||(w=l.mid,o.mid=w),this._mapMidTransceiver.set(w,l),{localId:w,rtpParameters:o,rtpSender:l.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;P.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();P.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();P.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();P.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?P.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):P.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{p<=t?d.active=!0:d.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();P.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((d,p)=>{n.encodings[p]={...d,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const a=await this._pc.createOffer();P.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a);const o={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:a};P.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ua.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=Ve.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),P.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c,streamId:h}=d;P.debug("receive() [trackId:%s, kind:%s]",p,l);const u=c.mid??String(this._mapMidTransceiver.size);i.set(p,u),this._remoteSdp.receive({mid:u,kind:l,offerRtpParameters:c,streamId:h??c.rtcp.cname,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const d of e){const{trackId:p,onRtpReceiver:l}=d;if(l){const c=i.get(p),h=this._pc.getTransceivers().find(u=>u.mid===c);if(!h)throw new Error("transceiver not found");l(h.receiver)}}let a=await this._pc.createAnswer();const o=Ve.parse(a.sdp);for(const d of e){const{trackId:p,rtpParameters:l}=d,c=i.get(p),h=o.media.find(u=>String(u.mid)===c);ms.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:Ve.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),P.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{trackId:p}=d,l=i.get(p),c=this._pc.getTransceivers().find(h=>h.mid===l);if(c)this._mapMidTransceiver.set(l,c),t.push({localId:l,track:c.receiver.track,rtpReceiver:c.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){P.debug("stopReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(a.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){P.debug("pauseReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){P.debug("resumeReceiving() [localId:%s]",n);const a=this._mapMidTransceiver.get(n);if(!a)throw new Error("associated RTCRtpTransceiver not found");a.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:i};P.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const c={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=Ve.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ve.parse(this._pc.localDescription.sdp));const i=ms.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Yl.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}zs.ReactNativeUnifiedPlan=ln;var Hs={};Object.defineProperty(Hs,"__esModule",{value:!0});Hs.ReactNative=void 0;const Ke=se,th=te,Nr=ae,Di=re,or=W,gs=Se,za=jt,rh=me,sh=Ce,q=new th.Logger("ReactNative"),ih="ReactNative",Ha={OS:1024,MIS:1024};class hn extends rh.HandlerInterface{constructor(){super();f(this,"_direction");f(this,"_remoteSdp");f(this,"_sendingRtpParametersByKind");f(this,"_sendingRemoteRtpParametersByKind");f(this,"_forcedLocalDtlsRole");f(this,"_pc");f(this,"_sendStream",new MediaStream);f(this,"_mapSendLocalIdTrack",new Map);f(this,"_nextSendLocalId",0);f(this,"_mapRecvLocalIdInfo",new Map);f(this,"_hasDataChannelMediaSection",!1);f(this,"_nextSendSctpStreamId",0);f(this,"_transportReady",!1)}static createFactory(){return()=>new hn}get name(){return ih}close(){if(q.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){q.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const i=Ke.parse(t.sdp);return gs.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return q.debug("getNativeSctpCapabilities()"),{numStreams:Ha}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,extendedRtpCapabilities:c}){q.debug("run()"),this._direction=e,this._remoteSdp=new sh.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,planB:!0}),this._sendingRtpParametersByKind={audio:or.getSendingRtpParameters("audio",c),video:or.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:or.getSendingRemoteRtpParameters("audio",c),video:or.getSendingRemoteRtpParameters("video",c)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o??[],iceTransportPolicy:d??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...p},l),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",h=>{this.emit("@icecandidateerror",h)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(q.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){q.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(q.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});q.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};q.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};q.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();q.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertSendDirection(),q.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&q.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let a=await this._pc.createOffer(),o=Ke.parse(a.sdp);o.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();let d;const p=Di.clone(this._sendingRtpParametersByKind[e.kind]);p.codecs=or.reduceCodecs(p.codecs);const l=Di.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(l.codecs=or.reduceCodecs(l.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(q.debug("send() | enabling simulcast"),o=Ke.parse(a.sdp),d=o.media.find(u=>u.type==="video"),za.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),a={type:"offer",sdp:Ke.write(o)}),q.debug("send() | calling pc.setLocalDescription() [offer:%o]",a),await this._pc.setLocalDescription(a),o=Ke.parse(this._pc.localDescription.sdp),d=o.media.find(u=>u.type===e.kind),p.rtcp.cname=gs.getCname({offerMediaObject:d}),p.encodings=za.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let u=0;u<p.encodings.length;++u)t[u]&&Object.assign(p.encodings[u],t[u]);if(p.encodings.length>1&&(p.codecs[0].mimeType.toLowerCase()==="video/vp8"||p.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const u of p.encodings)u.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:p,answerRtpParameters:l,codecOptions:i});const c={type:"answer",sdp:this._remoteSdp.getSdp()};q.debug("send() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setRemoteDescription(c);const h=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(h,e),{localId:h,rtpParameters:p}}async stopSending(e){this.assertSendDirection(),q.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const i=await this._pc.createOffer();q.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(a){if(this._sendStream.getTracks().length===0){q.warn("stopSending() | ignoring expected error due no sending tracks: %s",a.toString());return}throw a}if(this._pc.signalingState==="stable")return;const n={type:"answer",sdp:this._remoteSdp.getSdp()};q.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new Nr.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new Nr.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new Nr.UnsupportedError("not implemented")}async getSenderStats(e){throw new Nr.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:a};q.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ha.MIS,!this._hasDataChannelMediaSection){const l=await this._pc.createOffer(),c=Ke.parse(l.sdp),h=c.media.find(m=>m.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:c}),q.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const u={type:"answer",sdp:this._remoteSdp.getSdp()};q.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),await this._pc.setRemoteDescription(u),this._hasDataChannelMediaSection=!0}const p={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:p}}async receive(e){this.assertRecvDirection();const t=[],i=new Map;for(const d of e){const{trackId:p,kind:l,rtpParameters:c}=d;q.debug("receive() [trackId:%s, kind:%s]",p,l);const h=l;let u=d.streamId??c.rtcp.cname;q.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),u+=`-hack-${Di.generateRandomNumber()}`,i.set(p,u),this._remoteSdp.receive({mid:h,kind:l,offerRtpParameters:c,streamId:u,trackId:p})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};q.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer();const o=Ke.parse(a.sdp);for(const d of e){const{kind:p,rtpParameters:l}=d,c=p,h=o.media.find(u=>String(u.mid)===c);gs.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:Ke.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),q.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(const d of e){const{kind:p,trackId:l,rtpParameters:c}=d,h=l,u=p,m=i.get(l),w=this._pc.getRemoteStreams().find(S=>S.id===m).getTrackById(h);if(!w)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(h,{mid:u,rtpParameters:c}),t.push({localId:h,track:w})}return t}async stopReceiving(e){this.assertRecvDirection();for(const n of e){q.debug("stopReceiving() [localId:%s]",n);const{mid:a,rtpParameters:o}=this._mapRecvLocalIdInfo.get(n)??{};this._mapRecvLocalIdInfo.delete(n),this._remoteSdp.planBStopReceiving({mid:a,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};q.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();q.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new Nr.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertRecvDirection();const{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,p={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:i};q.debug("receiveDataChannel() [options:%o]",p);const l=this._pc.createDataChannel(t,p);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const c={type:"offer",sdp:this._remoteSdp.getSdp()};q.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",c),await this._pc.setRemoteDescription(c);const h=await this._pc.createAnswer();if(!this._transportReady){const u=Ke.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:u})}q.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Ke.parse(this._pc.localDescription.sdp));const i=gs.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,a)=>{this.safeEmit("@connect",{dtlsParameters:i},n,a)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Hs.ReactNative=hn;Object.defineProperty(At,"__esModule",{value:!0});At.Device=void 0;At.detectDeviceAsync=Oo;At.detectDevice=Ao;const Mo=nd,nh=te,ah=Ae,Rt=ae,qa=re,mt=W,oh=Br,ch=Ls,dh=Is,ph=Ms,lh=Os,hh=As,uh=Ns,fh=js,mh=$s,gh=Fs,_h=Bs,wh=zs,vh=Hs,ce=new nh.Logger("Device");async function Oo(r){ce.debug("detectDeviceAsync() [userAgent:%s]",r),!r&&typeof navigator=="object"&&(r=navigator.userAgent);const s=await(0,Mo.UAParser)(r).withFeatureCheck();return No(s)}function Ao(r){ce.debug("detectDevice() [userAgent:%s]",r),!r&&typeof navigator=="object"&&(r=navigator.userAgent);const s=(0,Mo.UAParser)(r);return No(s)}class un{constructor({handlerName:s,handlerFactory:e}={}){f(this,"_handlerFactory");f(this,"_handlerName");f(this,"_loaded",!1);f(this,"_extendedRtpCapabilities");f(this,"_recvRtpCapabilities");f(this,"_canProduceByKind");f(this,"_sctpCapabilities");f(this,"_observer",new ah.EnhancedEventEmitter);if(ce.debug("constructor()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(e)this._handlerFactory=e;else{if(s)ce.debug("constructor() | handler given: %s",s);else if(s=Ao(),s)ce.debug("constructor() | detected handler: %s",s);else throw new Rt.UnsupportedError("device not supported");switch(s){case"Chrome111":{this._handlerFactory=ch.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=dh.Chrome74.createFactory();break}case"Chrome70":{this._handlerFactory=ph.Chrome70.createFactory();break}case"Chrome67":{this._handlerFactory=lh.Chrome67.createFactory();break}case"Chrome55":{this._handlerFactory=hh.Chrome55.createFactory();break}case"Firefox120":{this._handlerFactory=uh.Firefox120.createFactory();break}case"Firefox60":{this._handlerFactory=fh.Firefox60.createFactory();break}case"Safari12":{this._handlerFactory=mh.Safari12.createFactory();break}case"Safari11":{this._handlerFactory=gh.Safari11.createFactory();break}case"Edge11":{this._handlerFactory=_h.Edge11.createFactory();break}case"ReactNativeUnifiedPlan":{this._handlerFactory=wh.ReactNativeUnifiedPlan.createFactory();break}case"ReactNative":{this._handlerFactory=vh.ReactNative.createFactory();break}default:throw new TypeError(`unknown handlerName "${s}"`)}}const t=this._handlerFactory();this._handlerName=t.name,t.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}static async factory({handlerName:s,handlerFactory:e}={}){if(ce.debug("factory()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(!s&&!e&&(s=await Oo(),!s))throw new Rt.UnsupportedError("device not supported");return new un({handlerName:s,handlerFactory:e})}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new Rt.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new Rt.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:s,preferLocalCodecsOrder:e=!1}){ce.debug("load() [routerRtpCapabilities:%o]",s);let t;try{if(this._loaded)throw new Rt.InvalidStateError("already loaded");const i=qa.clone(s);mt.validateRtpCapabilities(i),t=this._handlerFactory();const n=await t.getNativeRtpCapabilities();ce.debug("load() | got native RTP capabilities:%o",n);const a=qa.clone(n);mt.validateRtpCapabilities(a),this._extendedRtpCapabilities=mt.getExtendedRtpCapabilities(a,i,e),ce.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=mt.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=mt.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=mt.getRecvRtpCapabilities(this._extendedRtpCapabilities),mt.validateRtpCapabilities(this._recvRtpCapabilities),ce.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),ce.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),mt.validateSctpCapabilities(this._sctpCapabilities),ce.debug("load() succeeded"),this._loaded=!0,t.close()}catch(i){throw t&&t.close(),i}}canProduce(s){if(this._loaded){if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind "${s}"`)}else throw new Rt.InvalidStateError("not loaded");return this._canProduceByKind[s]}createSendTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:l}){return ce.debug("createSendTransport()"),this.createTransport({direction:"send",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:l})}createRecvTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:l}){return ce.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:p,appData:l})}createTransport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,appData:c}){if(this._loaded){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new Rt.InvalidStateError("not loaded");const h=new oh.Transport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:p,proprietaryConstraints:l,appData:c,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}}At.Device=un;function No(r){var s,e,t,i;if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(ce.debug("detectDeviceImpl() | React-Native detected"),typeof RTCPeerConnection>"u"){ce.warn("detectDeviceImpl() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver<"u"?(ce.debug("detectDeviceImpl() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(ce.debug("detectDeviceImpl() | ReactNative PlanB handler chosen"),"ReactNative")}else{ce.debug("detectDeviceImpl() | browser detected [userAgent:%s, parsed:%o]",r.ua,r);const n=r.browser,a=(s=n.name)==null?void 0:s.toLowerCase(),o=parseInt(n.major??"0"),p=(e=r.engine.name)==null?void 0:e.toLowerCase(),l=r.os,c=(t=l.name)==null?void 0:t.toLowerCase(),h=parseFloat(l.version??"0"),m=(i=r.device.model)==null?void 0:i.toLowerCase(),_=c==="ios"||m==="ipad",w=a&&["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(a),S=a&&["firefox","mobile firefox","mobile focus"].includes(a),x=a&&["safari","mobile safari"].includes(a),v=a&&["edge"].includes(a);if((w||v)&&!_&&o>=111)return"Chrome111";if(w&&!_&&o>=74||v&&!_&&o>=88)return"Chrome74";if(w&&!_&&o>=70)return"Chrome70";if(w&&!_&&o>=67)return"Chrome67";if(w&&!_&&o>=55)return"Chrome55";if(S&&!_&&o>=120)return"Firefox120";if(S&&!_&&o>=60)return"Firefox60";if(S&&_&&h>=14.3)return"Safari12";if(x&&o>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(x&&o>=11)return"Safari11";if(v&&!_&&o>=11&&o<=18)return"Edge11";if(p==="webkit"&&_&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(p==="blink"){const g=r.ua.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(g){const b=Number(g[1]);return b>=111?"Chrome111":b>=74?"Chrome74":b>=70?"Chrome70":b>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else{ce.warn("detectDeviceImpl() | browser not supported [name:%s, version:%s]",a,o);return}}}var jo={};Object.defineProperty(jo,"__esModule",{value:!0});var $o={};Object.defineProperty($o,"__esModule",{value:!0});(function(r){var s=Ct&&Ct.__createBinding||(Object.create?function(t,i,n,a){a===void 0&&(a=n);var o=Object.getOwnPropertyDescriptor(i,n);(!o||("get"in o?!i.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(t,a,o)}:function(t,i,n,a){a===void 0&&(a=n),t[a]=i[n]}),e=Ct&&Ct.__exportStar||function(t,i){for(var n in t)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&s(i,t,n)};Object.defineProperty(r,"__esModule",{value:!0}),e(At,r),e(Br,r),e(Ur,r),e(zr,r),e(Hr,r),e(qr,r),e(jo,r),e($o,r),e(me,r),e(ae,r)})(mo);var qs={},Vs={},Fo={},fn={};Object.defineProperty(fn,"__esModule",{value:!0});fn.default="ffffffff-ffff-ffff-ffff-ffffffffffff";var mn={};Object.defineProperty(mn,"__esModule",{value:!0});mn.default="00000000-0000-0000-0000-000000000000";var wr={},vr={},gn={};Object.defineProperty(gn,"__esModule",{value:!0});gn.default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;Object.defineProperty(vr,"__esModule",{value:!0});const yh=gn;function bh(r){return typeof r=="string"&&yh.default.test(r)}vr.default=bh;Object.defineProperty(wr,"__esModule",{value:!0});const Sh=vr;function Rh(r){if(!(0,Sh.default)(r))throw TypeError("Invalid UUID");let s;return Uint8Array.of((s=parseInt(r.slice(0,8),16))>>>24,s>>>16&255,s>>>8&255,s&255,(s=parseInt(r.slice(9,13),16))>>>8,s&255,(s=parseInt(r.slice(14,18),16))>>>8,s&255,(s=parseInt(r.slice(19,23),16))>>>8,s&255,(s=parseInt(r.slice(24,36),16))/1099511627776&255,s/4294967296&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255)}wr.default=Rh;var xe={};Object.defineProperty(xe,"__esModule",{value:!0});xe.unsafeStringify=void 0;const Ch=vr,ue=[];for(let r=0;r<256;++r)ue.push((r+256).toString(16).slice(1));function Bo(r,s=0){return(ue[r[s+0]]+ue[r[s+1]]+ue[r[s+2]]+ue[r[s+3]]+"-"+ue[r[s+4]]+ue[r[s+5]]+"-"+ue[r[s+6]]+ue[r[s+7]]+"-"+ue[r[s+8]]+ue[r[s+9]]+"-"+ue[r[s+10]]+ue[r[s+11]]+ue[r[s+12]]+ue[r[s+13]]+ue[r[s+14]]+ue[r[s+15]]).toLowerCase()}xe.unsafeStringify=Bo;function Th(r,s=0){const e=Bo(r,s);if(!(0,Ch.default)(e))throw TypeError("Stringified UUID is invalid");return e}xe.default=Th;var yr={},Vr={};Object.defineProperty(Vr,"__esModule",{value:!0});let ki;const Dh=new Uint8Array(16);function kh(){if(!ki){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ki=crypto.getRandomValues.bind(crypto)}return ki(Dh)}Vr.default=kh;Object.defineProperty(yr,"__esModule",{value:!0});yr.updateV1State=void 0;const Va=Vr,Eh=xe,jr={};function Ph(r,s,e){var n;let t;const i=(r==null?void 0:r._v6)??!1;if(r){const a=Object.keys(r);a.length===1&&a[0]==="_v6"&&(r=void 0)}if(r)t=Ka(r.random??((n=r.rng)==null?void 0:n.call(r))??(0,Va.default)(),r.msecs,r.nsecs,r.clockseq,r.node,s,e);else{const a=Date.now(),o=(0,Va.default)();Uo(jr,a,o),t=Ka(o,jr.msecs,jr.nsecs,i?void 0:jr.clockseq,i?void 0:jr.node,s,e)}return s??(0,Eh.unsafeStringify)(t)}function Uo(r,s,e){return r.msecs??(r.msecs=-1/0),r.nsecs??(r.nsecs=0),s===r.msecs?(r.nsecs++,r.nsecs>=1e4&&(r.node=void 0,r.nsecs=0)):s>r.msecs?r.nsecs=0:s<r.msecs&&(r.node=void 0),r.node||(r.node=e.slice(10,16),r.node[0]|=1,r.clockseq=(e[8]<<8|e[9])&16383),r.msecs=s,r}yr.updateV1State=Uo;function Ka(r,s,e,t,i,n,a=0){if(r.length<16)throw new Error("Random bytes length must be >= 16");if(!n)n=new Uint8Array(16),a=0;else if(a<0||a+16>n.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);s??(s=Date.now()),e??(e=0),t??(t=(r[8]<<8|r[9])&16383),i??(i=r.slice(10,16)),s+=122192928e5;const o=((s&268435455)*1e4+e)%4294967296;n[a++]=o>>>24&255,n[a++]=o>>>16&255,n[a++]=o>>>8&255,n[a++]=o&255;const d=s/4294967296*1e4&268435455;n[a++]=d>>>8&255,n[a++]=d&255,n[a++]=d>>>24&15|16,n[a++]=d>>>16&255,n[a++]=t>>>8|128,n[a++]=t&255;for(let p=0;p<6;++p)n[a++]=i[p];return n}yr.default=Ph;var Ks={};Object.defineProperty(Ks,"__esModule",{value:!0});const xh=wr,Lh=xe;function Ih(r){const s=typeof r=="string"?(0,xh.default)(r):r,e=Mh(s);return typeof r=="string"?(0,Lh.unsafeStringify)(e):e}Ks.default=Ih;function Mh(r){return Uint8Array.of((r[6]&15)<<4|r[7]>>4&15,(r[7]&15)<<4|(r[4]&240)>>4,(r[4]&15)<<4|(r[5]&240)>>4,(r[5]&15)<<4|(r[0]&240)>>4,(r[0]&15)<<4|(r[1]&240)>>4,(r[1]&15)<<4|(r[2]&240)>>4,96|r[2]&15,r[3],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}var zo={},_n={};Object.defineProperty(_n,"__esModule",{value:!0});function Oh(r){const s=jh(r),e=Nh(s,r.length*8);return Ah(e)}function Ah(r){const s=new Uint8Array(r.length*4);for(let e=0;e<r.length*4;e++)s[e]=r[e>>2]>>>e%4*8&255;return s}function Ho(r){return(r+64>>>9<<4)+14+1}function Nh(r,s){const e=new Uint32Array(Ho(s)).fill(0);e.set(r),e[s>>5]|=128<<s%32,e[e.length-1]=s,r=e;let t=1732584193,i=-271733879,n=-1732584194,a=271733878;for(let o=0;o<r.length;o+=16){const d=t,p=i,l=n,c=a;t=ge(t,i,n,a,r[o],7,-680876936),a=ge(a,t,i,n,r[o+1],12,-389564586),n=ge(n,a,t,i,r[o+2],17,606105819),i=ge(i,n,a,t,r[o+3],22,-1044525330),t=ge(t,i,n,a,r[o+4],7,-176418897),a=ge(a,t,i,n,r[o+5],12,1200080426),n=ge(n,a,t,i,r[o+6],17,-1473231341),i=ge(i,n,a,t,r[o+7],22,-45705983),t=ge(t,i,n,a,r[o+8],7,1770035416),a=ge(a,t,i,n,r[o+9],12,-1958414417),n=ge(n,a,t,i,r[o+10],17,-42063),i=ge(i,n,a,t,r[o+11],22,-1990404162),t=ge(t,i,n,a,r[o+12],7,1804603682),a=ge(a,t,i,n,r[o+13],12,-40341101),n=ge(n,a,t,i,r[o+14],17,-1502002290),i=ge(i,n,a,t,r[o+15],22,1236535329),t=_e(t,i,n,a,r[o+1],5,-165796510),a=_e(a,t,i,n,r[o+6],9,-1069501632),n=_e(n,a,t,i,r[o+11],14,643717713),i=_e(i,n,a,t,r[o],20,-373897302),t=_e(t,i,n,a,r[o+5],5,-701558691),a=_e(a,t,i,n,r[o+10],9,38016083),n=_e(n,a,t,i,r[o+15],14,-660478335),i=_e(i,n,a,t,r[o+4],20,-405537848),t=_e(t,i,n,a,r[o+9],5,568446438),a=_e(a,t,i,n,r[o+14],9,-1019803690),n=_e(n,a,t,i,r[o+3],14,-187363961),i=_e(i,n,a,t,r[o+8],20,1163531501),t=_e(t,i,n,a,r[o+13],5,-1444681467),a=_e(a,t,i,n,r[o+2],9,-51403784),n=_e(n,a,t,i,r[o+7],14,1735328473),i=_e(i,n,a,t,r[o+12],20,-1926607734),t=we(t,i,n,a,r[o+5],4,-378558),a=we(a,t,i,n,r[o+8],11,-2022574463),n=we(n,a,t,i,r[o+11],16,1839030562),i=we(i,n,a,t,r[o+14],23,-35309556),t=we(t,i,n,a,r[o+1],4,-1530992060),a=we(a,t,i,n,r[o+4],11,1272893353),n=we(n,a,t,i,r[o+7],16,-155497632),i=we(i,n,a,t,r[o+10],23,-1094730640),t=we(t,i,n,a,r[o+13],4,681279174),a=we(a,t,i,n,r[o],11,-358537222),n=we(n,a,t,i,r[o+3],16,-722521979),i=we(i,n,a,t,r[o+6],23,76029189),t=we(t,i,n,a,r[o+9],4,-640364487),a=we(a,t,i,n,r[o+12],11,-421815835),n=we(n,a,t,i,r[o+15],16,530742520),i=we(i,n,a,t,r[o+2],23,-995338651),t=ve(t,i,n,a,r[o],6,-198630844),a=ve(a,t,i,n,r[o+7],10,1126891415),n=ve(n,a,t,i,r[o+14],15,-1416354905),i=ve(i,n,a,t,r[o+5],21,-57434055),t=ve(t,i,n,a,r[o+12],6,1700485571),a=ve(a,t,i,n,r[o+3],10,-1894986606),n=ve(n,a,t,i,r[o+10],15,-1051523),i=ve(i,n,a,t,r[o+1],21,-2054922799),t=ve(t,i,n,a,r[o+8],6,1873313359),a=ve(a,t,i,n,r[o+15],10,-30611744),n=ve(n,a,t,i,r[o+6],15,-1560198380),i=ve(i,n,a,t,r[o+13],21,1309151649),t=ve(t,i,n,a,r[o+4],6,-145523070),a=ve(a,t,i,n,r[o+11],10,-1120210379),n=ve(n,a,t,i,r[o+2],15,718787259),i=ve(i,n,a,t,r[o+9],21,-343485551),t=_t(t,d),i=_t(i,p),n=_t(n,l),a=_t(a,c)}return Uint32Array.of(t,i,n,a)}function jh(r){if(r.length===0)return new Uint32Array;const s=new Uint32Array(Ho(r.length*8)).fill(0);for(let e=0;e<r.length;e++)s[e>>2]|=(r[e]&255)<<e%4*8;return s}function _t(r,s){const e=(r&65535)+(s&65535);return(r>>16)+(s>>16)+(e>>16)<<16|e&65535}function $h(r,s){return r<<s|r>>>32-s}function Gs(r,s,e,t,i,n){return _t($h(_t(_t(s,r),_t(t,n)),i),e)}function ge(r,s,e,t,i,n,a){return Gs(s&e|~s&t,r,s,i,n,a)}function _e(r,s,e,t,i,n,a){return Gs(s&t|e&~t,r,s,i,n,a)}function we(r,s,e,t,i,n,a){return Gs(s^e^t,r,s,i,n,a)}function ve(r,s,e,t,i,n,a){return Gs(e^(s|~t),r,s,i,n,a)}_n.default=Oh;var Pe={};Object.defineProperty(Pe,"__esModule",{value:!0});Pe.URL=Pe.DNS=Pe.stringToBytes=void 0;const Ga=wr,Fh=xe;function qo(r){r=unescape(encodeURIComponent(r));const s=new Uint8Array(r.length);for(let e=0;e<r.length;++e)s[e]=r.charCodeAt(e);return s}Pe.stringToBytes=qo;Pe.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8";Pe.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Bh(r,s,e,t,i,n){const a=typeof e=="string"?qo(e):e,o=typeof t=="string"?(0,Ga.default)(t):t;if(typeof t=="string"&&(t=(0,Ga.default)(t)),(t==null?void 0:t.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let d=new Uint8Array(16+a.length);if(d.set(o),d.set(a,o.length),d=s(d),d[6]=d[6]&15|r,d[8]=d[8]&63|128,i){n=n||0;for(let p=0;p<16;++p)i[n+p]=d[p];return i}return(0,Fh.unsafeStringify)(d)}Pe.default=Bh;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.URL=r.DNS=void 0;const s=_n,e=Pe;var t=Pe;Object.defineProperty(r,"DNS",{enumerable:!0,get:function(){return t.DNS}}),Object.defineProperty(r,"URL",{enumerable:!0,get:function(){return t.URL}});function i(n,a,o,d){return(0,e.default)(48,s.default,n,a,o,d)}i.DNS=e.DNS,i.URL=e.URL,r.default=i})(zo);var wn={},vn={};Object.defineProperty(vn,"__esModule",{value:!0});const Uh=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);vn.default={randomUUID:Uh};Object.defineProperty(wn,"__esModule",{value:!0});const Qa=vn,zh=Vr,Hh=xe;function qh(r,s,e){var i;if(Qa.default.randomUUID&&!s&&!r)return Qa.default.randomUUID();r=r||{};const t=r.random??((i=r.rng)==null?void 0:i.call(r))??(0,zh.default)();if(t.length<16)throw new Error("Random bytes length must be >= 16");if(t[6]=t[6]&15|64,t[8]=t[8]&63|128,s){if(e=e||0,e<0||e+16>s.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let n=0;n<16;++n)s[e+n]=t[n];return s}return(0,Hh.unsafeStringify)(t)}wn.default=qh;var Vo={},yn={};Object.defineProperty(yn,"__esModule",{value:!0});function Vh(r,s,e,t){switch(r){case 0:return s&e^~s&t;case 1:return s^e^t;case 2:return s&e^s&t^e&t;case 3:return s^e^t}}function Ei(r,s){return r<<s|r>>>32-s}function Kh(r){const s=[1518500249,1859775393,2400959708,3395469782],e=[1732584193,4023233417,2562383102,271733878,3285377520],t=new Uint8Array(r.length+1);t.set(r),t[r.length]=128,r=t;const i=r.length/4+2,n=Math.ceil(i/16),a=new Array(n);for(let o=0;o<n;++o){const d=new Uint32Array(16);for(let p=0;p<16;++p)d[p]=r[o*64+p*4]<<24|r[o*64+p*4+1]<<16|r[o*64+p*4+2]<<8|r[o*64+p*4+3];a[o]=d}a[n-1][14]=(r.length-1)*8/Math.pow(2,32),a[n-1][14]=Math.floor(a[n-1][14]),a[n-1][15]=(r.length-1)*8&4294967295;for(let o=0;o<n;++o){const d=new Uint32Array(80);for(let m=0;m<16;++m)d[m]=a[o][m];for(let m=16;m<80;++m)d[m]=Ei(d[m-3]^d[m-8]^d[m-14]^d[m-16],1);let p=e[0],l=e[1],c=e[2],h=e[3],u=e[4];for(let m=0;m<80;++m){const _=Math.floor(m/20),w=Ei(p,5)+Vh(_,l,c,h)+u+s[_]+d[m]>>>0;u=h,h=c,c=Ei(l,30)>>>0,l=p,p=w}e[0]=e[0]+p>>>0,e[1]=e[1]+l>>>0,e[2]=e[2]+c>>>0,e[3]=e[3]+h>>>0,e[4]=e[4]+u>>>0}return Uint8Array.of(e[0]>>24,e[0]>>16,e[0]>>8,e[0],e[1]>>24,e[1]>>16,e[1]>>8,e[1],e[2]>>24,e[2]>>16,e[2]>>8,e[2],e[3]>>24,e[3]>>16,e[3]>>8,e[3],e[4]>>24,e[4]>>16,e[4]>>8,e[4])}yn.default=Kh;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.URL=r.DNS=void 0;const s=yn,e=Pe;var t=Pe;Object.defineProperty(r,"DNS",{enumerable:!0,get:function(){return t.DNS}}),Object.defineProperty(r,"URL",{enumerable:!0,get:function(){return t.URL}});function i(n,a,o,d){return(0,e.default)(80,s.default,n,a,o,d)}i.DNS=e.DNS,i.URL=e.URL,r.default=i})(Vo);var bn={};Object.defineProperty(bn,"__esModule",{value:!0});const Gh=xe,Qh=yr,Wh=Ks;function Yh(r,s,e){r??(r={}),e??(e=0);let t=(0,Qh.default)({...r,_v6:!0},new Uint8Array(16));if(t=(0,Wh.default)(t),s){for(let i=0;i<16;i++)s[e+i]=t[i];return s}return(0,Gh.unsafeStringify)(t)}bn.default=Yh;var Sn={};Object.defineProperty(Sn,"__esModule",{value:!0});const Xh=wr,Jh=xe;function Zh(r){const s=typeof r=="string"?(0,Xh.default)(r):r,e=eu(s);return typeof r=="string"?(0,Jh.unsafeStringify)(e):e}Sn.default=Zh;function eu(r){return Uint8Array.of((r[3]&15)<<4|r[4]>>4&15,(r[4]&15)<<4|(r[5]&240)>>4,(r[5]&15)<<4|r[6]&15,r[7],(r[1]&15)<<4|(r[2]&240)>>4,(r[2]&15)<<4|(r[3]&240)>>4,16|(r[0]&240)>>4,(r[0]&15)<<4|(r[1]&240)>>4,r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}var Kr={};Object.defineProperty(Kr,"__esModule",{value:!0});Kr.updateV7State=void 0;const Wa=Vr,tu=xe,Pi={};function ru(r,s,e){var i;let t;if(r)t=Ya(r.random??((i=r.rng)==null?void 0:i.call(r))??(0,Wa.default)(),r.msecs,r.seq,s,e);else{const n=Date.now(),a=(0,Wa.default)();Ko(Pi,n,a),t=Ya(a,Pi.msecs,Pi.seq,s,e)}return s??(0,tu.unsafeStringify)(t)}function Ko(r,s,e){return r.msecs??(r.msecs=-1/0),r.seq??(r.seq=0),s>r.msecs?(r.seq=e[6]<<23|e[7]<<16|e[8]<<8|e[9],r.msecs=s):(r.seq=r.seq+1|0,r.seq===0&&r.msecs++),r}Kr.updateV7State=Ko;function Ya(r,s,e,t,i=0){if(r.length<16)throw new Error("Random bytes length must be >= 16");if(!t)t=new Uint8Array(16),i=0;else if(i<0||i+16>t.length)throw new RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);return s??(s=Date.now()),e??(e=r[6]*127<<24|r[7]<<16|r[8]<<8|r[9]),t[i++]=s/1099511627776&255,t[i++]=s/4294967296&255,t[i++]=s/16777216&255,t[i++]=s/65536&255,t[i++]=s/256&255,t[i++]=s&255,t[i++]=112|e>>>28&15,t[i++]=e>>>20&255,t[i++]=128|e>>>14&63,t[i++]=e>>>6&255,t[i++]=e<<2&255|r[10]&3,t[i++]=r[11],t[i++]=r[12],t[i++]=r[13],t[i++]=r[14],t[i++]=r[15],t}Kr.default=ru;var Rn={};Object.defineProperty(Rn,"__esModule",{value:!0});const su=vr;function iu(r){if(!(0,su.default)(r))throw TypeError("Invalid UUID");return parseInt(r.slice(14,15),16)}Rn.default=iu;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.version=r.validate=r.v7=r.v6ToV1=r.v6=r.v5=r.v4=r.v3=r.v1ToV6=r.v1=r.stringify=r.parse=r.NIL=r.MAX=void 0;var s=fn;Object.defineProperty(r,"MAX",{enumerable:!0,get:function(){return s.default}});var e=mn;Object.defineProperty(r,"NIL",{enumerable:!0,get:function(){return e.default}});var t=wr;Object.defineProperty(r,"parse",{enumerable:!0,get:function(){return t.default}});var i=xe;Object.defineProperty(r,"stringify",{enumerable:!0,get:function(){return i.default}});var n=yr;Object.defineProperty(r,"v1",{enumerable:!0,get:function(){return n.default}});var a=Ks;Object.defineProperty(r,"v1ToV6",{enumerable:!0,get:function(){return a.default}});var o=zo;Object.defineProperty(r,"v3",{enumerable:!0,get:function(){return o.default}});var d=wn;Object.defineProperty(r,"v4",{enumerable:!0,get:function(){return d.default}});var p=Vo;Object.defineProperty(r,"v5",{enumerable:!0,get:function(){return p.default}});var l=bn;Object.defineProperty(r,"v6",{enumerable:!0,get:function(){return l.default}});var c=Sn;Object.defineProperty(r,"v6ToV1",{enumerable:!0,get:function(){return c.default}});var h=Kr;Object.defineProperty(r,"v7",{enumerable:!0,get:function(){return h.default}});var u=vr;Object.defineProperty(r,"validate",{enumerable:!0,get:function(){return u.default}});var m=Rn;Object.defineProperty(r,"version",{enumerable:!0,get:function(){return m.default}})})(Fo);var Qs={};Object.defineProperty(Qs,"__esModule",{value:!0});Qs.FakeEventTarget=void 0;class nu{constructor(){f(this,"listeners",{})}addEventListener(s,e,t={}){var i;e&&((i=this.listeners)[s]??(i[s]=[]),this.listeners[s].push({callback:e,once:t.once===!0}))}removeEventListener(s,e){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(t=>t.callback!==e))}dispatchEvent(s){if(!s||typeof s.type!="string")throw new Error("invalid event object");const e=this.listeners[s.type];if(!e)return!0;for(const t of[...e]){try{t.callback.call(this,s)}catch(i){setTimeout(()=>{throw i},0)}t.once&&this.removeEventListener(s.type,t.callback)}return!s.defaultPrevented}}Qs.FakeEventTarget=nu;var Cn={};Object.defineProperty(Cn,"__esModule",{value:!0});Cn.clone=au;function au(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}Object.defineProperty(Vs,"__esModule",{value:!0});Vs.FakeMediaStreamTrack=void 0;const Xa=Fo,ou=Qs,_s=Cn;var Fr,lr,hr,Qe,gt,We,Tt,ur,Dt,fr,kt,Et,Pt,xt,Lt,It;const Dn=class Dn extends ou.FakeEventTarget{constructor({kind:e,id:t,label:i,contentHint:n,enabled:a,muted:o,readyState:d,capabilities:p,constraints:l,settings:c,data:h}){super();he(this,Fr,void 0);he(this,lr,void 0);he(this,hr,void 0);he(this,Qe,void 0);he(this,gt,void 0);he(this,We,void 0);he(this,Tt,void 0);he(this,ur,void 0);he(this,Dt,void 0);he(this,fr,void 0);he(this,kt,void 0);he(this,Et,null);he(this,Pt,null);he(this,xt,null);he(this,Lt,null);he(this,It,null);ee(this,Fr,t??(0,Xa.v4)()),ee(this,lr,e),ee(this,hr,i??""),ee(this,Tt,n??""),ee(this,gt,a??!0),ee(this,We,o??!1),ee(this,Qe,d??"live"),ee(this,ur,p??{}),ee(this,Dt,l??{}),ee(this,fr,c??{}),ee(this,kt,h??{})}get id(){return $(this,Fr)}get kind(){return $(this,lr)}get label(){return $(this,hr)}get contentHint(){return $(this,Tt)}set contentHint(e){ee(this,Tt,e)}get enabled(){return $(this,gt)}set enabled(e){const t=$(this,gt)!==e;ee(this,gt,e),t&&this.dispatchEvent(new Event("enabledchange"))}get muted(){return $(this,We)}get readyState(){return $(this,Qe)}get data(){return $(this,kt)}set data(e){ee(this,kt,e)}get onmute(){return $(this,Et)}set onmute(e){$(this,Et)&&this.removeEventListener("mute",$(this,Et)),ee(this,Et,e),e&&this.addEventListener("mute",e)}get onunmute(){return $(this,Pt)}set onunmute(e){$(this,Pt)&&this.removeEventListener("unmute",$(this,Pt)),ee(this,Pt,e),e&&this.addEventListener("unmute",e)}get onended(){return $(this,xt)}set onended(e){$(this,xt)&&this.removeEventListener("ended",$(this,xt)),ee(this,xt,e),e&&this.addEventListener("ended",e)}get onenabledchange(){return $(this,Lt)}set onenabledchange(e){$(this,Lt)&&this.removeEventListener("enabledchange",$(this,Lt)),ee(this,Lt,e),e&&this.addEventListener("enabledchange",e)}get onstopped(){return $(this,It)}set onstopped(e){$(this,It)&&this.removeEventListener("stopped",$(this,It)),ee(this,It,e),e&&this.addEventListener("stopped",e)}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t){super.removeEventListener(e,t)}stop(){$(this,Qe)!=="ended"&&(ee(this,Qe,"ended"),this.dispatchEvent(new Event("stopped")))}clone({id:e,data:t}={}){return new Dn({id:e??(0,Xa.v4)(),kind:$(this,lr),label:$(this,hr),contentHint:$(this,Tt),enabled:$(this,gt),muted:$(this,We),readyState:$(this,Qe),capabilities:(0,_s.clone)($(this,ur)),constraints:(0,_s.clone)($(this,Dt)),settings:(0,_s.clone)($(this,fr)),data:t??(0,_s.clone)($(this,kt))})}getCapabilities(){return $(this,ur)}getConstraints(){return $(this,Dt)}async applyConstraints(e={}){return ee(this,Dt,e),Promise.resolve()}getSettings(){return $(this,fr)}remoteStop(){$(this,Qe)!=="ended"&&(ee(this,Qe,"ended"),this.dispatchEvent(new Event("stopped")),this.dispatchEvent(new Event("ended")))}remoteMute(){$(this,We)||(ee(this,We,!0),this.dispatchEvent(new Event("mute")))}remoteUnmute(){$(this,We)&&(ee(this,We,!1),this.dispatchEvent(new Event("unmute")))}};Fr=new WeakMap,lr=new WeakMap,hr=new WeakMap,Qe=new WeakMap,gt=new WeakMap,We=new WeakMap,Tt=new WeakMap,ur=new WeakMap,Dt=new WeakMap,fr=new WeakMap,kt=new WeakMap,Et=new WeakMap,Pt=new WeakMap,xt=new WeakMap,Lt=new WeakMap,It=new WeakMap;let Bi=Dn;Vs.FakeMediaStreamTrack=Bi;Object.defineProperty(qs,"__esModule",{value:!0});qs.FakeHandler=void 0;const cu=Vs,du=Ae,pu=te,cr=re,Ja=W,lu=ae,hu=me,ye=new pu.Logger("FakeHandler"),uu="FakeHandler";class Za extends du.EnhancedEventEmitter{constructor({id:e,ordered:t,maxPacketLifeTime:i,maxRetransmits:n,label:a,protocol:o}){super();f(this,"id");f(this,"ordered");f(this,"maxPacketLifeTime");f(this,"maxRetransmits");f(this,"label");f(this,"protocol");this.id=e,this.ordered=t,this.maxPacketLifeTime=i,this.maxRetransmits=n,this.label=a,this.protocol=o}close(){this.safeEmit("close"),this.emit("@close")}send(e){this.safeEmit("message",e)}addEventListener(e,t){this.on(e,t)}}class Tn extends hu.HandlerInterface{constructor(e){super();f(this,"_closed",!1);f(this,"fakeParameters");f(this,"_rtpParametersByKind");f(this,"_cname",`CNAME-${cr.generateRandomNumber()}`);f(this,"_transportReady",!1);f(this,"_nextLocalId",1);f(this,"_tracks",new Map);f(this,"_nextSctpStreamId",0);this.fakeParameters=e}static createFactory(e){return()=>new Tn(e)}get name(){return uu}close(){ye.debug("close()"),!this._closed&&(this._closed=!0)}setIceGatheringState(e){this.emit("@icegatheringstatechange",e)}setConnectionState(e){this.emit("@connectionstatechange",e)}async getNativeRtpCapabilities(){return ye.debug("getNativeRtpCapabilities()"),this.fakeParameters.generateNativeRtpCapabilities()}async getNativeSctpCapabilities(){return ye.debug("getNativeSctpCapabilities()"),this.fakeParameters.generateNativeSctpCapabilities()}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,proprietaryConstraints:p,extendedRtpCapabilities:l}){this.assertNotClosed(),ye.debug("run()"),this._rtpParametersByKind={audio:Ja.getSendingRtpParameters("audio",l),video:Ja.getSendingRtpParameters("video",l)}}async updateIceServers(e){this.assertNotClosed(),ye.debug("updateIceServers()")}async restartIce(e){this.assertNotClosed(),ye.debug("restartIce()")}async getTransportStats(){return this.assertNotClosed(),new Map}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertNotClosed(),ye.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"});const a=cr.clone(this._rtpParametersByKind[e.kind]),o=a.codecs.some(p=>/.+\/rtx$/i.test(p.mimeType));a.mid=`mid-${cr.generateRandomNumber()}`,t||(t=[{}]);for(const p of t)p.ssrc=cr.generateRandomNumber(),o&&(p.rtx={ssrc:cr.generateRandomNumber()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const d=this._nextLocalId++;return this._tracks.set(d,e),{localId:String(d),rtpParameters:a}}async stopSending(e){if(ye.debug("stopSending() [localId:%s]",e),!this._closed){if(!this._tracks.has(Number(e)))throw new Error("local track not found");this._tracks.delete(Number(e))}}async pauseSending(e){this.assertNotClosed()}async resumeSending(e){this.assertNotClosed()}async replaceTrack(e,t){this.assertNotClosed(),t?ye.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):ye.debug("replaceTrack() [localId:%s, no track]",e),this._tracks.delete(Number(e)),this._tracks.set(Number(e),t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),ye.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),ye.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t)}async getSenderStats(e){return this.assertNotClosed(),new Map}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}){this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),ye.debug("sendDataChannel()");const o=new Za({id:this._nextSctpStreamId++,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:a}),d={streamId:this._nextSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i};return{dataChannel:o,sctpStreamParameters:d}}async receive(e){this.assertNotClosed();const t=[];for(const i of e){const{trackId:n,kind:a}=i;this._transportReady||await this.setupTransport({localDtlsRole:"client"}),ye.debug("receive() [trackId:%s, kind:%s]",n,a);const o=this._nextLocalId++,d=new cu.FakeMediaStreamTrack({kind:a});this._tracks.set(o,d),t.push({localId:String(o),track:d})}return t}async stopReceiving(e){if(!this._closed)for(const t of e)ye.debug("stopReceiving() [localId:%s]",t),this._tracks.delete(Number(t))}async pauseReceiving(e){this.assertNotClosed()}async resumeReceiving(e){this.assertNotClosed()}async getReceiverStats(e){return this.assertNotClosed(),new Map}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){return this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"client"}),ye.debug("receiveDataChannel()"),{dataChannel:new Za({id:e.streamId,ordered:e.ordered,maxPacketLifeTime:e.maxPacketLifeTime,maxRetransmits:e.maxRetransmits,label:t,protocol:i})}}async setupTransport({localDtlsRole:e,localSdpObject:t}){const i=cr.clone(this.fakeParameters.generateLocalDtlsParameters());e&&(i.role=e),this.emit("@connectionstatechange","connecting"),await new Promise((n,a)=>this.emit("@connect",{dtlsParameters:i},n,a)),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new lu.InvalidStateError("method called in a closed handler")}}qs.FakeHandler=Tn;var Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});Ne.generateRouterRtpCapabilities=fu;Ne.generateNativeRtpCapabilities=mu;Ne.generateNativeSctpCapabilities=gu;Ne.generateLocalDtlsParameters=_u;Ne.generateTransportRemoteParameters=wu;Ne.generateProducerRemoteParameters=vu;Ne.generateConsumerRemoteParameters=yu;Ne.generateDataProducerRemoteParameters=bu;Ne.generateDataConsumerRemoteParameters=Su;const be=re;function Te(){return String(be.generateRandomNumber())}function fu(){return be.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}},{mimeType:"video/H264",kind:"video",preferredPayloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:105,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"profile-id":0,"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:106,clockRate:9e4,rtcpFeedback:[],parameters:{apt:105}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://tools.ietf.org/html/draft-ietf-avtext-framemarking-07",preferredId:6,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:framemarking",preferredId:7,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:11,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"}]})}function mu(){return be.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:111,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{minptime:10,useinbandfec:1}},{mimeType:"audio/ISAC",kind:"audio",preferredPayloadType:103,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/CN",kind:"audio",preferredPayloadType:106,clockRate:32e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:96,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:97,clockRate:9e4,rtcpFeedback:[],parameters:{apt:96}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:98,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{"profile-id":0}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:99,clockRate:9e4,rtcpFeedback:[],parameters:{apt:98}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:2},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:3},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:4},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay",preferredId:6},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type",preferredId:7},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing",preferredId:8},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10}]})}function gu(){return be.deepFreeze({numStreams:{OS:2048,MIS:2048}})}function _u(){return be.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"82:5A:68:3D:36:C3:0A:DE:AF:E7:32:43:D2:88:83:57:AC:2D:65:E5:80:C4:B6:FB:AF:1A:A0:21:9F:6D:0C:AD"}],role:"auto"})}function wu(){return{id:Te(),iceParameters:be.deepFreeze({iceLite:!0,password:"yku5ej8nvfaor28lvtrabcx0wkrpkztz",usernameFragment:"h3hk1iz6qqlnqlne"}),iceCandidates:be.deepFreeze([{foundation:"udpcandidate",address:"9.9.9.9",ip:"9.9.9.9",port:40533,priority:1078862079,protocol:"udp",type:"host",tcpType:"passive"},{foundation:"udpcandidate",address:"9.9.9.9",ip:"9:9:9:9:9:9",port:41333,priority:1078862089,protocol:"udp",type:"host",tcpType:"passive"}]),dtlsParameters:be.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"A9:F4:E0:D2:74:D3:0F:D9:CA:A5:2F:9F:7F:47:FA:F0:C4:72:DD:73:49:D0:3B:14:90:20:51:30:1B:90:8E:71"},{algorithm:"sha-384",value:"03:D9:0B:87:13:98:F6:6D:BC:FC:92:2E:39:D4:E1:97:32:61:30:56:84:70:81:6E:D1:82:97:EA:D9:C1:21:0F:6B:C5:E7:7F:E1:97:0C:17:97:6E:CF:B3:EF:2E:74:B0"},{algorithm:"sha-512",value:"84:27:A4:28:A4:73:AF:43:02:2A:44:68:FF:2F:29:5C:3B:11:9A:60:F4:A8:F0:F5:AC:A0:E3:49:3E:B1:34:53:A9:85:CE:51:9B:ED:87:5E:B8:F4:8E:3D:FA:20:51:B8:96:EE:DA:56:DC:2F:5C:62:79:15:23:E0:21:82:2B:2C"}],role:"auto"}),sctpParameters:be.deepFreeze({port:5e3,OS:2048,MIS:2048,maxMessageSize:2e6})}}function vu(){return be.deepFreeze({id:Te()})}function yu({id:r,codecMimeType:s}={}){switch(s){case"audio/opus":return{id:r??Te(),producerId:Te(),kind:"audio",rtpParameters:be.deepFreeze({codecs:[{mimeType:"audio/opus",payloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}}],encodings:[{ssrc:46687003}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",id:10}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"audio/ISAC":return{id:r??Te(),producerId:Te(),kind:"audio",rtpParameters:be.deepFreeze({codecs:[{mimeType:"audio/ISAC",payloadType:111,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}}],encodings:[{ssrc:46687004}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/VP8":return{id:r??Te(),producerId:Te(),kind:"video",rtpParameters:be.deepFreeze({codecs:[{mimeType:"video/VP8",payloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",payloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}}],encodings:[{ssrc:99991111,rtx:{ssrc:99991112}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/H264":return{id:r??Te(),producerId:Te(),kind:"video",rtpParameters:be.deepFreeze({codecs:[{mimeType:"video/H264",payloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",payloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}}],encodings:[{ssrc:99991113,rtx:{ssrc:99991114}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};default:throw new TypeError(`unknown codecMimeType '${s}'`)}}function bu(){return be.deepFreeze({id:Te()})}function Su({id:r}={}){return{id:r??Te(),dataProducerId:Te(),sctpStreamParameters:be.deepFreeze({streamId:666,maxPacketLifeTime:5e3,maxRetransmits:void 0})}}(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.debug=r.testFakeParameters=r.FakeHandler=r.ortc=r.parseScalabilityMode=r.detectDeviceAsync=r.detectDevice=r.Device=r.version=r.types=void 0;const s=Ts;r.debug=s.default,r.types=mo,r.version="3.11.0";var e=At;Object.defineProperty(r,"Device",{enumerable:!0,get:function(){return e.Device}}),Object.defineProperty(r,"detectDevice",{enumerable:!0,get:function(){return e.detectDevice}}),Object.defineProperty(r,"detectDeviceAsync",{enumerable:!0,get:function(){return e.detectDeviceAsync}});var t=Ze;Object.defineProperty(r,"parseScalabilityMode",{enumerable:!0,get:function(){return t.parse}}),r.ortc=W;var i=qs;Object.defineProperty(r,"FakeHandler",{enumerable:!0,get:function(){return i.FakeHandler}}),r.testFakeParameters=Ne})(fo);let Ru=0;const Cu=({peers:r})=>(console.log("전체 peers:",r),mr("div",{style:{display:"flex",flexWrap:"wrap",gap:8},children:Object.entries(r).map(([s,e])=>(console.log("#####################",s,e),((e==null?void 0:e.getVideoTracks())||[]).length===0?null:mr(Tu,{stream:e,muted:!0},s)))})),Tu=({stream:r,muted:s})=>{console.log(++Ru),console.log(r.getVideoTracks()),console.log(s),console.log("--------------");const e=Ge.useRef();return Ge.useEffect(()=>{const t=e.current;t&&(t.onloadedmetadata=()=>console.log("✅ metadata loaded"),t.onplaying=()=>console.log("▶️ playing"),t.onwaiting=()=>console.log("⏳ waiting"),t.onerror=i=>console.error("❌ error",i),r?(t.srcObject=r,t.play().catch(i=>console.warn("video play error:",i))):t.srcObject=null)},[r]),mr("video",{ref:e,autoPlay:!0,playsInline:!0,muted:s,width:320,height:240,style:{backgroundColor:"black"},onError:t=>console.error("Video element error:",t)})};function Du(){const[r,s]=Ge.useState({}),e=Ge.useRef(null),t=Ge.useRef(null),i=Ge.useRef(null),n=Ge.useRef({}),a=Ge.useRef(null),o=Ge.useRef(new Set);return Ge.useEffect(()=>{const d=bs("https://bidcastserver.kro.kr",{transports:["websocket"]});async function p(){try{d.emit("create-router",null,async({rtpCapabilities:c})=>{e.current=new fo.Device,await e.current.load({routerRtpCapabilities:c}),a.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),s({self:a.current}),d.emit("create-transport",{direction:"send"},h=>{t.current=e.current.createSendTransport(h),t.current.on("connect",({dtlsParameters:u},m,_)=>{d.emit("connect-transport",{dtlsParameters:u,transportId:t.current.id},w=>{w?_():m()})}),t.current.on("produce",({kind:u,rtpParameters:m},_,w)=>{d.emit("produce",{kind:u,rtpParameters:m,transportId:t.current.id},({id:S})=>{o.current.add(S),console.log("Added producer id:",S),console.log("myProducerIds size:",o.current.size),console.log("myProducerIds entries:",Array.from(o.current)),_({id:S})})}),console.log("현재 내 로컬스트림트랙"),console.log(a.current.getTracks()),a.current.getTracks().forEach(u=>{t.current.produce({track:u}).catch(m=>console.error("Produce error:",m))})}),d.emit("create-transport",{direction:"recv"},h=>{i.current=e.current.createRecvTransport(h),i.current.on("connect",({dtlsParameters:u},m,_)=>{d.emit("connect-transport",{dtlsParameters:u,transportId:i.current.id},w=>{w?_():m()})}),d.emit("get-existing-producers",u=>{u.filter(({producerId:m})=>!o.current.has(m)).forEach(({producerId:m})=>l(m))})})}),console.log("내 socket.id:",d.id),d.on("new-producer",({producerId:c,socketId:h})=>{if(console.log("new-producer received:",c,h),o.current.has(c)){console.log("내 producer라 consume 안함");return}console.log(o.current),console.log("New producer from other:",c),l(c)}),d.on("user-disconnected",({socketId:c,producerId:h})=>{console.log("User disconnected:",c,h),n.current[h]&&(n.current[h].close(),delete n.current[h]),s(u=>{const m={...u};return delete m[h],m})})}catch(c){console.error("Start error:",c)}}async function l(c){if(console.log("consume 호출 여부 체크 전:",c,n.current[c]),!e.current||!i.current||n.current[c]){console.log("consume 중복 또는 조건 미충족, return:",c);return}d.emit("consume",{producerId:c,rtpCapabilities:e.current.rtpCapabilities,transportId:i.current.id},async({id:h,kind:u,rtpParameters:m})=>{try{const _=await i.current.consume({id:h,producerId:c,kind:u,rtpParameters:m});console.log("consume 후 consumer 할당:",c,_),n.current[c]=_,console.log("consume 후 consumers.current 상태:",n.current);const w=new MediaStream;w.addTrack(_.track),w.getVideoTracks().forEach(S=>{console.log("🔍 트랙 ID:",S.id),console.log("📡 readyState:",S.readyState),console.log("🔊 enabled:",S.enabled)}),console.log("consume 호출, 추가전 peers:",r),s(S=>{console.log("setPeers 내부, 이전 peers:",S);const x={...S,[c]:w};return console.log("setPeers 내부, 새 peers:",x),x}),await _.resume(),d.emit("consumer-resume",{consumerId:_.id})}catch(_){console.error("Consume error:",_)}})}return p(),()=>{d.disconnect()}},[]),oc("div",{children:[mr("h1",{children:"Mediasoup SFU Video Chat"}),mr(Cu,{peers:r})]})}const ku=cc.createRoot(document.getElementById("root"));ku.render(mr(Du,{}));
